"""
クイックスタートガイド: 初心者向けステップバイステップガイド
"""

import streamlit as st
from pathlib import Path
import sys

# プロジェクトルートをパスに追加
project_root = Path(__file__).resolve().parent.parent.parent.parent
sys.path.insert(0, str(project_root))


def render_quick_start():
    """クイックスタートガイドのメイン表示"""

    st.markdown("""
    <div style='text-align: center; padding: 2rem 0;'>
        <h1 style='font-size: 2.5rem; margin: 0;'>🚀 クイックスタートガイド</h1>
        <p style='font-size: 1.2rem; color: #666; margin-top: 0.5rem;'>初めての方向け - ゼロから始めるKeibaAI_v2</p>
    </div>
    """, unsafe_allow_html=True)

    st.markdown("---")

    # ステップ表示
    st.markdown("## 📋 全体の流れ（5つのステップ）")

    steps_overview = """
    ```
    ステップ1: データ取得 (30分)
       ↓
    ステップ2: データ処理 (15分)
       ↓
    ステップ3: 特徴量生成 (30分)
       ↓
    ステップ4: モデル学習 (2時間)
       ↓
    ステップ5: 予測・シミュレーション (10分)
    ```
    """

    st.code(steps_overview, language="")

    st.markdown("---")

    # 各ステップの詳細
    step1_expanded = st.expander("### ステップ1: データ取得 ⏱️ 約30分", expanded=True)
    with step1_expanded:
        render_step1()

    step2_expanded = st.expander("### ステップ2: データ処理 ⏱️ 約15分")
    with step2_expanded:
        render_step2()

    step3_expanded = st.expander("### ステップ3: 特徴量生成 ⏱️ 約30分")
    with step3_expanded:
        render_step3()

    step4_expanded = st.expander("### ステップ4: モデル学習 ⏱️ 約2時間")
    with step4_expanded:
        render_step4()

    step5_expanded = st.expander("### ステップ5: 予測・シミュレーション ⏱️ 約10分")
    with step5_expanded:
        render_step5()

    st.markdown("---")

    # よくある質問
    render_faq()


def render_step1():
    """ステップ1: データ取得"""

    st.markdown("""
    #### 📊 やること: netkeiba.comから競馬データをダウンロード

    **何をダウンロードするの？**
    - レース結果（どの馬が何着だったか）
    - 出馬表（どの馬がどのレースに出るか）
    - 馬のプロフィール（生年月日、生産者など）
    - 血統データ（父馬、母馬など5世代分）

    **推奨設定（初めての方）:**
    - 開始日: 1ヶ月前
    - 終了日: 昨日
    - （例: 2024年12月1日 ～ 2024年12月31日）

    **⚠️ 注意点:**
    - 時間がかかります（1ヶ月で約30分）
    - サーバーに負荷をかけないよう、ゆっくり取得します
    - 途中でエラーが出ても、ログを確認すれば大丈夫
    """)

    st.markdown("---")

    st.markdown("#### 📝 手順")

    st.markdown("""
    1. **左サイドバーから「📊 データパイプライン」をクリック**
    2. **「データ取得（スクレイピング）」タブを開く**
    3. **開始日と終了日を設定**
       - 初めての方: まずは1週間分から試すのがおすすめ
       - 例: 2024-12-24 ～ 2024-12-31
    4. **「🚀 スクレイピング開始」ボタンをクリック**
    5. **ログで進捗を確認**
       - ✅ 成功: 「スクレイピングが正常に完了しました」
       - ❌ エラー: ログビューアで詳細を確認
    """)

    st.info("""
    💡 **ヒント:**
    - 最初は1週間分で試して、うまくいったら期間を延ばしましょう
    - スクレイピング中は他の作業ができます
    - エラーが出ても、部分的に取得できていることが多いです
    """)

    if st.button("📊 データパイプラインへ移動", key="goto_step1", type="primary"):
        st.session_state.navigation = "📊 データパイプライン"
        st.rerun()


def render_step2():
    """ステップ2: データ処理"""

    st.markdown("""
    #### 🔧 やること: HTMLファイルを機械学習で使える形式に変換

    **何をするの？**
    - ダウンロードしたHTMLファイルを読み込む
    - 必要な情報を抽出する
    - Parquet形式（高速に読み書きできる形式）で保存

    **所要時間:** 約5-15分（データ量による）

    **⚠️ 注意点:**
    - ステップ1が完了していないと実行できません
    - 処理中はログでエラーがないか確認しましょう
    """)

    st.markdown("---")

    st.markdown("#### 📝 手順")

    st.markdown("""
    1. **左サイドバーから「📊 データパイプライン」をクリック**
    2. **「パース処理」タブを開く**
    3. **パースオプションを確認**
       - 基本的に全てチェック（レース、出馬表、馬、血統）
    4. **「🚀 パース処理開始」ボタンをクリック**
    5. **完了を待つ**
       - ログに「パース処理が正常に完了しました」と表示されればOK
    """)

    st.success("""
    ✅ **完了後の確認:**
    - ダッシュボードに戻って、「レースデータ」の件数が増えているか確認
    - データエクスプローラーで実際のデータを見てみましょう
    """)

    if st.button("📊 データパイプラインへ移動", key="goto_step2", type="primary"):
        st.session_state.navigation = "📊 データパイプライン"
        st.rerun()


def render_step3():
    """ステップ3: 特徴量生成"""

    st.markdown("""
    #### 🔬 やること: AIが学習するための「特徴量」を作成

    **特徴量って何？**
    - AIが予測に使う情報のこと
    - 例: 「この馬の過去5レースの平均着順」「この騎手の勝率」など
    - KeibaAI_v2は27種類以上の特徴量を自動生成します

    **所要時間:** 約10-30分

    **⚠️ 注意点:**
    - ステップ2が完了していないと実行できません
    - データ量が多いほど時間がかかります
    """)

    st.markdown("---")

    st.markdown("#### 📝 手順")

    st.markdown("""
    1. **左サイドバーから「📊 データパイプライン」をクリック**
    2. **「特徴量生成」タブを開く**
    3. **日付範囲を設定**
       - ステップ1で取得した期間と同じ範囲を指定
    4. **特徴量オプションを確認**
       - 全てチェックを推奨（レース、馬、騎手、調教師、血統）
    5. **「🚀 特徴量生成開始」ボタンをクリック**
    6. **完了を待つ**
    """)

    st.info("""
    💡 **ヒント:**
    - 特徴量は年月ごとにファイル分割されて保存されます
    - 後から追加でデータを取得しても、既存の特徴量は保持されます
    """)

    if st.button("📊 データパイプラインへ移動", key="goto_step3", type="primary"):
        st.session_state.navigation = "📊 データパイプライン"
        st.rerun()


def render_step4():
    """ステップ4: モデル学習"""

    st.markdown("""
    #### 🤖 やること: AIモデルを学習させる

    **何を学習するの？**
    KeibaAI_v2は3つのパラメータを予測します:
    - **μ (ミュー)**: 各馬の期待タイム
    - **σ (シグマ)**: 予測の不確実性
    - **ν (ニュー)**: レース全体の混沌度

    **所要時間:** 約1-3時間（データ量による）

    **⚠️ 注意点:**
    - 時間がかかるので、バックグラウンドで実行しましょう
    - 最低でも100レース以上のデータが必要です
    - 学習中は他の作業ができます
    """)

    st.markdown("---")

    st.markdown("#### 📝 手順")

    st.markdown("""
    1. **左サイドバーから「🤖 モデル学習」をクリック**
    2. **「μモデル」タブを開く**
    3. **学習期間を設定**
       - 開始日: データの最初の日付
       - 終了日: データの最後の日付
       - （ダッシュボードで確認できます）
    4. **モデル保存先を確認**
       - デフォルトで日付付きフォルダ名が入力されています
    5. **ハイパーパラメータ**
       - 初めての方はデフォルト値のままでOK
    6. **「🚀 μモデル学習開始」ボタンをクリック**
    7. **ログで進捗を確認しながら待つ**
    """)

    st.warning("""
    ⏰ **時間がかかる理由:**
    - 機械学習は大量の計算が必要です
    - データが多いほど精度が上がりますが、時間もかかります
    - 一度学習すれば、次回からは予測だけで済みます
    """)

    st.success("""
    ✅ **学習完了後:**
    - 「結果分析」でモデルの精度を確認してみましょう
    - Brier Scoreが0.2以下なら良好です
    """)

    if st.button("🤖 モデル学習へ移動", key="goto_step4", type="primary"):
        st.session_state.navigation = "🤖 モデル学習"
        st.rerun()


def render_step5():
    """ステップ5: 予測・シミュレーション"""

    st.markdown("""
    #### 🎲 やること: レース結果をシミュレーションする

    **シミュレーションって何？**
    - 学習したモデルを使って、レース結果を何千回もシミュレート
    - 各馬の勝率、連対率、複勝率を推定
    - 例: 「1番の馬が勝つ確率は18.7%」

    **所要時間:** 約5-10分

    **⚠️ 注意点:**
    - ステップ4が完了していないと実行できません
    - シミュレーション回数（K）が多いほど精度が上がりますが時間もかかります
    """)

    st.markdown("---")

    st.markdown("#### 📝 手順")

    st.markdown("""
    1. **左サイドバーから「🎲 シミュレーション」をクリック**
    2. **シミュレーション対象日を選択**
       - データが存在する日付を選んでください
    3. **シミュレーション回数（K）を設定**
       - 推奨: 1000回（精度と速度のバランス）
       - 速度重視: 100回
       - 精度重視: 10000回
    4. **「🚀 シミュレーション開始」ボタンをクリック**
    5. **結果を確認**
       - JSON形式で各馬の勝率が表示されます
    """)

    st.info("""
    💡 **次のステップ:**
    - シミュレーション結果を使って、最適な賭け金を計算できます
    - 「💰 ポートフォリオ最適化」ページへ進みましょう
    """)

    st.success("""
    🎉 **おめでとうございます！**
    これで基本的な流れは完了です。

    **これからできること:**
    1. **最適化**: 科学的に最適な賭け金を計算
    2. **結果分析**: モデルの精度を詳しく分析
    3. **データ追加**: 定期的に新しいデータを追加して精度向上

    **ペーパートレードから始めましょう！**
    実際に賭ける前に、架空の賭けで練習するのがおすすめです。
    """)

    col1, col2 = st.columns(2)
    with col1:
        if st.button("🎲 シミュレーションへ移動", key="goto_step5_sim", type="primary", use_container_width=True):
            st.session_state.navigation = "🎲 シミュレーション"
            st.rerun()

    with col2:
        if st.button("💰 最適化へ移動", key="goto_step5_opt", type="secondary", use_container_width=True):
            st.session_state.navigation = "💰 ポートフォリオ最適化"
            st.rerun()


def render_faq():
    """よくある質問"""

    st.markdown("## ❓ よくある質問")

    faq_items = [
        {
            "question": "データ取得に時間がかかりすぎます",
            "answer": """
            これは正常な動作です。スクレイピングは対象サーバーに負荷をかけないよう、
            意図的にゆっくり実行されます（1リクエスト2.5-5秒）。

            **対策:**
            - まずは1週間分から始める
            - バックグラウンドで実行して他の作業をする
            - 夜間に実行する
            """
        },
        {
            "question": "エラーが出ました",
            "answer": """
            **まず確認すること:**
            1. ログビューアでエラーの詳細を確認
            2. インターネット接続を確認
            3. データパスが正しいか確認

            **よくあるエラー:**
            - HTTP 400: サーバーが混雑 → 少し待って再実行
            - FileNotFoundError: データがない → 前のステップを実行
            - MemoryError: メモリ不足 → データ量を減らすかPCを再起動
            """
        },
        {
            "question": "モデルの精度が低いです",
            "answer": """
            **精度を上げる方法:**
            1. **データ量を増やす** - 最低でも1年分推奨
            2. **特徴量を増やす** - 全てのカテゴリを有効化
            3. **ハイパーパラメータ調整** - n_estimatorsを増やす
            4. **データ品質を確認** - 欠損値が多くないか確認

            **良好な精度の目安:**
            - Brier Score: 0.2以下
            - Top-1精度: 30%以上
            """
        },
        {
            "question": "実際に賭けても大丈夫ですか？",
            "answer": """
            ⚠️ **このシステムは教育・研究目的です**

            **推奨する手順:**
            1. まず**ペーパートレード**（架空の賭け）で十分なデータを集める
            2. 少なくとも100レース以上で精度を検証
            3. 安定して利益が出ることを確認
            4. **少額から**始める
            5. **投資は自己責任**で

            **注意:**
            - 過去の精度が将来を保証するものではありません
            - 必ず余裕資金で行ってください
            """
        },
        {
            "question": "もっと詳しく学びたい",
            "answer": """
            **参考資料:**
            1. **GUI_USER_GUIDE.md** - 詳細な使い方
            2. **CLAUDE.md** - 技術的な詳細
            3. **schema.md** - データ構造
            4. **結果分析ページ** - モデルの評価方法

            **推奨書籍:**
            - 機械学習入門書
            - 競馬データ分析の本
            - ケリー基準の解説書
            """
        }
    ]

    for item in faq_items:
        with st.expander(f"**Q: {item['question']}**"):
            st.markdown(item['answer'])
