# debug_scraped_data.csv 詳細分析レポート

**分析日時**: 2025-11-16
**対象ファイル**: `debug_scraped_data.csv`
**対象日付**: 2023-10-09 (TARGET_DATE)
**スクリプト**: `debug_scraping_and_parsing.py`

---

## 📊 データセット概要

| 項目 | 値 |
|------|-----|
| **総行数** | 440行 |
| **総カラム数** | 54カラム |
| **ユニークレースID数** | 36レース |
| **日付範囲** | 2023-10-09 (東京・京都・盛岡) |

---

## ✅ 成功している項目

### 1. 基本的なレース結果データ

以下のカラムは**完璧に取得できています**:

- **馬情報**: `horse_id`, `horse_name`, `sex`, `age`, `sex_age`
- **騎手情報**: `jockey_id`, `jockey_name`
- **調教師情報**: `trainer_id`, `trainer_name`
- **馬主情報**: `owner_name`
- **レース結果**: `finish_position`, `bracket_number`, `horse_number`
- **タイム情報**: `finish_time_str`, `finish_time_sec`, `last_3f_time`
- **着差情報**: `margin_str`, `margin_seconds` (1馬身=0.2秒の変換が正しく機能)
- **オッズ・人気**: `win_odds`, `popularity` (整合性確認済み)
- **馬体重**: `horse_weight`, `horse_weight_change`
- **通過順位**: `passing_order_1`, `passing_order_2` (コーナー数に応じた欠損は正常)

**欠損率**: ほとんどのカラムで **1%未満**（取消馬などの例外を除く）

### 2. メタデータ

以下のメタデータも正常に取得:

- **レース情報**: `race_id`, `race_date`, `race_name`, `race_class`
- **開催情報**: `venue`, `day_of_meeting`, `round_of_year`
- **天候・馬場**: `weather`, `track_condition`
- **発走時刻**: `post_time`

### 3. 派生特徴量

`add_derived_features()` で生成される派生特徴量が正しく計算されています:

- ✅ `time_before_last_3f = finish_time_sec - last_3f_time` (検証済み)
- ✅ `popularity_finish_diff = finish_position - popularity` (穴馬検出用)
- ✅ `odds_rank`, `odds_popularity_diff` (期待値分析用)
- ✅ `cumulative_margin` (ペース判定用)
- ✅ `race_avg_time`, `time_deviation` (標準化用)
- ✅ `position_change` (末脚指標)

### 4. データ整合性

- ✅ **着順の連続性**: すべてのレースで1着から連続した着順
- ✅ **オッズと人気の整合性**: オッズ順と人気順が一致
- ✅ **賞金の付与**: 1～5着に正しく賞金が付いている（59.09%の欠損は6着以降で正常）

---

## ⚠️ 発見された問題点

### 🔴 重大な問題

#### 問題1: prize_1st ~ prize_5th が100%欠損

**現象**:
```
prize_1st: 440/440 行 (100.00%) 欠損
prize_2nd: 440/440 行 (100.00%) 欠損
prize_3rd: 440/440 行 (100.00%) 欠損
prize_4th: 440/440 行 (100.00%) 欠損
prize_5th: 440/440 行 (100.00%) 欠損
```

**原因**:
`debug_scraping_and_parsing.py` の `extract_race_metadata_enhanced()` 関数で賞金情報を抽出しようとしていますが、**実際にはHTMLから取得できていません**。

**該当コード** (行299-310):
```python
# 賞金情報
prize_info = soup.find('div', class_='RaceData02')
if prize_info:
    prize_text = prize_info.get_text()
    prize_match = re.search(r'本賞金:([\d,]+)万円', prize_text)
    if prize_match:
        prizes = [int(p.replace(',', '')) for p in prize_match.group(1).split(',')]
        if len(prizes) >= 1: metadata['prize_1st'] = prizes[0]
        if len(prizes) >= 2: metadata['prize_2nd'] = prizes[1]
        # ...
```

**推定原因**:
- HTMLの構造が想定と異なる可能性
- `class_='RaceData02'` が存在しない、または別のクラス名
- 正規表現パターン `r'本賞金:([\d,]+)万円'` がマッチしていない

**推奨対応**:
1. 実際のHTMLを確認し、賞金情報の正しいセレクタを特定
2. `schema.md` に記載されている通り、以下の形式で取得されているはず:
   ```html
   <div class="RaceData02">
     <span>本賞金:500,320,200,130,50万円</span>
   </div>
   ```
3. パーサーのデバッグ出力を追加して、なぜマッチしないのか調査

---

### 🟡 中程度の問題

#### 問題2: distance_m と track_surface が一部のレースで欠損 (10.23%)

**現象**:
```
distance_m:      45/440 行 (10.23%) 欠損
track_surface:   45/440 行 (10.23%) 欠損
```

**該当レースID**:
```
202305040304: 障害3歳以上未勝利
202308020303: 2歳未勝利
202308020309: りんどう賞(1勝)
202308020311: 第58回京都大賞典(GII)
```

**原因**:
障害レースや一部の特殊なレースでは、HTMLの構造が通常のレースと異なります。

**詳細調査結果** (202305040304の例):
- `race_name`: "障害3歳以上未勝利"
- `distance_m`: 空
- `track_surface`: 空
- `finish_time_sec`: 207.1秒 (= 3分27秒、通常レースの2倍以上)
- `last_3f_time`: 13.8秒 (障害レースのため、通常より短い区間)

**該当コード** (行212-249):
```python
# 方法1: data_intro を探す（通常のレース）
race_data_intro = soup.find('div', class_='data_intro')

# 方法2: diary_snap_cut を探す
if not race_data_intro:
    race_data_intro = soup.find('div', class_='diary_snap_cut')

# 方法3: racedata > dd を探す（障害レースや古いページ）
if not race_data_intro:
    race_data_dl = soup.find('dl', class_='racedata')
    if race_data_dl:
        race_data_intro = race_data_dl.find('dd')
```

4レベルのフォールバックを実装していますが、それでも取得できていません。

**推奨対応**:
1. 障害レースの実際のHTMLを確認
2. 障害レースには「障3000m」のような表記があるため、正規表現を拡張:
   ```python
   distance_match = re.search(r'(芝|ダ|障)\s*(?:右|左|直|外|内)?\s*(\d+)\s*m?', text, re.IGNORECASE)
   ```
   上記の正規表現は既に実装されているが、HTMLにテキストが存在しない可能性
3. `race_name` から推測する補完ロジックを追加:
   ```python
   if '障害' in race_name and not metadata['track_surface']:
       metadata['track_surface'] = '障害'
   ```

---

### 🟢 正常な欠損

以下の欠損は**仕様上正常**です:

#### passing_order_3 (77.50%), passing_order_4 (79.55%)

**理由**: コースによってコーナー数が異なる
- 直線コース: コーナーなし
- 2コーナーコース: passing_order_1, 2のみ
- 4コーナーコース: すべて存在

**検証結果**:
```
202305040301 (ダート1600m): passing_order は1,2のみ → ✓正常
202305040303 (芝1800m):     passing_order は1,2,3のみ → ✓正常
```

#### prize_money (59.09%)

**理由**: 6着以降の馬には賞金が付かない

**検証結果**:
```
賞金が付いている着順:
  1着: 36件
  2着: 36件
  3着: 36件
  4着: 36件
  5着: 36件
  6着以降: 0件 → ✓正常
```

---

## 📈 統計的検証

### 数値カラムの値の範囲

| カラム | 最小値 | 最大値 | 単位 | 妥当性 |
|--------|--------|--------|------|--------|
| `distance_m` | 1000.00 | 2400.00 | m | ✅ 正常 (短距離～長距離) |
| `age` | 2.00 | 11.00 | 歳 | ✅ 正常 (2歳～古馬) |
| `basis_weight` | 50.00 | 60.00 | kg | ✅ 正常 (斤量範囲) |
| `finish_time_sec` | 60.80 | 224.00 | 秒 | ✅ 正常 (1分～3分半) |
| `last_3f_time` | 13.80 | 46.80 | 秒 | ⚠️ 13.8秒は障害レース |
| `win_odds` | 1.00 | 999.90 | 倍 | ✅ 正常 (1.0～999.9) |
| `popularity` | 1.00 | 17.00 | 番 | ✅ 正常 (1番人気～17番人気) |
| `horse_weight` | 360.00 | 552.00 | kg | ✅ 正常 (小柄～大柄) |
| `horse_weight_change` | -16.00 | 28.00 | kg | ✅ 正常 (増減範囲) |

### カテゴリカルカラムの分布

**track_surface**:
- ダート: 291件 (73.7%)
- 芝: 104件 (26.3%)

**weather**:
- 曇: 228件 (51.8%)
- 雨: 135件 (30.7%)
- 小雨: 77件 (17.5%)

**track_condition**:
- 稍重: 189件 (43.0%)
- 重: 178件 (40.5%)
- 不良: 73件 (16.6%)

**sex**:
- 牡: 230件 (52.3%)
- 牝: 190件 (43.2%)
- セ: 20件 (4.5%)

**race_class**:
- その他: 115件 (26.1%) ← 地方競馬のクラス分類
- 500万: 92件 (20.9%)
- 未勝利: 78件 (17.7%)
- 新馬: 55件 (12.5%)
- 1000万: 29件 (6.6%)
- G1: 28件 (6.4%)
- 1600万: 27件 (6.1%)
- OP: 16件 (3.6%)

---

## 🔍 詳細検証結果

### レース一覧（36レース）

| race_id | レース名 | 馬場 | 距離 | 頭数 | 備考 |
|---------|---------|------|------|------|------|
| 202305040301 | 2歳未勝利 | ダート | 1600m | 13頭 | ✅ |
| 202305040302 | 2歳未勝利 | 芝 | 1600m | 13頭 | ✅ |
| 202305040303 | 2歳未勝利 | 芝 | 1800m | 9頭 | ✅ |
| 202305040304 | 障害3歳以上未勝利 | ? | ?m | 12頭 | ⚠️ 距離・馬場欠損 |
| 202305040305 | 2歳新馬 | 芝 | 1600m | 13頭 | ✅ |
| 202305040306 | 2歳新馬 | ダート | 1400m | 15頭 | ✅ |
| 202305040307 | 3歳以上1勝クラス | ダート | 1600m | 14頭 | ✅ |
| 202305040308 | 3歳以上1勝クラス | 芝 | 1400m | 16頭 | ✅ |
| 202305040309 | 昇仙峡特別(2勝) | ダート | 2100m | 16頭 | ✅ |
| 202305040310 | 六社ステークス(3勝) | 芝 | 2400m | 14頭 | ✅ |
| 202305040311 | グリーンチャンネルC(L) | ダート | 1600m | 16頭 | ✅ |
| 202305040312 | 3歳以上1勝クラス | ダート | 1300m | 12頭 | ✅ |
| 202308020301 | 2歳未勝利 | 芝 | 1400m | 12頭 | ✅ |
| 202308020302 | 2歳未勝利 | ダート | 1200m | 10頭 | ✅ |
| 202308020303 | 2歳未勝利 | ? | ?m | 9頭 | ⚠️ 距離・馬場欠損 |
| 202308020304 | 2歳新馬 | 芝 | 1400m | 17頭 | ✅ |
| 202308020305 | 2歳新馬 | 芝 | 2000m | 10頭 | ✅ |
| 202308020306 | 3歳以上1勝クラス | ダート | 1800m | 11頭 | ✅ |
| 202308020307 | 3歳以上1勝クラス | ダート | 1900m | 13頭 | ✅ |
| 202308020308 | 3歳以上1勝クラス | ダート | 1200m | 16頭 | ✅ |
| 202308020309 | りんどう賞(1勝) | ? | ?m | 10頭 | ⚠️ 距離・馬場欠損 |
| 202308020310 | 大山崎ステークス(3勝) | ダート | 1200m | 13頭 | ✅ |
| 202308020311 | 第58回京都大賞典(GII) | ? | ?m | 14頭 | ⚠️ 距離・馬場欠損 |
| 202308020312 | 3歳以上2勝クラス | ダート | 1400m | 13頭 | ✅ |
| 202335100901～912 | 盛岡競馬 (地方競馬) | ダート | 1000～1600m | 8～14頭 | ✅ |

**分析**:
- 東京競馬: 12レース (202305040301～0312)
- 京都競馬: 12レース (202308020301～0312)
- 盛岡競馬: 12レース (202335100901～0912)
- 障害・特殊レース: 4レースで距離・馬場が取得できず

---

## 🎯 推奨事項

### 優先度: 高 (すぐに修正すべき)

1. **賞金情報の取得修正**
   - 現在100%欠損している `prize_1st ~ prize_5th` を取得できるようにする
   - HTMLセレクタとパターンマッチの見直し
   - デバッグ出力を追加して原因を特定

### 優先度: 中 (近いうちに対応)

2. **障害レースの距離・馬場情報の取得**
   - 障害レースのHTML構造を調査
   - フォールバックロジックの追加
   - `race_name` からの推測ロジック実装

3. **データ型の最適化**
   - CLAUDE.mdに従い、nullable integer型（Int64）を使用
   - 現在はfloat型で格納されている整数カラムを修正

### 優先度: 低 (余裕があれば)

4. **G1レース等の特殊レースの対応強化**
   - 一部のG1レースで距離・馬場が取得できていない
   - より堅牢なパーサーロジックの実装

5. **地方競馬のクラス分類**
   - 現在「その他」に分類されている地方競馬のクラスを正しく分類

---

## 📝 総合評価

### ✅ 良好な点

1. **基本的なレース結果データは完璧** (99%以上の取得率)
2. **データ整合性が高い** (着順の連続性、オッズと人気の整合性)
3. **派生特徴量が正しく計算されている**
4. **3つの競馬場（東京・京都・盛岡）のデータを取得できている**
5. **スクレイピングとパースのパイプラインが正常に動作**

### ⚠️ 改善が必要な点

1. **賞金情報が一切取得できていない** ← 最優先で修正
2. **障害レース等の特殊なレースで距離・馬場が欠損** ← 要対応
3. **データ型の最適化が未実施** (float64 → Int64)

### 🏆 総合スコア

**85/100点**

- データ取得: 90点 (基本情報は完璧、賞金のみ欠損)
- データ品質: 95点 (整合性・正確性が高い)
- カバレッジ: 90点 (障害レース等で一部欠損)
- パイプライン: 90点 (安定して動作)
- ドキュメント: 70点 (CLAUDE.mdとの一部不整合)

---

## 📌 次のステップ

1. **即座に実行**:
   - `debug_scraping_and_parsing.py` の賞金抽出ロジックをデバッグ
   - 実際のHTMLを確認し、正しいセレクタを特定

2. **今週中に実行**:
   - 障害レースのHTML構造を調査
   - パーサーの改善版を実装

3. **今月中に実行**:
   - データ型の最適化（pandas Int64型への変換）
   - 本番パイプライン（`keibaai/src/modules/parsers/results_parser.py`）への反映

---

## 📚 参考資料

- `CLAUDE.md`: プロジェクトの完全なドキュメント
- `schema.md`: データスキーマ仕様
- `DEBUG_REPORT.md`: 過去のパーサー改善履歴
- `PROGRESS.md`: データ品質追跡

---

**分析担当**: Claude (AI Assistant)
**レビュー推奨者**: 開発チーム
