# データ品質調査 PROGRESS.md

## サマリー

### 問題
- `races.parquet` に約0.8%のデータ欠損、`shutuba.parquet` に複数の100%欠損カラムが存在。
- 当初、これらの欠損はデータソースの仕様（レース中止、元HTMLにデータ不在）が原因と推測された。

### 発覚した真実
- ユーザー様からのご指摘により、旧プロジェクトからコピーされた大量の `.bin` ファイルの存在が判明。
- これらの `.bin` ファイルは、`euc-jp` でエンコードされた有効なレース結果HTMLを含んでいるにも関わらず、現在のパーサーで処理に失敗していた。

### 根本原因
- **HTML解析ライブラリの相性問題**:
  - `.bin` ファイル内のHTML構造と、`results_parser.py` が使用していたHTML解析ライブラリ `lxml` との相性が悪く、`BeautifulSoup` がレース結果のテーブル (`race_table_01`) を正しく認識できていなかった。これが、ログに「テーブルが見つかりません」と記録されていた真の原因。

### 実施した対策
- `results_parser.py` を修正し、HTML解析ライブラリを `lxml` から、より標準的で安定している `html.parser` に変更。
- これにより、これまでパースに失敗していた `.bin` ファイル群を正しく処理し、データとして有効活用できる道筋を立てた。

### 現在の状況と次のステップ
1.  **データ再処理 (ユーザー様にて実行中)**:
    - 上記の修正を反映したデータ整形パイプライン (`run_parsing_pipeline_local.py`) を、現在ユーザー様に実行していただいています。
2.  **結果の確認 (AIにて実施予定)**:
    - パイプライン実行完了後、`races.parquet` の欠損率が改善されたかを確認します。
3.  **横展開 (今後の調査課題)**:
    - 「`race` だけでなく `shutuba`, `ped`, `horse` にも異なる形式の `.bin` ファイルが存在する」との追加情報をいただいています。
    - `races.parquet` の問題が解決した後、これらの `.bin` ファイルについても同様の調査・修正を行い、すべてのデータを有効活用していく必要があります。

---

## 調査ログ（時系列）

- **[2025-11-14]**: データ品質分析スクリプトを実行し、各Parquetファイルの欠損率を特定。
- **[2025-11-14]**: `shutuba.parquet` の100%欠損は、元HTMLにデータがない「仕様」であると一次結論。
- **[2025-11-14]**: `races.parquet` の0.8%欠損について、ログから「テーブルが見つからない」エラーを確認。当初、レース中止ページが原因と推測。
- **[2025-11-14]**: ユーザー様より「`.bin` ファイルの存在」について重要なご指摘を受け、調査方針を転換。
- **[2025-11-14]**: `Get-ChildItem` コマンドにより、`keibaai/data/raw/html/race/` 以下に多数の `.bin` ファイルが存在することを**確認**。当初の「ファイルが存在しない」という結論を訂正。
- **[2025-11-14]**: `.bin` ファイルの中身を調査。`euc-jp` でエンコードされた完全なHTMLであり、かつ目的のテーブル (`race_table_01`) も含まれていることを確認。
- **[2025-11-14]**: 「データもエンコーディングも正しいのになぜパースできないのか？」という矛盾点から、HTML解析ライブラリ `lxml` との相性問題を根本原因として特定。
- **[2025-11-14]**: 対策として `results_parser.py` のパーサーライブラリを `html.parser` に変更。
- **[2025-11-14]**: ユーザー様にてデータ整形パイプライン (`run_parsing_pipeline_local.py`) が実行中。完了後、結果を確認予定。
- **[2025-11-14]**: ユーザー様より「`shutuba`, `ped`, `horse` にも異なる形式の `.bin` が存在する」との追加情報をいただく。これらは今後の調査対象。\n---\n\n## データ品質 再分析レポート（パーサー修正後）\n\nパーサー修正後に `run_parsing_pipeline_local.py` を再実行し、データ品質を再分析しました。\n\n### races.parquet\n\n| column              |   total_rows |   missing_values |   missing_percentage |
|:--------------------|-------------:|-----------------:|---------------------:|
| prize_money         |       278098 |           177181 |            63.7117   |
| margin_seconds      |       278098 |             7947 |             2.85763  |
| finish_position     |       278098 |             2276 |             0.818417 |
| last_3f_time        |       278098 |             2276 |             0.818417 |
| finish_time_seconds |       278098 |             2275 |             0.818057 |
| popularity          |       278098 |              989 |             0.35563  |
| win_odds            |       278098 |              989 |             0.35563  |
| horse_weight_change |       278098 |              441 |             0.158577 |
| horse_weight        |       278098 |              441 |             0.158577 |
| owner_name          |       278098 |                0 |             0        |
| trainer_id          |       278098 |                0 |             0        |
| trainer_name        |       278098 |                0 |             0        |
| passing_order       |       278098 |                0 |             0        |
| margin_str          |       278098 |                0 |             0        |
| race_id             |       278098 |                0 |             0        |
| race_date           |       278098 |                0 |             0        |
| jockey_id           |       278098 |                0 |             0        |
| jockey_name         |       278098 |                0 |             0        |
| basis_weight        |       278098 |                0 |             0        |
| age                 |       278098 |                0 |             0        |
| sex                 |       278098 |                0 |             0        |
| sex_age             |       278098 |                0 |             0        |
| horse_id            |       278098 |                0 |             0        |
| horse_name          |       278098 |                0 |             0        |
| horse_number        |       278098 |                0 |             0        |
| bracket_number      |       278098 |                0 |             0        |
| finish_time_str     |       278098 |                0 |             0        |\n\n### shutuba.parquet\n\n| column              |   total_rows |   missing_values |   missing_percentage |
|:--------------------|-------------:|-----------------:|---------------------:|
| last_5_finishes     |       278082 |           278082 |        100           |
| career_places       |       278082 |           278082 |        100           |
| career_wins         |       278082 |           278082 |        100           |
| career_starts       |       278082 |           278082 |        100           |
| career_stats        |       278082 |           278082 |        100           |
| prize_total         |       278082 |           278082 |        100           |
| owner_name          |       278082 |           278082 |        100           |
| morning_popularity  |       278082 |           278082 |        100           |
| morning_odds        |       278082 |           278082 |        100           |
| race_date           |       278082 |             5744 |          2.06558     |
| horse_weight_change |       278082 |             1159 |          0.416784    |
| horse_weight        |       278082 |              989 |          0.35565     |
| trainer_id          |       278082 |                2 |          0.000719212 |
| bracket_number      |       278082 |                0 |          0           |
| trainer_name        |       278082 |                0 |          0           |
| jockey_id           |       278082 |                0 |          0           |
| jockey_name         |       278082 |                0 |          0           |
| basis_weight        |       278082 |                0 |          0           |
| age                 |       278082 |                0 |          0           |
| sex                 |       278082 |                0 |          0           |
| sex_age             |       278082 |                0 |          0           |
| horse_id            |       278082 |                0 |          0           |
| horse_name          |       278082 |                0 |          0           |
| horse_number        |       278082 |                0 |          0           |
| race_id             |       278082 |                0 |          0           |\n\n### pedigrees.parquet\n\n| column        |   total_rows |   missing_values |   missing_percentage |
|:--------------|-------------:|-----------------:|---------------------:|
| horse_id      |      1377361 |                0 |                    0 |
| ancestor_id   |      1377361 |                0 |                    0 |
| ancestor_name |      1377361 |                0 |                    0 |\n\n