# Keiba AI プロジェクト進捗レポート

## 1. はじめに

本ドキュメントは、AI競馬予測システムの開発プロジェクトにおける、初期評価から問題特定、および修正に至るまでの一連の進捗をまとめたものです。

## 2. 初期評価と問題の特定 (2025-11-14)

プロジェクトの初期段階として、学習済みモデル（`mu_model_v2`）の性能を評価するため、`keibaai/src/models/evaluate_model.py`スクリプトを実行しました。

### 2.1. 確認された事象

1.  **多数の警告:** 実行時に`pyarrow`のデータ読み込み警告、Pandasの`SettingWithCopyWarning`および`FutureWarning`が多数発生し、コードの堅牢性に問題があることが示唆されました。
2.  **モデル性能の低さ:**
    *   タイム予測モデル（Regressor）のRMSE（平均二乗誤差平方根）が約22秒と、予測モデルとして機能していないレベルの大きな誤差が確認されました。
    *   順位予測モデル（Ranker）の性能を示すスピアマン順位相関係数が、期待される負の値ではなく、**正の値（約`+0.15`）**を示しました。これは、モデルが「スコアが高いほど良い順位」と予測すべきところを、「スコアが高いほど悪い順位」と完全に逆の相関関係を学習してしまっていることを意味していました。

これらの結果から、**モデルの予測能力に深刻な問題がある**ことが判明しました。

## 3. デバッグと原因分析の過程

モデル性能の低さの根本原因を特定するため、以下のステップで詳細な調査を実施しました。

### 3.1. Step 1: スクリプトの警告解消

まず、コードの安定性を確保するため、評価スクリプトで発生していた各種警告を解消しました。

*   `data_utils.py`: `pyarrow`の警告を解消するため、データ読み込みロジックをより堅牢な方式に修正。
*   `evaluate_model.py`: `SettingWithCopyWarning`と`FutureWarning`を解消するため、DataFrameの操作をより安全な方法に修正。

**結果:** 警告は解消されましたが、モデルの性能（相関係数が正の値）は改善されませんでした。これにより、問題が表面的なバグではなく、より根深い箇所にあることが確認されました。

### 3.2. Step 2: モデル実装の検証

次に、モデルのロジック自体に誤りがないかを確認するため、`keibaai/src/models/model_train.py`に実装されている`MuEstimator`クラスと、プロジェクトの仕様書を比較検証しました。

**結果:** モデルクラスの実装は仕様書に忠実であり、スコア計算のロジックに明らかな誤りは見つかりませんでした。しかし、この過程で、スコアの正規化処理がレース単位ではなくバッチ全体で行われている問題を発見し、レース単位の正規化に修正しました。それでもなお、モデル性能は改善しませんでした。

### 3.3. Step 3: 特徴量分析 (根本原因の発見)

モデルや評価ロジックが正しいと仮定し、入力データである**特徴量**に問題があるとの仮説を立て、`notebooks/02_feature_analysis.ipynb`を作成して特徴量と着順の相関分析を実施しました。

**分析結果:**

1.  **特徴量の欠落:** `prize_total`（獲得賞金）や`morning_odds`（前日オッズ）といった、予測に不可欠なはずの重要特徴量がすべて`NaN`（欠損値）となっており、モデルに全く利用されていないことが判明しました。
2.  **相関の逆転:** `past_..._finish_time_seconds_mean`（過去の平均タイム）が、着順と負の相関（速い馬ほど着順が悪い）を示しており、直感に反する誤った関係性を持っていることが確認されました。
3.  **予測能力の低さ:** 全体的に、各特徴量と着順との相関係数が極めて低く（多くが`0.1`未満）、現在の特徴量セットではモデルが有効な学習を行うことが困難であることが示唆されました。

### 3.4. 根本原因の特定

特徴量欠落の原因をさらに追跡した結果、`keibaai/src/modules/parsers/shutuba_parser.py`（出馬表パーサー）が、仕様として`prize_total`等の情報を**意図的に取得しない設計**になっていることが判明しました。これらの情報は出馬表ページには存在せず、馬の過去成績ページなど、別のページから取得する必要があったのです。

最終的に、**「特徴量生成パイプライン（`feature_engine.py`）が、別ページから取得すべき重要な特徴量（獲得賞金、戦績など）を考慮せず、不完全なデータセットで特徴量を生成していた」**ことが、モデル性能の低さの根本原因であると特定しました。

## 4. 実施した修正

根本原因を解決するため、`keibaai/src/features/feature_engine.py`に対して以下の大規模な修正を実施しました。

1.  **`_add_horse_history_features`メソッドの新規実装:**
    馬の過去の全レース結果（`results_history_df`）を動的に集計し、これまで欠落していた`prize_total`（通算獲得賞金）、`career_starts`（通算出走回数）、`career_wins`（通算勝利数）といった**時点ごとの累計特徴量**を正しく計算するロジックを新規に実装しました。この実装は、将来のデータを含めないよう（リークしないよう）、各レース時点での過去の成績のみを集計する堅牢な設計になっています。

2.  **`_add_past_performance_features`メソッドのバグ修正:**
    同様に、過去N走の成績を集計する既存のロジックにも、データが正しく紐付けられない重大なバグが存在したため、これもリーク対策を施した新しいロジックに全面的に置換しました。

これらの修正により、特徴量生成パイプラインは、これまで欠落・破損していた重要な特徴量を正しく生成できる状態になりました。

## 5. 現状と今後のステップ

**現状:**
*   特徴量生成パイプラインの重大なバグが修正され、コードは正常に動作する状態です。
*   修正されたロジックで、2023年のデータを対象に特徴量の再生成が完了しました。

**今後のステップ:**
既存のモデル（`mu_model_v2`）は、バグのあった不正確な特徴量で学習されたものであるため、無効です。したがって、以下のステップでモデルを再構築し、性能改善を確認する必要があります。

1.  **モデルの再学習（Next Step）:**
    新しく生成した正しい特徴量データを使い、`train_mu_model.py`を実行してモデルを再学習させ、新しいバージョン（`mu_model_v4`）を作成します。

2.  **新モデルの評価:**
    再学習させた`mu_model_v4`を`evaluate_model.py`で評価し、スピアマン相関係数が期待通り**負の値**を示し、かつその絶対値が改善されるかを確認します。

3.  **`SettingWithCopyWarning`の修正:**
    モデルの再学習が成功した後、`train_mu_model.py`に残っている`SettingWithCopyWarning`を修正し、コードの品質をさらに向上させます。