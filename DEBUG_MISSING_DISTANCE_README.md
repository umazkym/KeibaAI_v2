# distance_m 欠損原因調査ツール

## 📋 概要

`debug_missing_distance.py`は、debug_full_pipeline_by_date.py の診断機能で特定された「distance_m欠損レース」の原因を調査するツールです。

## 🎯 目的

診断情報で以下のような出力があった場合：

```
【診断】distance_m 欠損レース:
  202305040304: 障害3歳以上未勝利 (12頭, source=data_intro)
  202308020303: 2歳未勝利 (9頭, source=data_intro)
```

- `source=data_intro` → data_intro divは**見つかっている**
- しかし distance_m が None → **正規表現が距離を抽出できていない**

このツールは、実際のHTML構造を確認し、正規表現パターンの改善点を特定します。

## 🚀 使い方

### 前提条件

- binファイルが `data/raw/html/race/` に存在すること
- 診断情報で欠損race_idが特定されていること

### 実行方法

```bash
python debug_missing_distance.py
```

### 実行環境

**注意**: このスクリプトは**ローカル環境**で実行する必要があります。
- binファイルは.gitignoreで除外されているため、リモート環境には存在しません
- Windows PowerShell、Mac/Linux両方で動作します

## 📊 出力内容

### 1. data_intro 全テキスト

```
【data_intro 全テキスト】 (最初の500文字)
----------------------------------------------------------------------
芝・右・外2000m / 天候:晴 / 芝:良 / 発走:15:40
本賞金:1000、400、250、150、100万円
----------------------------------------------------------------------
```

距離情報がどのように記載されているか確認できます。

### 2. 正規表現マッチテスト

現在の正規表現パターンでマッチするかテストします：

```
【正規表現マッチテスト】
----------------------------------------------------------------------
✓ パターン1マッチ: 芝2000m
  馬場: 芝, 距離: 2000m
```

または

```
✗ パターン1: マッチせず
```

### 3. spanタグ一覧

```
【spanタグ一覧】 (15個)
----------------------------------------------------------------------
span[ 0]: 芝・右・外
span[ 1]: 2000m
         → ✓ マッチ: なし
span[ 2]: 天候:晴
...
```

距離情報がspanタグで分離されている場合に確認できます。

### 4. HTML構造

```
【data_intro のHTML構造】 (最初の1000文字)
----------------------------------------------------------------------
<div class="data_intro">
  <div class="data_intro_rank">
    <span>芝・右・外</span>
    <span>2000m</span>
    ...
</div>
----------------------------------------------------------------------
```

実際のHTMLタグ構造を確認できます。

### 5. 追加パターンテスト

```
【追加パターンテスト】
----------------------------------------------------------------------
✓ 全角数字が含まれています
✓ スペース削除後マッチ: 芝右外2000
```

別のパターンでマッチする可能性を確認します。

## 🔍 調査対象race_id

デフォルトで以下のrace_idを調査します（診断情報より）：

```python
MISSING_RACE_IDS = [
    '202305040304',  # 障害3歳以上未勝利
    '202308020303',  # 2歳未勝利
    '202308020309',  # りんどう賞(1勝)
    '202308020311',  # 第58回京都大賞典(GII)
]
```

## 📝 調査結果の活用

### パターン1: 全角数字が使われている場合

**発見例**:
```
【data_intro 全テキスト】
芝１８００ｍ / 天候:晴
```

**対策**: 全角→半角変換を追加

```python
# 全角数字を半角に変換
text = text.translate(str.maketrans('０１２３４５６７８９', '0123456789'))
distance_match = re.search(r'(芝|ダ|障)\s*(?:右|左|直|外|内)?\s*(\d+)', text)
```

### パターン2: HTMLタグで分離されている場合

**発見例**:
```html
<span>芝</span><span>・</span><span>右</span><span>・</span><span>外</span><span>2000</span><span>m</span>
```

**対策**: タグを除去してから抽出

```python
# HTMLタグを除去
text_no_tags = re.sub(r'<[^>]+>', '', str(data_intro))
distance_match = re.search(r'(芝|ダ|障).{0,10}(\d+)', text_no_tags)
```

### パターン3: スペース・記号が多い場合

**発見例**:
```
芝 ・ 右 ・ 外 2000 m
```

**対策**: スペース・記号を削除

```python
text_compact = re.sub(r'[\s・]+', '', text)
distance_match = re.search(r'(芝|ダ|障)(右|左|直|外|内)?(\d+)', text_compact)
```

### パターン4: 距離表記が異なる場合

**発見例**:
```
距離:2000m (芝・右・外)
```

**対策**: 正規表現パターンを拡張

```python
# 距離が先に来る場合も対応
distance_match = re.search(r'(\d+)\s*m.*?(芝|ダ|障)', text)
if distance_match:
    metadata['distance_m'] = int(distance_match.group(1))
    metadata['track_surface'] = surface_map.get(distance_match.group(2))
```

## 🛠️ 修正フロー

1. **調査実行**
   ```bash
   python debug_missing_distance.py > distance_analysis.txt
   ```

2. **結果確認**
   - `distance_analysis.txt`を開く
   - 各race_idのHTML構造を確認
   - 共通パターンを特定

3. **正規表現修正**
   - `debug_scraping_and_parsing.py` の 254-271行目を修正
   - 新しいパターンを追加

4. **再テスト**
   ```bash
   python debug_full_pipeline_by_date.py --date 2023-10-09 --output-dir output_20231009 --parse-only
   ```

5. **確認**
   ```
   distance_m 欠損: 0行 (0.00%)  ← 目標
   ```

## 💡 よくある原因

1. **全角文字**: `１８００ｍ` → 半角変換が必要
2. **記号の挿入**: `芝・右・外` → 記号を許容する正規表現
3. **HTMLタグ分離**: `<span>芝</span><span>2000</span>` → タグ除去
4. **順序の違い**: `2000m 芝` → 順序に依存しない正規表現
5. **改行・スペース多用**: `芝  \n  2000m` → 空白文字を柔軟にマッチ

## ⚠️ 注意事項

- このツールは**診断専用**です（データ修正は行いません）
- 出力結果を元に手動で修正する必要があります
- binファイルが存在しない場合はエラーになります

## 📚 関連ファイル

- **debug_full_pipeline_by_date.py**: 診断情報を出力するメインツール
- **debug_scraping_and_parsing.py**: 正規表現パターンが定義されているファイル
- **CRITICAL_FIXES_20251116.md**: race_id形式の説明

---

**作成日**: 2025-11-16
**目的**: distance_m欠損の根本原因特定
