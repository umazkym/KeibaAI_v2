### **AI競馬予測システム モデル精度向上レビューレポート**

#### **1. はじめに**

この度は、貴殿が開発されている「AI競馬予測・最適投資システム」のレビュー機会をいただき、誠にありがとうございます。本レポートは、ご提供いただいたドキュメントおよびソースコードを詳細に分析し、システムの根幹である「機械学習モデルの予測精度向上」という目的に対して、具体的な改善案を提示するものです。

本レビューは、以下のステップで実施しました。

1.  **ドキュメントレビュー:** プロジェクトの全体像、設計思想、目標を把握。
2.  **データパイプライン分析:** HTMLのパース処理を中心に、データの流れと品質を評価。
3.  **特徴量エンジニアリング分析:** 生成される特徴量の種類とロジックを評価。
4.  **モデリング分析:** μ, σ, νモデルのアーキテクチャと学習プロセスを評価。

この分析に基づき、現状の強みを活かしつつ、さらなる高みを目指すための改善機会を特定し、具体的なアクションプランを提案します。

#### **2. プロジェクトの現状評価**

まず、本プロジェクトは個人研究開発の域を大きく超える、非常に高度かつ体系的に設計された優れたシステムであるという印象を受けました。特に以下の点は、本システムの大きな強みです。

**強み (Strengths):**

*   **洗練されたモデルアーキテクチャ:**
    *   単なる着順予測ではなく、馬の能力(μ)、馬固有の不確実性(σ)、レース全体の不確実性(ν)を個別にモデル化するアプローチは、競馬という複雑な事象を捉える上で非常に優れています。
    *   μモデルを回帰(タイム予測)とランキング(着順予測)のアンサンブルで構築している点は、絶対能力と相対能力の両方を考慮するロバストな設計です。

*   **堅牢なデータパイプライン:**
    *   スクレイピング、パース、特徴量生成、学習、予測というパイプラインが明確に分離・定義されています。
    *   パーサーは、HTMLの多様な構造に対応するための工夫が随所に見られ、データの欠損やエラーを防ぐための堅牢な実装がなされています。

*   **厳密なデータリーク対策:**
    *   特徴量エンジニアリングにおいて、`shift()`を用いて各レース時点での「過去」のデータのみを集計対象とする実装は、時系列データにおけるデータリークを厳密に防いでおり、モデルの信頼性を担保する上で極めて重要です。

*   **実践的な運用設計:**
    *   Dockerによる環境再現性の確保、日次・週次・月次の運用スクリプト、詳細なテスト戦略、リスク管理モジュールなど、研究で終わらせず「実際に使い続ける」ための仕組みが設計思想に組み込まれています。

**改善機会 (Opportunities):**

上記の強固な基盤があるからこそ、さらなる精度向上を目指すための改善に取り組む価値があります。主な改善機会は以下の4つの領域に集約されると考えられます。

1.  **データカバレッジ:** 現在取得・利用しているデータ以外の、予測に有用な情報源を取り込む余地。
2.  **特徴量の表現力:** ドメイン知識をさらに活用した特徴量や、交互作用を捉える特徴量の不足。
3.  **モデル学習の最適化:** ハイパーパラメータの最適化や、より目的に合致した損失関数の導入。
4.  **実験管理の効率化:** 特徴量やモデルの改善サイクルを高速化するための仕組み。

次章では、これらの改善機会に対して、具体的な提案を行います。

#### **3. モデル精度向上のための具体的な改善提案**

##### **【提案1】データ収集・パースの強化**

**目的:** モデルが利用できる情報の種類と質を向上させ、予測の根拠を増やす。

*   **1-1. パドック・返し馬情報の取得:**
    *   **現状:** 馬体重とその増減は取得していますが、レース直前の状態を示すパドック情報（気配、発汗、歩様など）や返し馬の状態は利用されていません。これらは専門家が重視する極めて重要なファクターです。
    *   **提案:** `netkeiba.com` のレース直前情報や、可能であればグリーンチャンネルWebなどの映像情報から、これらの定性的な情報をテキストとして取得し、後述する自然言語処理(NLP)特徴量として活用することを提案します。例えば、「気配抜群」「落ち着きあり」「入れ込み気味」といったテキストをカテゴリ特徴量やEmbeddingに変換します。
    *   **実装:** スクレイピングパイプラインに、レース発走15分前などに実行される専用のスクレイパーを追加します。
    *   **フィードバック (2025-11-16):**
        *   **判断:** **見送り**
        *   **理由:** 自動で安定的に情報を取得・評価するロジックの実装難易度が非常に高く、不確実性も伴うため、現時点では費用対効果が見合わない。

*   **1.2. 調教情報の取得:**
    *   **現状:** 調教タイムや内容に関するデータが利用されていません。レースに向けた仕上がり具合を判断する上で重要な情報です。
    *   **提案:** `netkeiba.com` の各馬のページには調教タイムのセクションがあります。これをパースし、「1週前追い切り」「最終追い切り」のコース（坂路、ウッドチップ等）、タイム、併せ馬との優劣などを特徴量化します。
    *   **実装:** `horse_info_parser.py` を拡張するか、調教専用のパーサーを新規作成します。調教タイムを基準タイムと比較して「調教評価スコア」のような特徴量を作ることも有効です。
    *   **フィードバック (2025-11-16):**
        *   **判断:** **見送り**
        *   **理由:** `netkeiba.com`の無料会員プランでは調教情報が取得できないため。

*   **1.3. 騎手・調教師の乗り替わり情報のフラグ化:**
    *   **現状:** 騎手ID、調教師IDは特徴量として利用されていますが、「前走からの乗り替わり」というイベント自体は陽に特徴量化されていません。
    *   **提案:** 特徴量生成エンジン(`feature_engine.py`)において、`history_df` を参照し、「前走と同じ騎手か」「前走と同じ調教師か（転厩など）」を示すバイナリ特徴量（`is_jockey_changed`など）を追加します。特に、リーディング上位騎手への「乗り替わり強化」や、逆に主戦騎手からの「乗り替わり弱化」は強力なシグナルとなり得ます。
    *   **フィードバック (2025-11-16):**
        *   **判断:** **実施**
        *   **理由:** モデルの予測精度向上に有効なシグナルとなりうるため、実装する。

*   **1.4. パーサーのフォールバックロジック強化:**
    *   **現状:** `results_parser.py` のメタデータ抽出は、複数の情報源から異なる種類のデータを集めていますが、ある情報（例：距離）の取得に失敗した場合に、別の情報源から同じ情報を取得しにいくというフォールバックにはなっていません。
    *   **提案:** 仕様書にあった通り、`extract_race_metadata_enhanced` 関数をリファクタリングし、`distance_m` や `track_surface` などの重要情報に対して、優先順位をつけて複数のセレクタを試し、取得できるまで探索するロジックを実装します。これにより、HTMLのマイナーチェンジに対する堅牢性がさらに向上します。
    *   **フィードバック (2025-11-16):**
        *   **判断:** **見送り**
        *   **理由:** フォールバックロジックの追加よりも優先して、同一のHTML構造と思われるページでも情報の取得結果が安定しない、という根本的な問題を先に解決すべきとの判断。

##### **【提案2】特徴量エンジニアリングの高度化**

**目的:** データの潜在的な関係性を引き出し、モデルの表現力を向上させる。

*   **2-1. 交互作用特徴量の体系的な導入:**
    *   **現状:** 騎手勝率や調教師勝率などは個別に計算されていますが、それらの組み合わせによる相乗効果（相性）は十分に捉えられていません。
    *   **提案:** 以下のような交互作用特徴量を体系的に生成します。これらは特に非線形モデルであるLightGBMと相性が良いです。
        *   **騎手 × 競馬場:** 特定の競馬場を得意とする騎手（例: 東京マイルのルメール騎手）。
        *   **騎手 × 距離カテゴリ:** 短距離専門、長距離専門の騎手。
        *   **種牡馬 × 競馬場/馬場状態:** 特定の条件下で好成績を収める産駒の傾向（例: 雨の日のキングカメハメハ産駒）。
        *   **枠番 × 脚質:** 逃げ馬が内枠に入った場合など。（※脚質の定義は後述）
    *   **実装:** `feature_engine.py` 内で、これらの組み合わせごとに過去の成績を集計（平均着順、勝率など）し、特徴量としてマージします。

*   **2-2. 脚質（Positioning Style）の定義と特徴量化:**
    *   **現状:** 通過順位はデータとして存在しますが、各馬の「脚質」（逃げ、先行、差し、追い込み）は明確に定義されていません。
    *   **提案:** 過去のレースの通過順位データ（`passing_order_*`）から、各馬の平均的なレース運びをクラスタリング（K-Meansなど）するか、単純なルールベースで「脚質カテゴリ」を定義します。例えば、「平均3コーナー順位が3番手以内なら先行」のように定義し、これをカテゴリ特徴量としてモデルに与えます。

*   **2-3. Embeddingの活用による高次元特徴量の獲得:**
    *   **現状:** `horse_id`, `jockey_id`, `sire_id` などのIDは、ターゲットエンコーディングや勝率計算に使われていますが、その潜在的な関係性は捉えきれていません。
    *   **提案:** 特に数の多い `horse_id` や `sire_id` に対して、Embedding層を持つニューラルネットワークを別途学習させ、低次元（例: 16次元や32次元）のベクトル表現を獲得します。このベクトルをLightGBMの入力特徴量として追加します。これにより、モデル自身が「似たタイプの馬」や「似た特徴を持つ種牡馬」を学習し、よりリッチな表現を獲得できます。
    *   **実装:** `PyTorch` や `TensorFlow/Keras` を用いて、馬のIDを入力とし、その馬の能力（平均着順など）を予測するような単純なモデルを学習させ、その中間層の重みを特徴量ベクトルとして抽出します。

*   **2-4. `features.yaml` の詳細化:**
    *   **現状:** 設定ファイルが非常に高レベルなスイッチにとどまっています。
    *   **提案:** 仕様書にあったように、`features.yaml` を拡張し、特徴量生成のロジックを詳細に制御できるようにします。
        ```yaml
        past_performance_aggregation:
          windows: [1, 3, 5, 10]  # 過去何走を見るか
          statistics: [mean, median, std, min, max] # どの統計量を計算するか
          columns: [finish_position, last_3f_time, margin_seconds] # どの指標を集計するか
        ```
    *   **実装:** `feature_engine.py` をリファクタリングし、このYAMLの設定を読み込んで動的にループを回し、特徴量を生成するように変更します。これにより、コードを変更せずに特徴量エンジニアリングの実験が可能になります。

##### **【提案3】モデルアーキテクチャと学習プロセスの改善**

**目的:** モデルの学習効率と予測性能を直接的に向上させる。

*   **3-1. ハイパーパラメータ最適化の導入:**
    *   **現状:** `configs/models.yaml` にハイパーパラメータが固定値で記述されていますが、これらが最適である保証はありません。
    *   **提案:** `Optuna` や `Hyperopt` などのハイパーパラメータ最適化ライブラリを導入し、定期的に（例: 月次バッチで）μ, σ, ν各モデルの最適なハイパーパラメータ（`num_leaves`, `learning_rate`など）を探索するプロセスを組み込みます。
    *   **実装:** `train_mu_model.py` などに `--optimize-hparams` のようなフラグを追加し、フラグが有効な場合に最適化ループを実行するようにします。

*   **3-2. 目的関数（損失関数）の工夫:**
    *   **現状:** μモデルのRankerは `lambdarank` を、Regressorは二乗誤差（L2損失）を、σ, νモデルも同様に回帰損失を使っていると推測されます。
    *   **提案:**
        *   **Focal Lossの導入:** 競馬予測は本質的に不均衡データ（1着は1頭、他はすべて負け）の問題です。特に万馬券のようなレアケースを予測したい場合、通常のLogLossでは多数派（負け）の学習に引っ張られがちです。分類問題（例: 1着になるかならないか）としてモデルを構築する際に、Focal Lossをカスタム損失関数として導入することで、「難しいサンプル（予測を間違えやすいサンプル）」に重点を置いて学習させ、大穴の予測精度を向上させる効果が期待できます。
        *   **順序情報の活用:** `finish_position` を単なる数値として回帰させるだけでなく、「順序を間違えること」に対するペナルティを考慮した損失関数（Rank-aware loss）を試す価値があります。「1着を2着と間違える」のと「1着を18着と間違える」のでは、後者の方が大きな間違いです。

*   **3-3. σ, νモデルの学習ターゲットの再検討:**
    *   **現状:** σモデルは予測誤差の二乗、νモデルは着順の標準偏差をターゲットにしています。
    *   **提案:** これらは妥当なアプローチですが、他の指標も試し、最もシミュレーション結果が改善するものを選択する価値があります。
        *   **σモデルのターゲット候補:** 予測誤差の絶対値、μモデルの予測確率の対数尤度など。
        *   **νモデルのターゲット候補:** レースの上位人気と下位人気の着順の相関、オッズのGini係数など、より直接的に「荒れ」を表現する指標。

##### **【提案4】MLOps（機械学習基盤）の導入**

**目的:** 実験の再現性を確保し、改善サイクルを高速化する。

*   **4-1. 実験管理ツールの導入:**
    *   **現状:** 学習済みモデルや特徴量はファイルとして保存されていますが、どの特徴量セットとどのハイパーパラメータで学習したモデルが、どれくらいの精度だったのか、という対応関係を追跡するのが困難です。
    *   **提案:** `MLflow` や `Weights & Biases (W&B)` のような実験管理ツールを導入します。これらのツールは無償で利用開始できます。
        *   **機能:**
            *   学習時のハイパーパラメータ、使用した特徴量リスト、Gitのコミットハッシュを自動で記録。
            *   Brier Score, ECE, NDCGなどの評価メトリクスを記録し、可視化。
            *   学習済みモデルファイル（`model.pkl`など）を成果物として保存。
    *   **実装:** `train_*.py` スクリプトに数行の `mlflow` ログ記録コードを追加するだけで、すべての実験がWeb UI上で管理できるようになります。

*   **4-2. データバージョニングの強化:**
    *   **現状:** 仕様書にはデータバージョニングの思想が記載されていますが、具体的なツールは明記されていません。
    *   **提案:** `DVC (Data Version Control)` を導入します。`DVC` はGitのように動作し、`data/parsed` や `data/features` といった巨大なデータファイルやモデルファイルを、Gitリポジトリを汚すことなくバージョン管理できます。
    *   **実装:** `dvc add data/features` のようなコマンドでデータのスナップショットを作成し、Gitでそのメタ情報を管理します。これにより、「あの時の特徴量セット」をいつでも正確に復元できるようになります。

#### **4. 改善の優先順位とロードマップ案**

提案した改善策を、モデル精度へのインパクトと実装の容易さの2軸で評価し、取り組むべき優先順位を以下に示します。

| 優先度 | 提案内容 | インパクト | 実装容易性 | 推奨フェーズ |
| :--- | :--- | :--- | :--- | :--- |
| **高** | **2-4. `features.yaml` の詳細化** | 高 | 中 | フェーズ1 |
| **高** | **3-1. ハイパーパラメータ最適化の導入** | 高 | 中 | フェーズ1 |
| **高** | **2-1. 交互作用特徴量の体系的な導入** | 高 | 中 | フェーズ2 |
| **中** | **4-1. 実験管理ツールの導入 (`MLflow`)** | 中 | 易 | フェーズ1 |
| **中** | **1-3. 騎手・調教師の乗り替わり情報のフラグ化** | 中 | 易 | フェーズ2 |
| **中** | **2-2. 脚質の定義と特徴量化** | 中 | 中 | フェーズ2 |
| **中** | **3-2. 目的関数（損失関数）の工夫** | 高 | 難 | フェーズ3 |
| **低** | **1-1/1-2. パドック・調教情報の取得** | 高 | 難 | フェーズ3 |
| **低** | **2-3. Embeddingの活用** | 高 | 難 | フェーズ3 |
| **低** | **4-2. データバージョニングの強化 (`DVC`)** | 中 | 中 | フェーズ2 |

**ロードマップ案:**

*   **フェーズ1（短期: 1-2ヶ月）:** まずは既存の資産を最大限に活かす改善から着手します。`features.yaml`を詳細化して実験の柔軟性を上げ、`Optuna`でハイパーパラメータを最適化するだけで、顕著な精度向上が見込めます。並行して`MLflow`を導入し、実験結果を記録する基盤を整えます。
*   **フェーズ2（中期: 3-6ヶ月）:** 次に、新たな知識をモデルに与える特徴量エンジニアリングに注力します。交互作用特徴量や脚質、乗り替わり情報などを追加します。`DVC`を導入してデータの再現性を担保するのもこの時期です。
*   **フェーズ3（長期: 6ヶ月〜）:** より高度な改善に挑戦します。Focal Lossなどのカスタム損失関数の実装や、Embeddingの活用、そして実装コストの高いパドック・調教情報のスクレイピングなど、さらなる精度向上を目指します。

#### **5. まとめ**

本AI競馬予測システムは、その設計思想とアーキテクチャにおいて、すでに非常に高いレベルにあります。μ, σ, νを個別にモデル化するアプローチは、競馬予測の複雑性を見事に捉えており、大きなポテンシャルを秘めています。

本レポートで提案した改善策は、この強固な基盤の上に、さらなる精度向上を積み上げるためのものです。特に、**特徴量エンジニアリングの柔軟性向上（提案2-4）**と**ハイパーパラメータの最適化（提案3-1）**は、比較的少ない労力で大きな効果が期待できるため、最優先で取り組むことを推奨します。

これらの改善を通じて、本システムが市場の非効率性を見つけ出し、より高い投資収益率を達成する強力なツールへと進化していくことを確信しております。

この度は貴重な機会をいただき、ありがとうございました。本レポートが、今後の開発の一助となれば幸いです。ご不明な点があれば、いつでもお気軽にご質問ください。

### 19. 付録：データテーブル仕様 (2025-11-16時点の実装状況)

**注:** 以下のスキーマは、ソースコード分析に基づき、現在のパイプラインで実際に生成されているカラムを反映したものです。

### 19.1 `races.parquet`（レース結果データ）

**主キー**: `race_id` + `horse_id`

| カラム名 | データ型 | Nullable | 説明 | 実装状況 |
|:---|:---|:---|:---|:---|
| `race_id` | string | No | レースID (YYYYPPNNDDRR形式) | ✅ 実装済み |
| `race_date` | date | No | レース開催日 (YYYY-MM-DD) | ✅ 実装済み |
| `finish_position` | Int64 | Yes | 着順。中止や除外の場合はNone。 | ✅ 実装済み |
| `bracket_number` | Int64 | Yes | 枠番 | ✅ 実装済み |
| `horse_number` | Int64 | Yes | 馬番 | ✅ 実装済み |
| `horse_id` | string | No | 馬ID (netkeiba) | ✅ 実装済み |
| `horse_name` | string | Yes | 馬名 | ✅ 実装済み |
| `sex` | string | Yes | 性別（牡/牝/セ） | ✅ 実装済み |
| `age` | Int64 | Yes | 年齢 | ✅ 実装済み |
| `basis_weight` | float64 | Yes | 斤量(kg) | ✅ 実装済み |
| `jockey_id` | string | Yes | 騎手ID | ✅ 実装済み |
| `jockey_name` | string | Yes | 騎手名 | ✅ 実装済み |
| `finish_time_seconds`| float64 | Yes | 走破タイム (秒) | ✅ 実装済み |
| `margin_seconds` | float64 | Yes | 1着とのタイム差 (秒) | ✅ 実装済み |
| `passing_order_1` | Int64 | Yes | 第1コーナー通過順位 | ✅ 実装済み |
| `passing_order_2` | Int64 | Yes | 第2コーナー通過順位 | ✅ 実装済み |
| `passing_order_3` | Int64 | Yes | 第3コーナー通過順位 | ✅ 実装済み |
| `passing_order_4` | Int64 | Yes | 第4コーナー通過順位 | ✅ 実装済み |
| `last_3f_time` | float64 | Yes | 上がり3ハロンタイム (秒) | ✅ 実装済み |
| `win_odds` | float64 | Yes | 単勝オッズ | ✅ 実装済み |
| `popularity` | Int64 | Yes | 人気順 | ✅ 実装済み |
| `horse_weight` | Int64 | Yes | 馬体重(kg) | ✅ 実装済み |
| `horse_weight_change`| Int64 | Yes | 馬体重増減(kg) | ✅ 実装済み |
| `trainer_id` | string | Yes | 調教師ID | ✅ 実装済み |
| `trainer_name` | string | Yes | 調教師名 | ✅ 実装済み |
| `owner_name` | string | Yes | 馬主名 | ✅ 実装済み |
| `prize_money` | Int64 | Yes | 獲得賞金（1着のみ、万円） | ✅ 実装済み |
| **(レースメタデータ)** | | | (以下は全行で共通) | |
| `distance_m` | Int64 | Yes | 距離(m) | ✅ 実装済み |
| `track_surface` | string | Yes | 馬場種別（芝/ダート/障害） | ✅ 実装済み |
| `weather` | string | Yes | 天候 | ✅ 実装済み |
| `track_condition` | string | Yes | 馬場状態 | ✅ 実装済み |
| `post_time` | string | Yes | 発走時刻 (HH:MM) | ✅ 実装済み |
| `race_name` | string | Yes | レース名 | ✅ 実装済み |
| `race_class` | string | Yes | レースクラス（G1/OP/未勝利など） | ✅ 実装済み |
| `venue` | string | Yes | 競馬場名 | ✅ 実装済み |
| `day_of_meeting` | Int64 | Yes | 開催日目 | ✅ 実装済み |
| `round_of_year` | Int64 | Yes | 開催回数 | ✅ 実装済み |
| `prize_1st` | Int64 | Yes | 1着賞金（万円） | ✅ 実装済み |
| `prize_2nd` | Int64 | Yes | 2着賞金（万円） | ✅ 実装済み |
| `prize_3rd` | Int64 | Yes | 3着賞金（万円） | ✅ 実装済み |
| `prize_4th` | Int64 | Yes | 4着賞金（万円） | ✅ 実装済み |
| `prize_5th` | Int64 | Yes | 5着賞金（万円） | ✅ 実装済み |
| **(派生特徴量)** | | | (results_parser内で生成) | |
| `time_except_last3f` | float64 | Yes | 上がり3Fを除いたタイム | ✅ 実装済み |
| `pace_index` | float64 | Yes | ペース指数 (前半/後半) | ✅ 実装済み |
| `last3f_rank` | float64 | Yes | レース内での上がり3F順位 | ✅ 実装済み |
| `position_change_*`| Int64 | Yes | コーナー間の順位変動 | ✅ 実装済み |
| `final_corner_to_finish`| Int64 | Yes | 最終コーナーから着順への変動 | ✅ 実装済み |
| `horse_weight_deviation`| float64 | Yes | レース内での馬体重の偏差値 | ✅ 実装済み |
| `popularity_finish_diff`| Int64 | Yes | 人気と着順の乖離 | ✅ 実装済み |
| `win_probability` | float64 | Yes | オッズから計算した単勝確率 | ✅ 実装済み |
| `distance_category` | category | Yes | 距離区分 (sprint, mileなど) | ✅ 実装済み |

### 19.2 `shutuba.parquet`（出馬表データ）

| カラム名 | データ型 | Nullable | 説明 | 実装状況 |
|:---|:---|:---|:---|:---|
| `race_id` | string | No | レースID | ✅ 実装済み |
| `race_date` | date | Yes | レース開催日 | ✅ 実装済み |
| `bracket_number` | Int64 | Yes | 枠番 | ✅ 実装済み |
| `horse_number` | Int64 | Yes | 馬番 | ✅ 実装済み |
| `horse_id` | string | No | 馬ID | ✅ 実装済み |
| `horse_name` | string | Yes | 馬名 | ✅ 実装済み |
| `sex` | string | Yes | 性別 | ✅ 実装済み |
| `age` | Int64 | Yes | 年齢 | ✅ 実装済み |
| `basis_weight` | float64 | Yes | 斤量(kg) | ✅ 実装済み |
| `jockey_id` | string | Yes | 騎手ID | ✅ 実装済み |
| `jockey_name` | string | Yes | 騎手名 | ✅ 実装済み |
| `trainer_id` | string | Yes | 調教師ID | ✅ 実装済み |
| `trainer_name` | string | Yes | 調教師名 | ✅ 実装済み |
| `horse_weight` | Int64 | Yes | **前走**の馬体重(kg) | ✅ 実装済み |
| `horse_weight_change`| Int64 | Yes | **前走**の馬体重増減(kg) | ✅ 実装済み |
| `morning_odds` | float64 | Yes | 前日/当日朝オッズ | ✅ 実装済み |
| `morning_popularity` | Int64 | Yes | 前日/当日朝人気 | ✅ 実装済み |
| `scratched` | boolean | No | 取消フラグ (True/False) | ✅ 実装済み |
| `owner_name` | None | Yes | 馬主名（出馬表からは取得不可） | ❌ 未実装 |
| `prize_total` | None | Yes | 総獲得賞金（出馬表からは取得不可） | ❌ 未実装 |
| `career_stats` | None | Yes | 通算戦績（出馬表からは取得不可） | ❌ 未実装 |

### 19.3 `horses.parquet`（馬プロフィールデータ）

| カラム名 | データ型 | Nullable | 説明 | 実装状況 |
|:---|:---|:---|:---|:---|
| `horse_id` | string | No | 馬ID | ✅ 実装済み |
| `horse_name` | string | Yes | 馬名 | ✅ 実装済み |
| `birth_date` | date | Yes | 生年月日 | ✅ 実装済み |
| `trainer_id` | string | Yes | (現在の)調教師ID | ✅ 実装済み |
| `trainer_name` | string | Yes | (現在の)調教師名 | ✅ 実装済み |
| `owner_name` | string | Yes | (現在の)馬主名 | ✅ 実装済み |
| `breeder_name` | string | Yes | 生産者名 | ✅ 実装済み |
| `producing_area` | string | Yes | 生産地 | ✅ 実装済み |
| `sex` | string | Yes | 性別 | ✅ 実装済み |
| `coat_color` | string | Yes | 毛色 | ✅ 実装済み |
| `sire_id` | string | Yes | 父馬ID | ✅ 実装済み |
| `sire_name` | string | Yes | 父馬名 | ✅ 実装済み |
| `dam_id` | string | Yes | 母馬ID | ✅ 実装済み |
| `dam_name` | string | Yes | 母馬名 | ✅ 実装済み |
| `damsire_id` | string | Yes | 母父ID | ✅ 実装済み |
| `damsire_name` | string | Yes | 母父名 | ✅ 実装済み |

### 19.4 `pedigrees.parquet`（血統データ）

| カラム名 | データ型 | Nullable | 説明 | 実装状況 |
|:---|:---|:---|:---|:---|
| `horse_id` | string | No | 対象の馬ID | ✅ 実装済み |
| `ancestor_id` | string | No | 祖先の馬ID | ✅ 実装済み |
| `ancestor_name` | string | Yes | 祖先の馬名 | ✅ 実装済み |
| `generation` | Int64 | No | 世代 (1:親, 2:祖父母, ... 5:5代前) | ✅ 実装済み |

### 19.5 `features.parquet`（特徴量データ）

**主キー**: `race_id` + `horse_id`
**パーティション**: `year=YYYY/month=MM/`

| カテゴリ | カラム例 | 実装状況 |
|:---|:---|:---|
| 基本特徴量 | `age`, `basis_weight`, `sex_牡`, `track_芝`, `bracket_is_inner` | ✅ 実装済み |
| 過去成績集約 | `past_1_finish_position_mean`, `past_3_last_3f_time_mean`, `career_win_rate`, `days_since_last_race` | ✅ 実装済み |
| 騎手・調教師特徴 | `jockey_win_rate`, `trainer_win_rate` | ✅ 実装済み |
| 血統特徴量 | `sire_target_encoding` | ✅ 実装済み |
| レース内相対特徴 | `horse_weight_zscore`, `basis_weight_zscore` | ✅ 実装済み |
| コース適性 | `venue_avg_finish`, `distance_cat_avg_finish` | ❌ 未実装 |
| 騎手と調教師の相性 | `combo_win_rate` | ❌ 未実装 |
| 高度な血統特徴 | `sire_distance_affinity` | ❌ 未実装 |

### **【追加調査項目】パーサーの不安定性に関する問題**

*   **問題の概要:**
    *   特定の条件下、特に障害レースにおいて、`results_parser.py` がレースの距離(`distance_m`)を誤ってパースする問題が確認されています。
    *   例として、`race_id: 202305040304` のレースにおいて、`distance_m` が `3` という異常な値でパースされるケースが報告されています。
*   **現状と課題:**
    *   この問題は、パーサーの正規表現が、障害レース特有のHTML構造（例：「3号障害」など）を誤って解釈している可能性を示唆しています。
    *   しかし、原因究明に不可欠な `race_id: 202305040304` に対応するHTMLファイルが、現在のローカルデータセット内に見当たりません。
*   **今後の対応:**
    *   この問題は、根本原因の調査に必要なデータが不足しているため、一旦調査を保留します。
    *   他の優先度の高い修正が完了した後、対象のHTMLファイルを入手、あるいはデバッグコードを追加するなどの方法で、再度調査を行います。

#### **6. 特徴量生成パイプラインのリファクタリングと現状のまとめ (2025-11-17)**

##### **6.1. 目的**

`features.yaml` をレシピベースの柔軟な設定ファイルとして機能させ、特徴量生成の試行錯誤と再現性を向上させることを目的として、関連モジュールのリファクタリングを実施しました。

##### **6.2. 実施した変更点**

1.  **`keibaai/configs/features.yaml` の刷新:**
    特徴量カテゴリごとの有効/無効スイッチのみだった旧来の構造から、特徴量の生成方法（集計対象、集計期間、集計方法など）を詳細に記述できる「レシピ形式」に全面的に刷新しました。

2.  **`keibaai/src/features/feature_engine.py` の全面リファクタリング:**
    ハードコーディングされていた特徴量生成ロジックを廃止し、新しい `features.yaml` のレシピを解釈して動的に特徴量を生成する汎用的なエンジンとして再設計しました。

3.  **`keibaai/src/features/generate_features.py` の修正:**
    新しい `FeatureEngine` を正しく呼び出せるように、インスタンス化の方法と引数を修正し、ロギングの不具合も修正しました。

4.  **`keibaai/src/modules/parsers/horse_info_parser.py` のバグ修正:**
    馬のプロフィール情報から血統情報 (`sire_id`, `damsire_id`) を抽出するロジックに存在したタイポを修正し、より堅牢な抽出ロジックに改善しました。

##### **6.3. 現状の課題と今後の方向性**

*   **課題:**
    *   `horse_info_parser.py`の修正は完了しましたが、その変更を反映するための**パース処理の再実行は実施していません**。
    *   そのため、現在 `data/parsed/` に存在する `horses.parquet` には依然として**血統情報が含まれていません**。
    *   同様に、`races.parquet` には `passing_order_*` （コーナー通過順位）などの、特徴量生成に必要な一部のカラムが欠落している可能性があります。

*   **今後の方向性:**
    *   これ以上のスクレイピングや個別のパース処理は不要であるとの認識に基づき、アプローチを切り替えます。
    *   次のステップとして、**現在 `data/parsed/` に存在する各Parquetファイル（`races.parquet`, `shutuba.parquet`, `horses.parquet`）を結合し、分析に必要なすべての情報（血統、通過順位、過去成績など）を網羅した単一の「分析用ベーステーブル」を作成する**必要があります。
    *   このベーステーブルをリファクタリング済みの `FeatureEngine` への入力とすることで、`features.yaml` に記述したレシピ通りの特徴量生成が正しく機能するようになります。