# ç‰¹å¾´é‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼è¨ºæ–­ãƒ¬ãƒãƒ¼ãƒˆ

**ä½œæˆæ—¥**: 2025-11-17
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: KeibaAI_v2 - ç«¶é¦¬äºˆæ¸¬AIã‚·ã‚¹ãƒ†ãƒ 
**å¯¾è±¡**: ãƒ¢ãƒ‡ãƒ«ç²¾åº¦æ”¹å–„ä½œæ¥­ä¸­ã®ç‰¹å¾´é‡ç”Ÿæˆã‚¨ãƒ©ãƒ¼
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ğŸ” è¨ºæ–­å®Œäº† â†’ å¯¾ç­–ç‰¹å®šæ¸ˆã¿

---

## ğŸ“‹ ç›®æ¬¡

1. [èƒŒæ™¯ã¨ç›®çš„](#èƒŒæ™¯ã¨ç›®çš„)
2. [ç™ºç”Ÿã—ãŸå•é¡Œ](#ç™ºç”Ÿã—ãŸå•é¡Œ)
3. [å®Ÿæ–½ã—ãŸèª¿æŸ»å†…å®¹](#å®Ÿæ–½ã—ãŸèª¿æŸ»å†…å®¹)
4. [è¨ºæ–­çµæœ](#è¨ºæ–­çµæœ)
5. [æ ¹æœ¬åŸå› ](#æ ¹æœ¬åŸå› )
6. [å¯¾ç­–æ¡ˆ](#å¯¾ç­–æ¡ˆ)
7. [æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—](#æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—)
8. [å‚è€ƒè³‡æ–™](#å‚è€ƒè³‡æ–™)

---

## ğŸ¯ èƒŒæ™¯ã¨ç›®çš„

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

KeibaAI_v2ã¯ã€ç«¶é¦¬ãƒ¬ãƒ¼ã‚¹ã®çµæœã‚’äºˆæ¸¬ã—ã€æœ€é©ãªæŠ•è³‡ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªã‚’æ§‹ç¯‰ã™ã‚‹AIã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

**ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³**:
```
HTMLåé›† â†’ ãƒ‘ãƒ¼ã‚¹ â†’ ç‰¹å¾´é‡ç”Ÿæˆ â†’ ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ â†’ äºˆæ¸¬ â†’ æœ€é©åŒ–
```

### ä½œæ¥­ã®ç›®çš„

ãƒ¢ãƒ‡ãƒ«ç²¾åº¦æ”¹å–„ã®ãŸã‚ã€ä»¥ä¸‹ã®ä½œæ¥­ã‚’å®Ÿæ–½ä¸­ã§ã—ãŸ:

1. âœ… è¡€çµ±ãƒ‡ãƒ¼ã‚¿ã®è£œå®Œï¼ˆå®Œäº†æ¸ˆã¿: sire_id/dam_idæ¬ æç‡ 85.79% â†’ 0.01%ï¼‰
2. âœ… ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„æ–¹é‡ã®æ˜ç¢ºåŒ–ï¼ˆå®Œäº†æ¸ˆã¿ï¼‰
3. ğŸ”„ **ç‰¹å¾´é‡ç”Ÿæˆã®å®Ÿè¡Œã¨ã‚¨ãƒ©ãƒ¼å¯¾å¿œ** â† æœ¬ãƒ¬ãƒãƒ¼ãƒˆã®å¯¾è±¡

### å®Ÿæ–½ã—ãŸã‚³ãƒãƒ³ãƒ‰

```bash
python keibaai/src/features/generate_features.py --start_date 2020-01-01 --end_date 2020-12-31
```

---

## âŒ ç™ºç”Ÿã—ãŸå•é¡Œ

### å•é¡Œã®æ¦‚è¦

ç‰¹å¾´é‡ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œä¸­ã«ã€**è¤‡æ•°ã®ã‚«ãƒ©ãƒ ãŒè¦‹ã¤ã‹ã‚‰ãªã„**ã¨ã„ã†è­¦å‘Šï¼ˆKeyErrorï¼‰ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚

### ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

```
KeyError: "['passing_order_1', 'passing_order_4'] not in index"
KeyError: "['venue'] not in index"
KeyError: "['distance_category'] not in index"
KeyError: "['track_surface'] not in index"
KeyError: "['damsire_id'] not in index"
```

### å½±éŸ¿ç¯„å›²

- **éå»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹å¾´é‡**: `passing_order_1`, `passing_order_4` ãŒå¿…è¦
- **äº¤äº’ä½œç”¨ç‰¹å¾´é‡**: `venue`, `track_surface`, `distance_category` ãŒå¿…è¦
- **è¡€çµ±ç‰¹å¾´é‡**: `damsire_id` ãŒå¿…è¦

ã“ã‚Œã‚‰ã®ã‚«ãƒ©ãƒ ãŒæ¬ æã—ã¦ã„ã‚‹ã“ã¨ã§ã€**ä¸€éƒ¨ã®ç‰¹å¾´é‡ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ**ã€‚

### ç”Ÿæˆçµæœ

- âœ… 72å€‹ã®ç‰¹å¾´é‡ã¯ç”ŸæˆæˆåŠŸ
- âš ï¸ äº¤äº’ä½œç”¨ç‰¹å¾´é‡ï¼ˆ6å€‹ï¼‰ã¯ç”Ÿæˆå¤±æ•—ã®å¯èƒ½æ€§
- âš ï¸ éå»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹å¾´é‡ã®ä¸€éƒ¨ãŒä¸å®Œå…¨

---

## ğŸ” å®Ÿæ–½ã—ãŸèª¿æŸ»å†…å®¹

### èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚º1: morning_oddså•é¡Œã®è§£æ±ºï¼ˆå‰æ®µéšï¼‰

ç‰¹å¾´é‡ç”Ÿæˆã®å‰ã«ã€`morning_odds` / `morning_popularity` ãŒ100%æ¬ æã—ã¦ã„ã‚‹å•é¡Œã‚’èª¿æŸ»ã—ã¾ã—ãŸã€‚

**çµè«–**:
- shutuba.parquetï¼ˆå‡ºé¦¬è¡¨ï¼‰ã®HTMLã«ã¯ã€ãã‚‚ãã‚‚ã‚ªãƒƒã‚ºæƒ…å ±ãŒå«ã¾ã‚Œã¦ã„ãªã„
- è©•ä¾¡ãƒ»é‹ç”¨æ™‚ã¯ races.parquet ã® `win_odds` / `popularity` ã‚’ä½¿ç”¨
- å­¦ç¿’æ™‚ã¯ã‚ªãƒƒã‚ºã‚’ä½¿ç”¨ã—ãªã„ï¼ˆfeatures.yaml ã§é™¤å¤–æ¸ˆã¿ï¼‰

### èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚º2: ç‰¹å¾´é‡ç”Ÿæˆã®è¨ºæ–­ãƒ„ãƒ¼ãƒ«ä½œæˆ

æ¬ æã‚«ãƒ©ãƒ ã®åŸå› ã‚’ç‰¹å®šã™ã‚‹ãŸã‚ã€4ã¤ã®è¨ºæ–­ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ:

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç›®çš„ |
|-----------|------|
| `diagnose_missing_features.py` | **åŒ…æ‹¬çš„è¨ºæ–­ãƒ„ãƒ¼ãƒ«**ï¼ˆæ¨å¥¨ï¼‰ |
| `check_races_schema.py` | races.parquetã®ã‚¹ã‚­ãƒ¼ãƒç¢ºèª |
| `check_pedigrees_schema.py` | è¡€çµ±ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®ç¢ºèª |
| `validate_generated_features.py` | ç”Ÿæˆæ¸ˆã¿ç‰¹å¾´é‡ã®æ¤œè¨¼ |

### èª¿æŸ»ãƒ•ã‚§ãƒ¼ã‚º3: è¨ºæ–­ãƒ„ãƒ¼ãƒ«ã®å®Ÿè¡Œ

```bash
python diagnose_missing_features.py
```

**å®Ÿè¡Œçµæœ**:
- races.parquet: 13,844è¡Œ Ã— 29åˆ—
- pedigrees.parquet: 415,412è¡Œ
- horses.parquet: 7,035è¡Œï¼ˆsire_id, dam_id ã¯å­˜åœ¨ã€æ¬ æ0%ï¼‰

---

## ğŸ“Š è¨ºæ–­çµæœ

### è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼

#### 1. races.parquetã®æ¬ æã‚«ãƒ©ãƒ 

| ã‚«ãƒ©ãƒ  | å¿…è¦æ€§ | ç¾çŠ¶ |
|--------|--------|------|
| `passing_order_1` | éå»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹å¾´é‡ã«å¿…è¦ | âŒ **å­˜åœ¨ã—ãªã„** |
| `passing_order_2` | åŒä¸Š | âŒ **å­˜åœ¨ã—ãªã„** |
| `passing_order_3` | åŒä¸Š | âŒ **å­˜åœ¨ã—ãªã„** |
| `passing_order_4` | åŒä¸Š | âŒ **å­˜åœ¨ã—ãªã„** |
| `venue` | äº¤äº’ä½œç”¨ç‰¹å¾´é‡ã«å¿…è¦ | âŒ **å­˜åœ¨ã—ãªã„** |
| `track_surface` | äº¤äº’ä½œç”¨ç‰¹å¾´é‡ã«å¿…è¦ | âŒ **å­˜åœ¨ã—ãªã„** |
| `distance_m` | distance_categoryç”Ÿæˆã«å¿…è¦ | âŒ **å­˜åœ¨ã—ãªã„** |
| `weather` | ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± | âŒ **å­˜åœ¨ã—ãªã„** |
| `track_condition` | ãƒ¬ãƒ¼ã‚¹åŸºæœ¬æƒ…å ± | âŒ **å­˜åœ¨ã—ãªã„** |

#### 2. races.parquetã®æ—¢å­˜ã‚«ãƒ©ãƒ 

| ã‚«ãƒ©ãƒ  | å½¢å¼ | å‚™è€ƒ |
|--------|------|------|
| `passing_order` | "5-5-3-3" | âœ… å­˜åœ¨ï¼ˆæœªåˆ†å‰²çŠ¶æ…‹ï¼‰ |

`passing_order` ã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ã¾ã™ãŒã€`passing_order_1`, `passing_order_2`, `passing_order_3`, `passing_order_4` ã«åˆ†å‰²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

#### 3. æ´¾ç”Ÿç‰¹å¾´é‡ã®æ¬ æ

| ã‚«ãƒ©ãƒ  | ç¨®é¡ | ç”Ÿæˆå…ƒ | ç¾çŠ¶ |
|--------|------|--------|------|
| `distance_category` | æ´¾ç”Ÿç‰¹å¾´é‡ | `distance_m` ã‹ã‚‰ç”Ÿæˆ | âŒ **æœªç”Ÿæˆ** |
| `damsire_id` | è¨ˆç®—å€¤ | pedigrees.parquet ã‹ã‚‰è¨ˆç®— | âŒ **æœªç”Ÿæˆ** |

#### 4. è¡€çµ±ãƒ‡ãƒ¼ã‚¿ã®çŠ¶æ³

| ã‚«ãƒ©ãƒ  | ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ | ç¾çŠ¶ |
|--------|--------------|------|
| `sire_id` | horses.parquet | âœ… å­˜åœ¨ï¼ˆæ¬ æ0%ï¼‰ |
| `dam_id` | horses.parquet | âœ… å­˜åœ¨ï¼ˆæ¬ æ0%ï¼‰ |
| `damsire_id` | horses.parquet | âŒ **å­˜åœ¨ã—ãªã„** |

`damsire_id` ã¯ã€`pedigrees.parquet` ã‹ã‚‰ `dam_id` ã®çˆ¶ï¼ˆæ¯çˆ¶ï¼‰ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ã§ç”Ÿæˆå¯èƒ½ã§ã™ã€‚

---

## ğŸ” æ ¹æœ¬åŸå› 

### åŸå› ã®ç‰¹å®š

#### ç™ºè¦‹1: ãƒ‘ãƒ¼ã‚µãƒ¼ã¯æ—¢ã«ä¿®æ­£æ¸ˆã¿

`keibaai/src/modules/parsers/results_parser.py` ã‚’ç¢ºèªã—ãŸã¨ã“ã‚ã€**å¿…è¦ãªã‚«ãƒ©ãƒ ã¯ã™ã¹ã¦å®Ÿè£…æ¸ˆã¿**ã§ã—ãŸã€‚

**å®Ÿè£…æ¸ˆã¿ã®æ©Ÿèƒ½**:

| æ©Ÿèƒ½ | å®Ÿè£…ç®‡æ‰€ | å®Ÿè£…å†…å®¹ |
|------|---------|---------|
| `distance_m` | line 153 | è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ã®æŠ½å‡º |
| `track_surface` | line 152 | é¦¬å ´ç¨®åˆ¥ï¼ˆèŠ/ãƒ€ãƒ¼ãƒˆ/éšœå®³ï¼‰ã®æŠ½å‡º |
| `venue` | line 228 | ç«¶é¦¬å ´åã®æŠ½å‡º |
| `passing_order_1~4` | line 279-288 | é€šéé †ä½ã®åˆ†å‰²å‡¦ç† |
| `weather` | line 158 | å¤©å€™ã®æŠ½å‡º |
| `track_condition` | line 163 | é¦¬å ´çŠ¶æ…‹ã®æŠ½å‡º |

**passing_orderã®åˆ†å‰²å‡¦ç†**ï¼ˆline 279-288ï¼‰:
```python
# é€šéé †ä½ï¼ˆåˆ†å‰²ç‰ˆï¼‰
passing_str = cells[10].get_text(strip=True)
if passing_str:
    corners = passing_str.split('-')  # "5-5-3-3" â†’ ['5','5','3','3']
    for i in range(4):
        col_name = f'passing_order_{i+1}'
        if i < len(corners):
            row_data[col_name] = parse_int_or_none(corners[i])
```

#### ç™ºè¦‹2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒå¤ã„

**ç¾åœ¨ã®races.parquetã¯ã€å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã§ç”Ÿæˆã•ã‚ŒãŸã‚‚ã®ã§ã™ã€‚**

**æ ¹æœ¬åŸå› **:
```
ãƒ‘ãƒ¼ã‚µãƒ¼ä¿®æ­£æ¸ˆã¿ â‰  ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°æ¸ˆã¿
```

ãƒ‘ãƒ¼ã‚µãƒ¼ã®ã‚³ãƒ¼ãƒ‰ã¯æœ€æ–°ã§ã™ãŒã€**races.parquetãŒå†ç”Ÿæˆã•ã‚Œã¦ã„ãªã„**ãŸã‚ã€æ–°ã—ã„ã‚«ãƒ©ãƒ ãŒå«ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚

### ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³æ¨å®š

| æ™‚æœŸ | å‡ºæ¥äº‹ | è¨¼æ‹  |
|------|--------|------|
| éå» | åˆæœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã§races.parquetã‚’ç”Ÿæˆ | races.parquetã«29åˆ—ã®ã¿ |
| æœ€è¿‘ | results_parser.pyã‚’æ‹¡å¼µç‰ˆã«æ›´æ–° | CLAUDE.mdã«è¨˜è¼‰ã‚ã‚Š |
| æœ€è¿‘ | è¡€çµ±ãƒ‡ãƒ¼ã‚¿è£œå®Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ | sire_id/dam_idæ¬ ææ”¹å–„ |
| **ç¾åœ¨** | **races.parquetã¯æœªæ›´æ–°ã®ã¾ã¾** | â† ä»Šå›ã®å•é¡Œ |

---

## ğŸ’¡ å¯¾ç­–æ¡ˆ

### å¯¾ç­–ã®å…¨ä½“åƒ

å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã¯ã€**2ã‚¹ãƒ†ãƒƒãƒ—**ãŒå¿…è¦ã§ã™:

```
ã‚¹ãƒ†ãƒƒãƒ—1: races.parquetã®å†ãƒ‘ãƒ¼ã‚¹ï¼ˆæœ€å„ªå…ˆï¼‰
          â†“
ã‚¹ãƒ†ãƒƒãƒ—2: æ´¾ç”Ÿç‰¹å¾´é‡ã®ç”Ÿæˆï¼ˆå†ãƒ‘ãƒ¼ã‚¹å¾Œï¼‰
```

---

### ã‚¹ãƒ†ãƒƒãƒ—1: races.parquetã®å†ãƒ‘ãƒ¼ã‚¹ ğŸš¨ **æœ€å„ªå…ˆ**

#### å®Ÿæ–½å†…å®¹

ä¿®æ­£æ¸ˆã¿ã®ãƒ‘ãƒ¼ã‚µãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã€HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ãƒ‘ãƒ¼ã‚¹ã—ã€races.parquetã‚’æ›´æ–°ã—ã¾ã™ã€‚

#### å®Ÿè¡Œã‚³ãƒãƒ³ãƒ‰

```bash
python keibaai/src/run_parsing_pipeline_local.py
```

#### æœŸå¾…ã•ã‚Œã‚‹çµæœ

å†ãƒ‘ãƒ¼ã‚¹å¾Œã€races.parquetã«ä»¥ä¸‹ã®ã‚«ãƒ©ãƒ ãŒè¿½åŠ ã•ã‚Œã¾ã™:

**è¿½åŠ ã•ã‚Œã‚‹ã‚«ãƒ©ãƒ ** (9å€‹):
- âœ… `distance_m` (è·é›¢)
- âœ… `track_surface` (é¦¬å ´ç¨®åˆ¥)
- âœ… `venue` (ç«¶é¦¬å ´)
- âœ… `passing_order_1` (1ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½)
- âœ… `passing_order_2` (2ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½)
- âœ… `passing_order_3` (3ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½)
- âœ… `passing_order_4` (4ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½)
- âœ… `weather` (å¤©å€™)
- âœ… `track_condition` (é¦¬å ´çŠ¶æ…‹)

#### æ¤œè¨¼æ–¹æ³•

å†ãƒ‘ãƒ¼ã‚¹å®Œäº†å¾Œã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ç¢ºèª:

```bash
python check_races_schema.py
```

æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›:
```
âœ… distance_m       å­˜åœ¨ (æ¬ æ: 0.0%)
âœ… track_surface    å­˜åœ¨ (æ¬ æ: 0.0%)
âœ… venue            å­˜åœ¨ (æ¬ æ: 0.0%)
âœ… passing_order_1  å­˜åœ¨ (æ¬ æ: XX.X%)
âœ… passing_order_4  å­˜åœ¨ (æ¬ æ: XX.X%)
```

---

### ã‚¹ãƒ†ãƒƒãƒ—2: æ´¾ç”Ÿç‰¹å¾´é‡ã®ç”Ÿæˆ

ã‚¹ãƒ†ãƒƒãƒ—1ã®å®Œäº†å¾Œã€ä»¥ä¸‹ã®2ã¤ã®æ´¾ç”Ÿç‰¹å¾´é‡ã‚’è¿½åŠ ã—ã¾ã™ã€‚

#### 2-1. distance_category ã®ç”Ÿæˆ

**ç›®çš„**: `distance_m` ã‹ã‚‰è·é›¢ã‚«ãƒ†ã‚´ãƒªã‚’ç”Ÿæˆ

**å®Ÿè£…å ´æ‰€**: `keibaai/src/modules/features/feature_engine.py`

**å®Ÿè£…ä¾‹**:
```python
def create_distance_category(df):
    """
    è·é›¢(m)ã‹ã‚‰è·é›¢ã‚«ãƒ†ã‚´ãƒªã‚’ç”Ÿæˆ

    - çŸ­è·é›¢: ~1400m
    - ãƒã‚¤ãƒ«: 1401-1800m
    - ä¸­è·é›¢: 1801-2200m
    - é•·è·é›¢: 2201m~
    """
    conditions = [
        df['distance_m'] <= 1400,
        (df['distance_m'] > 1400) & (df['distance_m'] <= 1800),
        (df['distance_m'] > 1800) & (df['distance_m'] <= 2200),
        df['distance_m'] > 2200
    ]
    choices = ['çŸ­è·é›¢', 'ãƒã‚¤ãƒ«', 'ä¸­è·é›¢', 'é•·è·é›¢']
    df['distance_category'] = pd.NA

    for i, condition in enumerate(conditions):
        df.loc[condition, 'distance_category'] = choices[i]

    df['distance_category'] = df['distance_category'].astype('category')
    return df
```

#### 2-2. damsire_id ã®ç”Ÿæˆ

**ç›®çš„**: æ¯çˆ¶ï¼ˆæ¯ã®çˆ¶ï¼‰ã®IDã‚’è¨ˆç®—

**å®Ÿè£…å ´æ‰€**: `keibaai/src/modules/features/feature_engine.py`

**ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**:
```
horses.parquet
  â”œâ”€ horse_id
  â”œâ”€ dam_id  â”€â”
  â””â”€ ...      â”‚
              â”‚ (ãƒãƒ¼ã‚¸)
              â†“
pedigrees.parquet
  â”œâ”€ horse_id (= dam_id)
  â”œâ”€ ancestor_id (â†’ damsire_id)
  â””â”€ generation (= 1, çˆ¶å´ã®ã¿)
```

**å®Ÿè£…ä¾‹**:
```python
def add_damsire_id(df, horses_df, pedigrees_df):
    """
    æ¯çˆ¶IDã‚’è¿½åŠ 

    Args:
        df: ç‰¹å¾´é‡DataFrame
        horses_df: horses.parquet
        pedigrees_df: pedigrees.parquet

    Returns:
        damsire_id ãŒè¿½åŠ ã•ã‚ŒãŸ DataFrame
    """
    # æ¯ã®è¡€çµ±æƒ…å ±ã‚’å–å¾—ï¼ˆæ¯ã®çˆ¶ = æ¯çˆ¶ï¼‰
    dam_pedigrees = pedigrees_df[pedigrees_df['generation'] == 1].copy()
    dam_pedigrees = dam_pedigrees.rename(columns={
        'horse_id': 'dam_id',
        'ancestor_id': 'damsire_id'
    })

    # horse_id â†’ dam_id ã®ãƒãƒ¼ã‚¸
    df = df.merge(horses_df[['horse_id', 'dam_id']], on='horse_id', how='left')

    # dam_id â†’ damsire_id ã®ãƒãƒ¼ã‚¸
    df = df.merge(dam_pedigrees[['dam_id', 'damsire_id']], on='dam_id', how='left')

    return df
```

**æ³¨æ„ç‚¹**:
- pedigrees.parquetã®æ§‹é€ ã‚’äº‹å‰ã«ç¢ºèªãŒå¿…è¦
- generationåˆ—ã®å€¤ãŒæƒ³å®šé€šã‚Šã‹ç¢ºèª
- çˆ¶å´/æ¯å´ã®åŒºåˆ¥æ–¹æ³•ã‚’ç¢ºèª

---

## ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### æ¨å¥¨ã•ã‚Œã‚‹ä½œæ¥­æ‰‹é †

#### 1. å†ãƒ‘ãƒ¼ã‚¹ã®å®Ÿè¡Œ ğŸš¨ **ä»Šã™ãå®Ÿæ–½**

```bash
# ãƒ‘ãƒ¼ã‚¹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®å®Ÿè¡Œ
python keibaai/src/run_parsing_pipeline_local.py
```

**æ‰€è¦æ™‚é–“**: ãƒ‡ãƒ¼ã‚¿é‡ã«ä¾å­˜ï¼ˆ13,844ãƒ¬ãƒ¼ã‚¹åˆ†ï¼‰

#### 2. å†ãƒ‘ãƒ¼ã‚¹çµæœã®ç¢ºèª

```bash
# ã‚¹ã‚­ãƒ¼ãƒç¢ºèª
python check_races_schema.py

# çµ±è¨ˆæƒ…å ±ã®ç¢ºèª
python validate_parquet.py
```

#### 3. æ´¾ç”Ÿç‰¹å¾´é‡ã®å®Ÿè£…

**3-1. distance_category ã®å®Ÿè£…**:
- `feature_engine.py` ã« `create_distance_category()` é–¢æ•°ã‚’è¿½åŠ 
- ç‰¹å¾´é‡ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã¿

**3-2. damsire_id ã®å®Ÿè£…**:
- pedigrees.parquetã®æ§‹é€ ã‚’ç¢ºèªï¼ˆ`check_pedigrees_schema.py`ï¼‰
- `feature_engine.py` ã« `add_damsire_id()` é–¢æ•°ã‚’è¿½åŠ 
- ç‰¹å¾´é‡ç”Ÿæˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã«çµ„ã¿è¾¼ã¿

#### 4. ç‰¹å¾´é‡ã®å†ç”Ÿæˆ

```bash
python keibaai/src/features/generate_features.py \
  --start_date 2020-01-01 \
  --end_date 2020-12-31
```

#### 5. ç”Ÿæˆçµæœã®æ¤œè¨¼

```bash
# ç‰¹å¾´é‡ã®å†…å®¹ç¢ºèª
python validate_generated_features.py
```

**æœŸå¾…ã•ã‚Œã‚‹çµæœ**:
- âœ… ã‚¨ãƒ©ãƒ¼ãªãå…¨ç‰¹å¾´é‡ãŒç”Ÿæˆã•ã‚Œã‚‹
- âœ… ã‚ªãƒƒã‚ºç³»ã‚«ãƒ©ãƒ ãŒé™¤å¤–ã•ã‚Œã¦ã„ã‚‹
- âœ… äº¤äº’ä½œç”¨ç‰¹å¾´é‡ï¼ˆ6å€‹ï¼‰ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã‚‹

#### 6. ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã®å®Ÿè¡Œ

ç‰¹å¾´é‡ç”ŸæˆãŒæˆåŠŸã—ãŸã‚‰ã€ãƒ¢ãƒ‡ãƒ«å­¦ç¿’ã«é€²ã¿ã¾ã™:

```bash
python keibaai/src/models/train_mu_model.py
```

---

## ğŸ“š å‚è€ƒè³‡æ–™

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

| ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ | å†…å®¹ |
|-------------|------|
| `CLAUDE.md` | é–‹ç™ºã‚¬ã‚¤ãƒ‰ï¼ˆAIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆå‘ã‘ï¼‰ |
| `schema.md` | Parquetã‚¹ã‚­ãƒ¼ãƒå®šç¾© |
| `MODEL_IMPROVEMENT_PROGRESS_REPORT.md` | å‰å›ã®æ”¹å–„å±¥æ­´ |
| `DEBUG_REPORT.md` | HTMLãƒ‘ãƒ¼ã‚µãƒ¼æ”¹å–„å ±å‘Š |

### ä½œæˆã—ãŸã‚¹ã‚¯ãƒªãƒ—ãƒˆ

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | æ©Ÿèƒ½ |
|-----------|------|
| `diagnose_missing_features.py` | åŒ…æ‹¬çš„ãªè¨ºæ–­ãƒ„ãƒ¼ãƒ« |
| `check_races_schema.py` | races.parquetã‚¹ã‚­ãƒ¼ãƒç¢ºèª |
| `check_pedigrees_schema.py` | è¡€çµ±ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèª |
| `validate_generated_features.py` | ç”Ÿæˆæ¸ˆã¿ç‰¹å¾´é‡ã®æ¤œè¨¼ |

### ãƒ‘ãƒ¼ã‚µãƒ¼é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `keibaai/src/modules/parsers/results_parser.py` | ãƒ¬ãƒ¼ã‚¹çµæœHTMLã®ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰ |
| `keibaai/src/modules/parsers/shutuba_parser.py` | å‡ºé¦¬è¡¨HTMLã®ãƒ‘ãƒ¼ã‚µãƒ¼ |
| `keibaai/src/run_parsing_pipeline_local.py` | ãƒ‘ãƒ¼ã‚¹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ |

### ç‰¹å¾´é‡é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `keibaai/src/modules/features/feature_engine.py` | ç‰¹å¾´é‡ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆè¦ä¿®æ­£ï¼‰ |
| `keibaai/src/features/generate_features.py` | ç‰¹å¾´é‡ç”Ÿæˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ |
| `keibaai/configs/features.yaml` | ç‰¹å¾´é‡ç”Ÿæˆè¨­å®šï¼ˆã‚ªãƒƒã‚ºé™¤å¤–æ¸ˆã¿ï¼‰ |

---

## âœ… ã¾ã¨ã‚

### å•é¡Œã®æœ¬è³ª

- âŒ **ãƒ‘ãƒ¼ã‚µãƒ¼ã®å•é¡Œã§ã¯ãªã„** â†’ ãƒ‘ãƒ¼ã‚µãƒ¼ã¯æ—¢ã«ä¿®æ­£æ¸ˆã¿
- âœ… **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ã®å•é¡Œ** â†’ races.parquetãŒå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã¾ã¾

### è§£æ±ºç­–

1. **å†ãƒ‘ãƒ¼ã‚¹**: `python keibaai/src/run_parsing_pipeline_local.py`
2. **æ´¾ç”Ÿç‰¹å¾´é‡è¿½åŠ **: `distance_category`, `damsire_id` ã‚’å®Ÿè£…
3. **ç‰¹å¾´é‡å†ç”Ÿæˆ**: ã‚¨ãƒ©ãƒ¼ãªãå…¨ç‰¹å¾´é‡ãŒç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª

### å„ªå…ˆåº¦

| ã‚¿ã‚¹ã‚¯ | å„ªå…ˆåº¦ | ç†ç”± |
|--------|--------|------|
| races.parquetã®å†ãƒ‘ãƒ¼ã‚¹ | ğŸ”´ **æœ€å„ªå…ˆ** | ã“ã‚ŒãŒãªã„ã¨ä½•ã‚‚é€²ã¾ãªã„ |
| distance_categoryå®Ÿè£… | ğŸŸ¡ ä¸­ | äº¤äº’ä½œç”¨ç‰¹å¾´é‡ã«å¿…è¦ |
| damsire_idå®Ÿè£… | ğŸŸ¡ ä¸­ | è¡€çµ±ç‰¹å¾´é‡ã«å¿…è¦ |

### æ¨å®šæ‰€è¦æ™‚é–“

- å†ãƒ‘ãƒ¼ã‚¹: 30åˆ†ï½æ•°æ™‚é–“ï¼ˆãƒ‡ãƒ¼ã‚¿é‡æ¬¡ç¬¬ï¼‰
- æ´¾ç”Ÿç‰¹å¾´é‡å®Ÿè£…: 1ï½2æ™‚é–“
- æ¤œè¨¼ãƒ»ç¢ºèª: 30åˆ†
- **åˆè¨ˆ**: 2ï½4æ™‚é–“

---

**å ±å‘Šè€…**: Claude AI Assistant
**æœ€çµ‚æ›´æ–°**: 2025-11-17
