# KeibaAI_v2 GUI ユーザーガイド

**初心者でも簡単！ブラウザで操作する競馬AI予測システム**

---

## 📚 目次

1. [はじめに](#はじめに)
2. [セットアップ](#セットアップ)
3. [基本的な使い方](#基本的な使い方)
4. [各機能の詳細](#各機能の詳細)
5. [よくある質問](#よくある質問)
6. [トラブルシューティング](#トラブルシューティング)

---

## はじめに

### KeibaAI_v2 GUIとは？

KeibaAI_v2 GUIは、複雑な競馬予測AIシステムを**誰でも簡単に操作できる**Webインターフェースです。

従来はコマンドラインで複雑なコマンドを入力する必要がありましたが、GUIを使えば：

✅ **ブラウザで操作** - コマンドを覚える必要なし
✅ **視覚的に確認** - データやグラフで結果を表示
✅ **リアルタイム** - 処理の進捗を確認しながら実行
✅ **設定が簡単** - スライダーやボタンで直感的に設定

### 何ができるの？

- 📊 **データ収集**: ボタン一つで競馬データをスクレイピング
- 🔧 **データ処理**: HTML → 機械学習用データへ自動変換
- 🤖 **AI学習**: 予測モデルを自動学習
- 🎲 **シミュレーション**: レース結果を何千回もシミュレーション
- 💰 **賭け金最適化**: 科学的に最適な賭け金を計算
- 📈 **結果分析**: グラフで予測精度や収益を確認

---

## セットアップ

### 必要なもの

- **Python 3.10以上** がインストールされていること
- **KeibaAI_v2** のプロジェクトフォルダ
- インターネット接続（初回のみ）

### インストール手順

#### 1. 必要なパッケージをインストール

**Windows の場合:**
```cmd
cd C:\path\to\KeibaAI_v2
pip install -r keibaai\gui\requirements.txt
```

**Mac/Linux の場合:**
```bash
cd /path/to/KeibaAI_v2
pip install -r keibaai/gui/requirements.txt
```

#### 2. GUIを起動

**Windows の場合:**
```cmd
run_gui.bat
```

**Mac/Linux の場合:**
```bash
./run_gui.sh
```

#### 3. ブラウザでアクセス

自動的にブラウザが開きます。開かない場合は以下にアクセス:

```
http://localhost:8501
```

---

## 基本的な使い方

### 画面の見方

```
┌─────────────────────────────────────────────────────┐
│  🐴 KeibaAI_v2 統合ダッシュボード                    │
├──────────┬──────────────────────────────────────────┤
│          │                                          │
│ サイドバー │         メインエリア                      │
│ ナビゲーション │      (選択したページの内容)               │
│          │                                          │
│ 🏠 ダッシュ │                                          │
│ 📊 データ  │                                          │
│ 🤖 モデル  │                                          │
│ 🎲 シミュレ │                                          │
│ 💰 最適化  │                                          │
│ 📈 結果    │                                          │
│ ⚙️ 設定   │                                          │
│ 📝 ログ    │                                          │
│          │                                          │
└──────────┴──────────────────────────────────────────┘
```

### 基本操作

1. **ページ移動**: 左のサイドバーでページを選択
2. **設定入力**: フォーム、スライダー、日付選択などで設定
3. **実行**: 「🚀 ○○開始」ボタンをクリック
4. **進捗確認**: プログレスバーとログで進捗を確認
5. **結果確認**: 完了後、結果が表示される

---

## 各機能の詳細

### 🏠 ダッシュボード

**概要ページ**です。システム全体の状態を確認できます。

#### 表示内容

- **システムステータス**: データ数、モデルの状態など
- **パイプライン概要**: 各処理フェーズの実行状況
- **最近の活動**: 直近の実行履歴
- **クイックアクション**: よく使う機能へのショートカット

#### 使い方

1. ダッシュボードを開く
2. 各メトリクスで現在の状態を確認
3. クイックアクションボタンで次の操作へ

---

### 📊 データパイプライン

**データ収集と処理**を行うページです。

#### タブ構成

1. **🌐 データ取得（スクレイピング）**
2. **📝 パース処理**
3. **🔧 特徴量生成**
4. **🚀 一括実行**

#### 使い方: データ取得

1. 「データ取得」タブを開く
2. **開始日**と**終了日**を選択
3. （オプション）詳細オプションで取得するデータを選択
4. 「🚀 スクレイピング開始」ボタンをクリック
5. ログで進捗を確認

**⚠️ 注意**: スクレイピングは時間がかかります（1日分で数分～数十分）

#### 使い方: パース処理

1. 「パース処理」タブを開く
2. パースするデータの種類を選択（通常は全てチェック）
3. 「🚀 パース処理開始」ボタンをクリック
4. 完了まで待つ

#### 使い方: 特徴量生成

1. 「特徴量生成」タブを開く
2. **開始日**と**終了日**を選択
3. 有効化する特徴量カテゴリを選択
4. 「🚀 特徴量生成開始」ボタンをクリック

---

### 🤖 モデル学習

**AIモデルを学習**するページです。

#### タブ構成

1. **📈 μモデル（期待値）**
2. **📊 σモデル（分散）**
3. **🌀 νモデル（混沌度）**
4. **📋 学習済みモデル**

#### 使い方: μモデル学習

1. 「μモデル」タブを開く
2. **学習開始日**と**学習終了日**を選択（例: 2020-01-01 ～ 2023-12-31）
3. **モデル保存先**を指定（自動で日付付きフォルダ名が入力されます）
4. （オプション）ハイパーパラメータを調整
5. 「🚀 μモデル学習開始」ボタンをクリック

**⏱️ 所要時間**: データ量により1時間～数時間

#### ハイパーパラメータの意味

| パラメータ | 説明 | 推奨値 |
|----------|------|-------|
| n_estimators | 学習の反復回数 | 2000 |
| learning_rate | 学習の速さ | 0.01 |
| num_leaves | モデルの複雑さ | 31 |

**初心者の方へ**: デフォルト値のままで問題ありません！

---

### 🎲 シミュレーション

**レース結果を何度もシミュレーション**して勝率を推定します。

#### 使い方

1. **シミュレーション対象日**を選択
2. **シミュレーション回数（K）**を設定
   - 100回: 高速だが精度低
   - 1000回: **推奨**（バランス良）
   - 10000回: 高精度だが時間がかかる
3. 「🚀 シミュレーション開始」ボタンをクリック
4. 結果を確認

#### 結果の見方

```json
{
  "race_id": "202305040301",
  "probabilities": {
    "1": 0.187,  // 1番の馬の勝率 18.7%
    "2": 0.092,  // 2番の馬の勝率 9.2%
    ...
  }
}
```

---

### 💰 ポートフォリオ最適化

**科学的に最適な賭け金**を計算します。

#### 使い方

1. **最適化対象日**を選択
2. **初期資金**を入力（例: 100,000円）
3. （オプション）詳細設定を調整
   - **ケリー係数**: 0.25（クォーターケリー）推奨
   - **EV閾値**: 1.05（期待値105%以上に賭ける）
4. 「🚀 最適化実行」ボタンをクリック
5. 最適化された賭け金を確認

#### 結果の見方

| レースID | 馬番 | 賭け金 | オッズ | 期待値 |
|---------|------|--------|-------|-------|
| 202305040301 | 3 | 5,000円 | 4.2 | 1.15 |
| 202305040302 | 7 | 3,000円 | 6.8 | 1.22 |

**総賭け金**: 15,000円

---

### 📈 結果分析

**予測精度や収益を可視化**します。

#### タブ構成

1. **📊 モデル評価**: 予測の精度
2. **🎲 シミュレーション分析**: シミュレーション結果の統計
3. **💰 収益分析**: ROI、回収率など
4. **📉 データ品質**: データの完全性チェック

#### 主要メトリクス

- **Brier Score**: 確率予測の精度（**低いほど良い**）
- **Top-1 精度**: 1着予測の的中率
- **ROI**: 投資収益率（**高いほど良い**）
- **回収率**: 1円あたりの払戻額（100%以上で黒字）

---

### ⚙️ 設定管理

**システムの設定をGUIで編集**できます。

#### 設定ファイル

1. **🔧 基本設定**: データパス、ログレベル
2. **🌐 スクレイピング設定**: リクエスト間隔、リトライ
3. **🔬 特徴量設定**: 使用する特徴量
4. **🤖 モデル設定**: LightGBMのハイパーパラメータ
5. **💰 最適化設定**: ケリー係数、EV閾値

#### 使い方

1. 編集したい設定のタブを開く
2. フォームで値を変更
3. 「💾 設定を保存」ボタンをクリック
4. （一部の設定）アプリを再起動して反映

---

### 📝 ログビューア

**リアルタイムでログを確認**できます。

#### タブ構成

1. **📊 アプリケーションログ**: 全般的なログ
2. **🌐 スクレイピングログ**: データ取得のログ
3. **🤖 モデル学習ログ**: 学習進捗のログ
4. **⚠️ エラーログ**: エラーと警告のまとめ

#### 使い方

1. 見たいログのタブを開く
2. 日付を選択
3. （オプション）ログレベルや検索キーワードでフィルタ
4. ログ内容を確認
5. 必要に応じてダウンロード

---

## よくある質問

### Q1: 初めて使うのですが、どこから始めればいいですか？

**A:** 以下の順序で進めてください:

1. **ダッシュボード**を開いて現状を確認
2. **データパイプライン**でデータを取得・処理
3. **モデル学習**でAIを学習
4. **シミュレーション**で予測を実行
5. **結果分析**で精度を確認

### Q2: データ取得に時間がかかりすぎます

**A:** スクレイピングは対象サーバーへの負荷を避けるため、意図的に遅く設定されています（1リクエスト2.5-5秒）。これは正常な動作です。

**対策**:
- 日付範囲を狭める（1週間分ずつなど）
- バックグラウンドで実行して他の作業をする

### Q3: エラーが出て処理が止まりました

**A:** 以下を確認してください:

1. **ログビューア**でエラーの詳細を確認
2. **データパス**が正しく設定されているか確認
3. **依存関係**が全てインストールされているか確認
   ```bash
   pip install -r keibaai/gui/requirements.txt
   ```
4. それでも解決しない場合はエラーログを保存して報告

### Q4: モデルの精度が低いです

**A:** 以下を確認してください:

- **学習データ量**: 最低でも1年分のデータが必要
- **特徴量**: すべての特徴量カテゴリを有効化
- **ハイパーパラメータ**: デフォルト値から始めて徐々に調整
- **データ品質**: 「結果分析 > データ品質」で欠損値を確認

### Q5: 実際に賭けても大丈夫ですか？

**A:** ⚠️ **このシステムは教育・研究目的です**

- まずは**ペーパートレード**（架空の賭け）で十分なデータを集める
- 予測精度が安定してから少額で試す
- **投資は自己責任**でお願いします

### Q6: 別のPCで使いたい

**A:** 以下の方法があります:

1. **プロジェクトフォルダ全体をコピー**
2. 新しいPCで依存関係をインストール
3. GUIを起動

**注意**: `data/` フォルダは大きいので、必要に応じて除外

---

## トラブルシューティング

### 問題: GUIが起動しない

**チェックリスト**:
- [ ] Streamlitがインストールされているか
  ```bash
  pip install streamlit
  ```
- [ ] プロジェクトルートから実行しているか
- [ ] Pythonのバージョンが3.10以上か
  ```bash
  python --version
  ```

### 問題: ページが表示されない

**対処法**:
1. ブラウザを再読み込み（Ctrl+R / Cmd+R）
2. Streamlitアプリを再起動
3. キャッシュをクリア
   ```bash
   streamlit cache clear
   ```

### 問題: データが見つからない

**対処法**:
1. **設定管理**で`data_path`を確認
2. データファイルが実際に存在するか確認
   ```bash
   ls -l keibaai/data/parsed/parquet/races/
   ```
3. パイプラインを実行してデータを生成

### 問題: グラフが表示されない

**対処法**:
```bash
pip install plotly
```

### 問題: 処理が途中で止まる

**対処法**:
1. **ログビューア**でエラーを確認
2. メモリ不足の可能性
   - Pythonプロセスを再起動
   - データ量を減らす
3. ネットワークエラーの可能性
   - インターネット接続を確認
   - リトライ設定を増やす

---

## サポート

### さらにヘルプが必要な場合

1. **ログファイル**を確認:
   ```
   keibaai/data/logs/
   ```

2. **ドキュメント**を参照:
   - `CLAUDE.md` - 開発者向け詳細ガイド
   - `schema.md` - データスキーマ
   - `keibaai/gui/README.md` - GUI技術仕様

3. **GitHubイシュー**で報告:
   - エラーログを添付
   - 実行した操作を記載
   - 環境情報（OS、Pythonバージョン）を記載

---

## まとめ

このガイドを読めば、KeibaAI_v2 GUIの基本的な使い方は理解できたはずです！

**重要なポイント**:
- まずは**少量のデータ**で試す
- **ログを確認**する習慣をつける
- **設定は慎重に**変更する
- **ペーパートレード**から始める

楽しいKeibaAI_v2ライフを！ 🐴📊🚀
