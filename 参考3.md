`check_processed_data.py`の実行結果、ありがとうございます。
内容を詳細に分析しました。`races.parquet` と `shutuba.parquet` については、`エラー内容.txt` で報告された問題が修正され、データが正常に（または意図した通り `None` として）格納されていることを確認しました。

しかし、`pedigrees.parquet` と `horses.parquet` に関して、**仕様書 と実行結果の間に重大な乖離（かいり）**が発見されました。

以下に、確認された問題点と、仕様書 の必須修正箇所を明示します。

---

## 検出された重大な問題点と仕様書の修正箇所

### 1. 【最重要・スキーマ不一致】 血統パーサ (pedigrees.parquet)

実行結果の `pedigrees.parquet` は、「どの馬 (horse_id) が、どの祖先 (ancestor_id) を、どの世代 (generation) に持つか」という**ロングフォーマット（縦持ち）** で構成されています。

しかし、仕様書 5.5 で定義されている `parse_pedigree_html` は、`sire_id` (父), `dam_id` (母), `sire_sire_id` (父父)... という**ワイドフォーマット（横持ち）** を返す実装になっています。

これは**根本的なスキーマの不一致**であり、`pedigree_parser.py` の仕様書 が、現在実行されているコード（ロングフォーマットを生成するコード）と全く異なっていることを示しています。

**➡️ 仕様書 修正箇所:**

- **`AI競馬予測・最適投資システム — 完全仕様書（詳細実装版）.txt` の「5.5 血統パーサ（parsers/pedigree_parser.py）」 の `parse_pedigree_html` 関数の実装全体を、現在のロングフォーマット（`horse_id`, `ancestor_id`, `ancestor_name`, `generation` のカラムを持つ DataFrame を返す）の実装に置き換える必要があります。**

---

### 2. 【カラム不足】 馬情報パーサ (horses.parquet)

実行結果の `horses.parquet` のカラム数は **8 個** です。

しかし、仕様書 5.4 `parse_horse_profile` の定義では、`horse_name_en`, `sire_id`, `dam_id`, `damsire_id`, `sex`, `coat_color` なども含む、より多くのカラム（14 個）が定義されています。

特に、モデルの特徴量として重要なはずの**血統 ID（`sire_id`, `dam_id`, `damsire_id`）が、実行結果の `horses.parquet` に含まれていません**。これは仕様書 5.4 の「血統情報（父・母・母父）」セクションのパース処理が、現在のコードでは実行されていないか、失敗していることを示唆しています。

**➡️ 仕様書 修正箇所:**

- **`AI競馬予測・最適投資システム — 完全仕様書（詳細実装版）.txt` の「5.4 馬情報パーサ（parsers/horse_info_parser.py）」 を見直し、現在の実行結果（8 カラム）と一致するように定義を修正するか、あるいは現在のパーサーの実装が仕様書 通り（`sire_id`等を含む）になるよう修正する必要があります。**

---

### 3. 【デバッグ推奨】 血統パーサのフィルタリング不備 (pedigrees.parquet)

`エラー内容.txt` では「ancestor_id に 000 が存在する → ✓ FIXED (foreign horse IDs "000" now properly filtered)」と報告されています。

しかし、実行結果の `pedigrees.parquet` には `ancestor_id` が `000a001a8f` となっている行 が含まれています。

これは、フィルタリングロジックが `ancestor_id == "000"` という完全一致の ID のみを除外し、`000a...` のような**プレフィックスが "000" で始まる他の外国馬 ID（netkeiba 独自 ID）を除外しきれていない**可能性を強く示唆しています。

**➡️ デバッグ（要確認）:**

`pedigree_parser.py` のフィルタリングロジック（`normalize_ancestor_id` 等）が、`ancestor_id.startswith("000")` のように、"000"で始まる ID をすべて除外するようになっているか確認してください。

**➡️ 仕様書 修正箇所:**

- （上記デバッグ後）`AI競馬予測・最適投資システム — 完全仕様書（詳細実装版）.txt` の「5.5 血統パーサ」 の実装例（ロングフォーマットに修正後）に、**`ancestor_id.startswith("000")` な ID をすべて除外するフィルタリング処理を明記してください。**

---

### 4. 【要確認】 出馬表パーサ (shutuba.parquet)

`shutuba.parquet` の実行結果 は、`エラー内容.txt` の修正結果（`morning_odds` や `owner_name` が `None`）と一致しており、一見正常です。

しかし、以前のレビューで指摘した通り、`エラー内容.txt` が示すインデックス（例: `Cell[9]: morning_odds`）と、仕様書 5.3 が示すインデックス（例: `cells[11]: morning_odds`）が**異なっています**。

実行結果が `None` であるため、仕様書 のインデックスが間違ったままでも（ズレた結果 `None` が入るなどで）問題が発覚しにくい状態です。

**➡️ 仕様書 修正箇所:**

- **`AI競馬予測・最適投資システム — 完全仕様書（詳細実装版）.txt` の「5.3 出馬表パーサ（parsers/shutuba_parser.py）」 の `parse_shutuba_row` の実装が、`エラー内容.txt` に記載された最新のセルインデックス（`Cell[9]`=オッズ, `Cell[10]`=人気, `owner_name`=取得しない）を反映しているか再確認し、反映されていない場合は修正してください。**
