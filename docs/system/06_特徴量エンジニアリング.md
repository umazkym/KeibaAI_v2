# 06_ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-18

---

## ğŸ“‘ ç›®æ¬¡

1. [ç‰¹å¾´é‡æ¦‚è¦](#ç‰¹å¾´é‡æ¦‚è¦)
2. [6ã¤ã®ç‰¹å¾´é‡ã‚«ãƒ†ã‚´ãƒª](#6ã¤ã®ç‰¹å¾´é‡ã‚«ãƒ†ã‚´ãƒª)
3. [FeatureEngineã‚¯ãƒ©ã‚¹](#featureengineã‚¯ãƒ©ã‚¹)
4. [æ´¾ç”Ÿç‰¹å¾´é‡](#æ´¾ç”Ÿç‰¹å¾´é‡)
5. [æ¬ æå€¤å‡¦ç†](#æ¬ æå€¤å‡¦ç†)
6. [ç‰¹å¾´é‡é‡è¦åº¦](#ç‰¹å¾´é‡é‡è¦åº¦)

---

## ğŸ§  ç‰¹å¾´é‡æ¦‚è¦

### è¨­è¨ˆæ–¹é‡

1. **æ™‚ç³»åˆ—å®‰å…¨æ€§**: ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯ã‚’é˜²ããŸã‚ã€æœªæ¥ã®æƒ…å ±ã‚’ä½¿ã‚ãªã„
2. **è§£é‡ˆå¯èƒ½æ€§**: ãƒ–ãƒ©ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã§ã¯ãªãã€èª¬æ˜å¯èƒ½ãªç‰¹å¾´é‡
3. **ãƒ‰ãƒ¡ã‚¤ãƒ³çŸ¥è­˜**: ç«¶é¦¬ã®å°‚é–€çŸ¥è­˜ã‚’æ´»ç”¨
4. **è¨ˆç®—åŠ¹ç‡**: ç‰¹å¾´é‡ç”Ÿæˆæ™‚é–“ã‚’æœ€å°åŒ–

### å…¥åŠ›ãƒ‡ãƒ¼ã‚¿

```python
FeatureEngine.generate_features(
    shutuba_df,          # å‡ºé¦¬è¡¨ï¼ˆäºˆæ¸¬å¯¾è±¡ãƒ¬ãƒ¼ã‚¹ï¼‰
    results_history_df,  # éå»ã®å…¨ãƒ¬ãƒ¼ã‚¹çµæœ
    horse_profiles_df,   # é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
    pedigree_df          # è¡€çµ±ãƒ‡ãƒ¼ã‚¿ï¼ˆ5ä¸–ä»£ï¼‰
)
```

### å‡ºåŠ›

```python
# ç´„200åˆ—ã®ç‰¹å¾´é‡DataFrame
features_df = pd.DataFrame({
    # ã‚­ãƒ¼
    'race_id': ...,
    'horse_number': ...,

    # ãƒ¬ãƒ¼ã‚¹ç‰¹å¾´
    'distance_m': ...,
    'track_surface': ...,
    ...

    # é¦¬ç‰¹å¾´
    'avg_finish_last3': ...,
    'win_rate_last10': ...,
    ...

    # é¨æ‰‹ç‰¹å¾´
    'jockey_win_rate': ...,
    ...

    # è¡€çµ±ç‰¹å¾´
    'sire_avg_finish': ...,
    ...

    # æ´¾ç”Ÿç‰¹å¾´
    'pace_index': ...,
    ...
})
```

---

## ğŸ“Š 6ã¤ã®ç‰¹å¾´é‡ã‚«ãƒ†ã‚´ãƒª

### 1. ãƒ¬ãƒ¼ã‚¹ç‰¹å¾´ï¼ˆRace Featuresï¼‰

**ã‚½ãƒ¼ã‚¹**: `races.parquet`, `shutuba.parquet`

| ç‰¹å¾´é‡ | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ | ä¾‹ |
|-------|---------|------|---|
| `distance_m` | int16 | è·é›¢ï¼ˆmï¼‰ | 2400 |
| `track_surface` | category | é¦¬å ´ç¨®åˆ¥ | "èŠ" / "ãƒ€ãƒ¼ãƒˆ" |
| `weather` | category | å¤©å€™ | "æ™´" / "æ›‡" / "é›¨" |
| `track_condition` | category | é¦¬å ´çŠ¶æ…‹ | "è‰¯" / "ç¨é‡" / "é‡" |
| `venue` | category | ç«¶é¦¬å ´ | "æ±äº¬" / "ä¸­å±±" |
| `race_class` | category | ãƒ¬ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ | "G1" / "OP" / "1600" |
| `age_restriction` | category | å¹´é½¢åˆ¶é™ | "3æ­³" / "3æ­³ä»¥ä¸Š" |
| `head_count` | int8 | å‡ºèµ°é ­æ•° | 16 |
| `prize_1st` | int32 | 1ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 50000 |
| `distance_category` | category | è·é›¢ã‚«ãƒ†ã‚´ãƒª | "sprint" / "mile" / "long" |

**è·é›¢ã‚«ãƒ†ã‚´ãƒªåŒ–**:
```python
bins = [0, 1400, 1800, 2200, 3000, 4000]
labels = ['sprint', 'mile', 'intermediate', 'long', 'extreme_long']
df['distance_category'] = pd.cut(df['distance_m'], bins=bins, labels=labels)
```

---

### 2. é¦¬ç‰¹å¾´ï¼ˆHorse Featuresï¼‰

**ã‚½ãƒ¼ã‚¹**: `results_history_df` (å„é¦¬ã®éå»æˆç¸¾)

#### åŸºæœ¬æƒ…å ±

| ç‰¹å¾´é‡ | ãƒ‡ãƒ¼ã‚¿å‹ | èª¬æ˜ |
|-------|---------|------|
| `age` | int8 | å¹´é½¢ |
| `sex` | category | æ€§åˆ¥ |
| `horse_weight` | int16 | é¦¬ä½“é‡ |
| `horse_weight_change` | int8 | é¦¬ä½“é‡å¢—æ¸› |

#### éå»èµ°é›†ç´„ï¼ˆRolling Statisticsï¼‰

**ç›´è¿‘Nèµ°ã®å¹³å‡ç€é †**:
```python
# ç›´è¿‘3èµ°ã€5èµ°ã€10èµ°
for window in [3, 5, 10]:
    col_name = f'avg_finish_last{window}'
    df[col_name] = df.groupby('horse_id').apply(
        lambda x: x['finish_position'].rolling(window, min_periods=1).mean()
    )
```

| ç‰¹å¾´é‡ | èª¬æ˜ | è¨ˆç®—æ–¹æ³• |
|-------|------|---------|
| `avg_finish_last3` | ç›´è¿‘3èµ°å¹³å‡ç€é † | mean(finish_position[-3:]) |
| `avg_finish_last5` | ç›´è¿‘5èµ°å¹³å‡ç€é † | mean(finish_position[-5:]) |
| `avg_finish_last10` | ç›´è¿‘10èµ°å¹³å‡ç€é † | mean(finish_position[-10:]) |
| `win_rate_last10` | ç›´è¿‘10èµ°å‹ç‡ | count(finish_position==1) / 10 |
| `place_rate_last10` | ç›´è¿‘10èµ°é€£å¯¾ç‡ | count(finish_position<=2) / 10 |
| `show_rate_last10` | ç›´è¿‘10èµ°è¤‡å‹ç‡ | count(finish_position<=3) / 10 |

#### ä¼‘é¤ŠæœŸé–“

```python
df['days_since_last_race'] = (
    df['race_date'] - df.groupby('horse_id')['race_date'].shift(1)
).dt.days
```

#### é¦¬ä½“é‡æ¨ç§»

```python
df['weight_trend'] = df.groupby('horse_id')['horse_weight'].apply(
    lambda x: x.diff().rolling(3, min_periods=1).mean()
)
```

---

### 3. é¨æ‰‹ç‰¹å¾´ï¼ˆJockey Featuresï¼‰

**ã‚½ãƒ¼ã‚¹**: `results_history_df` (é¨æ‰‹ã®éå»æˆç¸¾)

```python
jockey_stats = results_history_df.groupby('jockey_id').agg({
    'finish_position': lambda x: (x == 1).mean(),  # å‹ç‡
    'win_odds': 'mean',                            # å¹³å‡ã‚ªãƒƒã‚º
    'race_id': 'count'                             # é¨ä¹—å›æ•°
}).rename(columns={
    'finish_position': 'jockey_win_rate',
    'win_odds': 'jockey_avg_odds',
    'race_id': 'jockey_ride_count'
})
```

| ç‰¹å¾´é‡ | èª¬æ˜ | è¨ˆç®—æ–¹æ³• |
|-------|------|---------|
| `jockey_win_rate` | é¨æ‰‹å‹ç‡ | count(1st) / total_rides |
| `jockey_place_rate` | é¨æ‰‹é€£å¯¾ç‡ | count(1-2nd) / total_rides |
| `jockey_roi` | é¨æ‰‹ROI | sum(returns) / sum(bets) |
| `jockey_avg_odds` | é¨æ‰‹å¹³å‡ã‚ªãƒƒã‚º | mean(win_odds) |
| `jockey_venue_win_rate` | é¨æ‰‹Ã—ç«¶é¦¬å ´å‹ç‡ | ç«¶é¦¬å ´åˆ¥ã®å‹ç‡ |

---

### 4. èª¿æ•™å¸«ç‰¹å¾´ï¼ˆTrainer Featuresï¼‰

**ã‚½ãƒ¼ã‚¹**: `results_history_df` (èª¿æ•™å¸«ã®éå»æˆç¸¾)

```python
trainer_stats = results_history_df.groupby('trainer_id').agg({
    'finish_position': [
        lambda x: (x == 1).mean(),  # å‹ç‡
        lambda x: (x <= 2).mean(),  # é€£å¯¾ç‡
        'count'                     # ç®¡ç†é ­æ•°
    ]
}).rename(columns={
    '<lambda_0>': 'trainer_win_rate',
    '<lambda_1>': 'trainer_place_rate',
    'count': 'trainer_horse_count'
})
```

---

### 5. è¡€çµ±ç‰¹å¾´ï¼ˆPedigree Featuresï¼‰

**ã‚½ãƒ¼ã‚¹**: `pedigree_df`, `results_history_df`

#### çˆ¶ç³»æˆç¸¾

```python
# çˆ¶IDã®æŠ½å‡º
sire_df = pedigree_df[pedigree_df['generation'] == 1][['horse_id', 'ancestor_id']]
sire_df = sire_df.rename(columns={'ancestor_id': 'sire_id'})

# çˆ¶ç³»ã®æˆç¸¾é›†ç´„
sire_performance = results_history_df.merge(
    sire_df, on='horse_id'
).groupby('sire_id').agg({
    'finish_position': ['mean', 'std'],
    'distance_m': 'mean',  # å¾—æ„è·é›¢
    'win_odds': 'mean'
}).rename(columns={
    ('finish_position', 'mean'): 'sire_avg_finish',
    ('finish_position', 'std'): 'sire_std_finish',
    ('distance_m', 'mean'): 'sire_avg_distance'
})
```

| ç‰¹å¾´é‡ | èª¬æ˜ |
|-------|------|
| `sire_avg_finish` | çˆ¶ç³»å¹³å‡ç€é † |
| `sire_std_finish` | çˆ¶ç³»ç€é †ã°ã‚‰ã¤ã |
| `sire_avg_distance` | çˆ¶ç³»å¾—æ„è·é›¢ |
| `dam_avg_finish` | æ¯ç³»å¹³å‡ç€é † |
| `damsire_avg_finish` | æ¯çˆ¶ç³»å¹³å‡ç€é † |

---

### 6. æ´¾ç”Ÿç‰¹å¾´ï¼ˆDerived Featuresï¼‰

#### ãƒšãƒ¼ã‚¹æŒ‡æ¨™

```python
df['time_except_last3f'] = df['finish_time_seconds'] - df['last_3f_time']
df['pace_index'] = df['time_except_last3f'] / (df['last_3f_time'] + 0.1)
```

**è§£é‡ˆ**:
- pace_index > 3.5: ã‚¹ãƒ­ãƒ¼ãƒšãƒ¼ã‚¹ï¼ˆå‰åŠã‚†ã£ãã‚Šï¼‰
- pace_index < 2.5: ãƒã‚¤ãƒšãƒ¼ã‚¹ï¼ˆå‰åŠé€Ÿã„ï¼‰

#### ä½ç½®å–ã‚Šå¤‰åŒ–

```python
for i in range(1, 4):
    df[f'position_change_{i}_{i+1}'] = (
        df[f'passing_order_{i+1}'] - df[f'passing_order_{i}']
    )

# æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ â†’ ç€é †
df['final_corner_to_finish'] = (
    df['finish_position'] - df['passing_order_4']
)
```

**è§£é‡ˆ**:
- final_corner_to_finish < 0: è¿½ã„è¾¼ã¿æˆåŠŸ
- final_corner_to_finish > 0: å¤±é€Ÿ

#### äººæ°—ã¨ç€é †ã®ä¹–é›¢

```python
df['popularity_finish_diff'] = df['finish_position'] - df['popularity']
```

**è§£é‡ˆ**:
- < 0: äººæ°—ä»¥ä¸Šã®çµæœï¼ˆå¥½èµ°ï¼‰
- > 0: äººæ°—ä»¥ä¸‹ã®çµæœï¼ˆå‡¡èµ°ï¼‰

#### ã‚ªãƒƒã‚ºã®ç›¸å¯¾å€¤

```python
df['relative_odds'] = df.groupby('race_id')['win_odds'].transform(
    lambda x: x / x.mean()
)
```

---

## ğŸ—ï¸ FeatureEngineã‚¯ãƒ©ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `keibaai/src/modules/features/feature_engine.py`

### ã‚¯ãƒ©ã‚¹æ§‹é€ 

```python
class FeatureEngine:
    def __init__(self, config: Dict):
        """
        Args:
            config: configs/features.yaml ã®å†…å®¹
        """
        self.config = config
        self.feature_names_ = []

    def generate_features(
        self,
        shutuba_df: pd.DataFrame,
        results_history_df: pd.DataFrame,
        horse_profiles_df: pd.DataFrame,
        pedigree_df: pd.DataFrame
    ) -> pd.DataFrame:
        """ãƒ¡ã‚¤ãƒ³ã®ç‰¹å¾´é‡ç”Ÿæˆãƒ•ãƒ­ãƒ¼"""

        # (1) ãƒ™ãƒ¼ã‚¹: å‡ºé¦¬è¡¨
        df = shutuba_df.copy()

        # (2) ãƒãƒ¼ã‚¸: é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        df = df.merge(horse_profiles_df, on='horse_id', how='left')

        # (3) åŸºæœ¬ç‰¹å¾´é‡
        df = self._add_basic_features(df)

        # (4) éå»èµ°é›†ç´„
        df = self._add_past_performance_features(df, results_history_df)

        # (5) è¡€çµ±ç‰¹å¾´é‡
        df = self._add_pedigree_features(df, pedigree_df, results_history_df)

        # (6) é¨æ‰‹ãƒ»èª¿æ•™å¸«ç‰¹å¾´é‡
        df = self._add_jockey_trainer_features(df, results_history_df)

        # (7) ãƒ¬ãƒ¼ã‚¹å†…æ­£è¦åŒ–
        df = self._add_relative_features(df)

        # (8) æ¬ æå€¤å‡¦ç†
        df = self._handle_missing_values(df)

        return df
```

### ãƒ¡ã‚½ãƒƒãƒ‰è©³ç´°

#### _add_basic_features()

```python
def _add_basic_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """åŸºæœ¬ç‰¹å¾´é‡ã®è¿½åŠ """

    # è·é›¢ã‚«ãƒ†ã‚´ãƒª
    df['distance_category'] = pd.cut(...)

    # é¦¬å ´ãƒ»å¤©å€™ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    df['track_surface_èŠ'] = (df['track_surface'] == 'èŠ').astype(int)
    df['track_surface_ãƒ€ãƒ¼ãƒˆ'] = (df['track_surface'] == 'ãƒ€ãƒ¼ãƒˆ').astype(int)

    return df
```

#### _add_past_performance_features()

```python
def _add_past_performance_features(
    self,
    df: pd.DataFrame,
    results_history_df: pd.DataFrame
) -> pd.DataFrame:
    """éå»èµ°é›†ç´„ç‰¹å¾´é‡"""

    # âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯é˜²æ­¢: äºˆæ¸¬å¯¾è±¡ãƒ¬ãƒ¼ã‚¹ã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨
    past_results = results_history_df[
        results_history_df['race_date'] < df['race_date'].iloc[0]
    ]

    for horse_id in df['horse_id'].unique():
        horse_past = past_results[
            past_results['horse_id'] == horse_id
        ].sort_values('race_date', ascending=False)

        # ç›´è¿‘Nèµ°
        for window in [3, 5, 10]:
            recent_races = horse_past.head(window)

            # å¹³å‡ç€é †
            avg_finish = recent_races['finish_position'].mean()
            df.loc[df['horse_id'] == horse_id, f'avg_finish_last{window}'] = avg_finish

            # å‹ç‡
            win_rate = (recent_races['finish_position'] == 1).mean()
            df.loc[df['horse_id'] == horse_id, f'win_rate_last{window}'] = win_rate

    return df
```

---

## ğŸ› ï¸ æ´¾ç”Ÿç‰¹å¾´é‡

### ç›¸å¯¾çš„æŒ‡æ¨™ï¼ˆãƒ¬ãƒ¼ã‚¹å†…æ­£è¦åŒ–ï¼‰

```python
def _add_relative_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """ãƒ¬ãƒ¼ã‚¹å†…ã§ã®ç›¸å¯¾å€¤ã‚’è¨ˆç®—"""

    # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨å‡¦ç†
    for race_id in df['race_id'].unique():
        race_df = df[df['race_id'] == race_id]
        race_indices = race_df.index

        # é¦¬ä½“é‡ã®åå·®å€¤
        mean_weight = race_df['horse_weight'].mean()
        std_weight = race_df['horse_weight'].std()

        if std_weight > 0:
            df.loc[race_indices, 'horse_weight_deviation'] = (
                50 + 10 * (race_df['horse_weight'] - mean_weight) / std_weight
            )

        # ã‚ªãƒƒã‚ºã®é †ä½
        df.loc[race_indices, 'odds_rank'] = (
            race_df['win_odds'].rank(method='min')
        )

    return df
```

---

## ğŸ©¹ æ¬ æå€¤å‡¦ç†

### æˆ¦ç•¥

| ç‰¹å¾´é‡ã‚¿ã‚¤ãƒ— | å‡¦ç†æ–¹æ³• | ç†ç”± |
|------------|---------|------|
| **ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°** | "unknown"ã‚«ãƒ†ã‚´ãƒªè¿½åŠ  | æ¬ æè‡ªä½“ãŒæƒ…å ±ã‚’æŒã¤å ´åˆã‚ã‚Š |
| **æ•°å€¤å¤‰æ•°ï¼ˆå›æ•°ç³»ï¼‰** | 0ã§åŸ‹ã‚ã‚‹ | å®Ÿç¸¾ãŒãªã„ = 0å› |
| **æ•°å€¤å¤‰æ•°ï¼ˆç‡ç³»ï¼‰** | å…¨ä½“å¹³å‡ã§åŸ‹ã‚ã‚‹ | ç„¡é›£ãªæ¨å®šå€¤ |
| **æ•°å€¤å¤‰æ•°ï¼ˆé¦¬ä½“é‡ï¼‰** | ä¸­å¤®å€¤ã§åŸ‹ã‚ã‚‹ | å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’é¿ã‘ã‚‹ |

### å®Ÿè£…

```python
def _handle_missing_values(self, df: pd.DataFrame) -> pd.DataFrame:
    """æ¬ æå€¤å‡¦ç†"""

    # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°
    categorical_cols = ['track_surface', 'weather', 'venue']
    for col in categorical_cols:
        df[col] = df[col].fillna('unknown')

    # æ•°å€¤å¤‰æ•°ï¼ˆå›æ•°ç³»ï¼‰
    count_cols = ['jockey_ride_count', 'trainer_horse_count']
    for col in count_cols:
        df[col] = df[col].fillna(0)

    # æ•°å€¤å¤‰æ•°ï¼ˆç‡ç³»ï¼‰
    rate_cols = ['jockey_win_rate', 'trainer_win_rate', 'sire_avg_finish']
    for col in rate_cols:
        global_mean = df[col].mean()
        df[col] = df[col].fillna(global_mean)

    # é¦¬ä½“é‡
    df['horse_weight'] = df['horse_weight'].fillna(df['horse_weight'].median())

    return df
```

---

## ğŸ“ˆ ç‰¹å¾´é‡é‡è¦åº¦

### LightGBMã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦

```python
import lightgbm as lgb

# è¨“ç·´å¾Œ
model = lgb.train(params, train_data)

# é‡è¦åº¦å–å¾—
importance = model.feature_importance(importance_type='gain')
feature_names = model.feature_name()

# DataFrameåŒ–
importance_df = pd.DataFrame({
    'feature': feature_names,
    'importance': importance
}).sort_values('importance', ascending=False)

# Top 20
print(importance_df.head(20))
```

### å…¸å‹çš„ãªé‡è¦ç‰¹å¾´é‡ï¼ˆå‚è€ƒï¼‰

| ãƒ©ãƒ³ã‚¯ | ç‰¹å¾´é‡ | é‡è¦åº¦ | ã‚«ãƒ†ã‚´ãƒª |
|-------|-------|-------|---------|
| 1 | avg_finish_last3 | 850 | é¦¬ |
| 2 | win_rate_last10 | 720 | é¦¬ |
| 3 | jockey_win_rate | 650 | é¨æ‰‹ |
| 4 | morning_odds | 580 | ãƒ¬ãƒ¼ã‚¹ |
| 5 | distance_m | 520 | ãƒ¬ãƒ¼ã‚¹ |
| 6 | pace_index | 480 | æ´¾ç”Ÿ |
| 7 | sire_avg_finish | 420 | è¡€çµ± |
| 8 | trainer_win_rate | 390 | èª¿æ•™å¸« |
| 9 | days_since_last_race | 360 | é¦¬ |
| 10 | popularity_finish_diff | 340 | æ´¾ç”Ÿ |

---

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [07_æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«.md](./07_æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«.md)
