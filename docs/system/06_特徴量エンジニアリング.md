```python
class FeatureEngine:
    def __init__(self, config: Dict):
        """
        Args:
            config: configs/features.yaml ã®å†…å®¹
        """
        self.config = config
        self.feature_names_ = []

    def generate_features(
        self,
        shutuba_df: pd.DataFrame,
        results_history_df: pd.DataFrame,
        horse_profiles_df: pd.DataFrame,
        pedigree_df: pd.DataFrame
    ) -> pd.DataFrame:
        """ãƒ¡ã‚¤ãƒ³ã®ç‰¹å¾´é‡ç”Ÿæˆãƒ•ãƒ­ãƒ¼"""

        # (1) ãƒ™ãƒ¼ã‚¹: å‡ºé¦¬è¡¨
        df = shutuba_df.copy()

        # (2) ãƒãƒ¼ã‚¸: é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        df = df.merge(horse_profiles_df, on='horse_id', how='left')

        # (3) åŸºæœ¬ç‰¹å¾´é‡
        df = self._add_basic_features(df)

        # (4) éå»èµ°é›†ç´„
        df = self._add_past_performance_features(df, results_history_df)

        # (5) è¡€çµ±ç‰¹å¾´é‡
        df = self._add_pedigree_features(df, pedigree_df, results_history_df)

        # (6) é¨æ‰‹ãƒ»èª¿æ•™å¸«ç‰¹å¾´é‡
        df = self._add_jockey_trainer_features(df, results_history_df)

        # (7) ãƒ¬ãƒ¼ã‚¹å†…æ­£è¦åŒ–
        df = self._add_relative_features(df)

        # (8) æ¬ æå€¤å‡¦ç†
        df = self._handle_missing_values(df)

        return df
```

### ãƒ¡ã‚½ãƒƒãƒ‰è©³ç´°

#### _add_basic_features()

```python
def _add_basic_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """åŸºæœ¬ç‰¹å¾´é‡ã®è¿½åŠ """

    # è·é›¢ã‚«ãƒ†ã‚´ãƒª
    df['distance_category'] = pd.cut(...)

    # é¦¬å ´ãƒ»å¤©å€™ã®ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°
    df['track_surface_èŠ'] = (df['track_surface'] == 'èŠ').astype(int)
    df['track_surface_ãƒ€ãƒ¼ãƒˆ'] = (df['track_surface'] == 'ãƒ€ãƒ¼ãƒˆ').astype(int)

    return df
```

#### _add_past_performance_features()

```python
def _add_past_performance_features(
    self,
    df: pd.DataFrame,
    results_history_df: pd.DataFrame
) -> pd.DataFrame:
    """éå»èµ°é›†ç´„ç‰¹å¾´é‡"""

    # âš ï¸ ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯é˜²æ­¢: äºˆæ¸¬å¯¾è±¡ãƒ¬ãƒ¼ã‚¹ã‚ˆã‚Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿ä½¿ç”¨
    past_results = results_history_df[
        results_history_df['race_date'] < df['race_date'].iloc[0]
    ]

    for horse_id in df['horse_id'].unique():
        horse_past = past_results[
            past_results['horse_id'] == horse_id
        ].sort_values('race_date', ascending=False)

        # ç›´è¿‘Nèµ°
        for window in [3, 5, 10]:
            recent_races = horse_past.head(window)

            # å¹³å‡ç€é †
            avg_finish = recent_races['finish_position'].mean()
            df.loc[df['horse_id'] == horse_id, f'avg_finish_last{window}'] = avg_finish

            # å‹ç‡
            win_rate = (recent_races['finish_position'] == 1).mean()
            df.loc[df['horse_id'] == horse_id, f'win_rate_last{window}'] = win_rate

    return df
```

---

## ğŸ› ï¸ æ´¾ç”Ÿç‰¹å¾´é‡

### ç›¸å¯¾çš„æŒ‡æ¨™ï¼ˆãƒ¬ãƒ¼ã‚¹å†…æ­£è¦åŒ–ï¼‰

```python
def _add_relative_features(self, df: pd.DataFrame) -> pd.DataFrame:
    """ãƒ¬ãƒ¼ã‚¹å†…ã§ã®ç›¸å¯¾å€¤ã‚’è¨ˆç®—"""

    # ã‚°ãƒ«ãƒ¼ãƒ—ã”ã¨å‡¦ç†
    for race_id in df['race_id'].unique():
        race_df = df[df['race_id'] == race_id]
        race_indices = race_df.index

        # é¦¬ä½“é‡ã®åå·®å€¤
        mean_weight = race_df['horse_weight'].mean()
        std_weight = race_df['horse_weight'].std()

        if std_weight > 0:
            df.loc[race_indices, 'horse_weight_deviation'] = (
                50 + 10 * (race_df['horse_weight'] - mean_weight) / std_weight
            )

        # ã‚ªãƒƒã‚ºã®é †ä½
        df.loc[race_indices, 'odds_rank'] = (
            race_df['win_odds'].rank(method='min')
        )

    return df
```

---

## ğŸ©¹ æ¬ æå€¤å‡¦ç†

### æˆ¦ç•¥

| ç‰¹å¾´é‡ã‚¿ã‚¤ãƒ— | å‡¦ç†æ–¹æ³• | ç†ç”± |
|------------|---------|------|
| **ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°** | "unknown"ã‚«ãƒ†ã‚´ãƒªè¿½åŠ  | æ¬ æè‡ªä½“ãŒæƒ…å ±ã‚’æŒã¤å ´åˆã‚ã‚Š |
| **æ•°å€¤å¤‰æ•°ï¼ˆå›æ•°ç³»ï¼‰** | 0ã§åŸ‹ã‚ã‚‹ | å®Ÿç¸¾ãŒãªã„ = 0å› |
| **æ•°å€¤å¤‰æ•°ï¼ˆç‡ç³»ï¼‰** | å…¨ä½“å¹³å‡ã§åŸ‹ã‚ã‚‹ | ç„¡é›£ãªæ¨å®šå€¤ |
| **æ•°å€¤å¤‰æ•°ï¼ˆé¦¬ä½“é‡ï¼‰** | ä¸­å¤®å€¤ã§åŸ‹ã‚ã‚‹ | å¤–ã‚Œå€¤ã®å½±éŸ¿ã‚’é¿ã‘ã‚‹ |

### å®Ÿè£…

```python
def _handle_missing_values(self, df: pd.DataFrame) -> pd.DataFrame:
    """æ¬ æå€¤å‡¦ç†"""

    # ã‚«ãƒ†ã‚´ãƒªå¤‰æ•°
    categorical_cols = ['track_surface', 'weather', 'venue']
    for col in categorical_cols:
        df[col] = df[col].fillna('unknown')

    # æ•°å€¤å¤‰æ•°ï¼ˆå›æ•°ç³»ï¼‰
    count_cols = ['jockey_ride_count', 'trainer_horse_count']
    for col in count_cols:
        df[col] = df[col].fillna(0)

    # æ•°å€¤å¤‰æ•°ï¼ˆç‡ç³»ï¼‰
    rate_cols = ['jockey_win_rate', 'trainer_win_rate', 'sire_avg_finish']
    for col in rate_cols:
        global_mean = df[col].mean()
        df[col] = df[col].fillna(global_mean)

    # é¦¬ä½“é‡
    df['horse_weight'] = df['horse_weight'].fillna(df['horse_weight'].median())

    return df
```

---

## ğŸ“ˆ ç‰¹å¾´é‡é‡è¦åº¦

### LightGBMã«ã‚ˆã‚‹ç‰¹å¾´é‡é‡è¦åº¦

```python
import lightgbm as lgb

# è¨“ç·´å¾Œ
model = lgb.train(params, train_data)

# é‡è¦åº¦å–å¾—
importance = model.feature_importance(importance_type='gain')
feature_names = model.feature_name()

# DataFrameåŒ–
importance_df = pd.DataFrame({
    'feature': feature_names,
    'importance': importance
}).sort_values('importance', ascending=False)

# Top 20
print(importance_df.head(20))
```

### å…¸å‹çš„ãªé‡è¦ç‰¹å¾´é‡ï¼ˆå‚è€ƒï¼‰

| ãƒ©ãƒ³ã‚¯ | ç‰¹å¾´é‡ | é‡è¦åº¦ | ã‚«ãƒ†ã‚´ãƒª |
|-------|-------|-------|---------|
| 1 | avg_finish_last3 | 850 | é¦¬ |
| 2 | win_rate_last10 | 720 | é¦¬ |
| 3 | jockey_win_rate | 650 | é¨æ‰‹ |
| 4 | morning_odds | 580 | ãƒ¬ãƒ¼ã‚¹ |
| 5 | distance_m | 520 | ãƒ¬ãƒ¼ã‚¹ |
| 6 | pace_index | 480 | æ´¾ç”Ÿ |
| 7 | sire_avg_finish | 420 | è¡€çµ± |
| 8 | trainer_win_rate | 390 | èª¿æ•™å¸« |
| 9 | days_since_last_race | 360 | é¦¬ |
| 10 | popularity_finish_diff | 340 | æ´¾ç”Ÿ |

---

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [07_æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«.md](./07_æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«.md)
