# 09_è¨­å®šã¨ãƒ†ã‚¹ãƒˆ

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-18

---

## ğŸ“‘ ç›®æ¬¡

1. [è¨­å®šç®¡ç†](#è¨­å®šç®¡ç†)
2. [ãƒ†ã‚¹ãƒˆæˆ¦ç•¥](#ãƒ†ã‚¹ãƒˆæˆ¦ç•¥)
3. [ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯](#ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯)
4. [ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«](#ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«)

---

## âš™ï¸ è¨­å®šç®¡ç†

### YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«

**å ´æ‰€**: `keibaai/configs/`

#### 1. default.yamlï¼ˆåŸºæœ¬è¨­å®šï¼‰

```yaml
# ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹
data_path: "data"
raw_data_path: "${data_path}/raw"
parsed_data_path: "${data_path}/parsed"
features_data_path: "${data_path}/features"
models_path: "${data_path}/models"
logs_path: "${data_path}/logs"
metadata_path: "${data_path}/metadata"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
database:
  path: "${metadata_path}/db.sqlite3"

# ãƒ­ã‚°è¨­å®š
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  file: "${logs_path}/keibaai_{date}.log"
```

#### 2. scraping.yamlï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°è¨­å®šï¼‰

```yaml
scraping:
  # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æœŸé–“
  start_date: "2020-01-01"
  end_date: "2023-12-31"

  # BANå¯¾ç­–
  min_sleep_seconds: 2.5
  max_sleep_seconds: 5.0
  http_400_sleep_seconds: 60

  # ãƒªãƒˆãƒ©ã‚¤
  max_retries: 5
  backoff_factor: 0.5

  # User-Agent
  user_agents:
    - "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    - "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
    - "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36"

  # å‡ºåŠ›
  output_dir: "${raw_data_path}/html"
```

#### 3. features.yamlï¼ˆç‰¹å¾´é‡è¨­å®šï¼‰

```yaml
features:
  # ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  version: "v1.0"

  # æœ‰åŠ¹åŒ–ãƒ•ãƒ©ã‚°
  race_features:
    enabled: true
  horse_features:
    enabled: true
    windows: [3, 5, 10]  # ãƒ­ãƒ¼ãƒªãƒ³ã‚°é›†ç´„ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚µã‚¤ã‚º
  jockey_features:
    enabled: true
  trainer_features:
    enabled: true
  pedigree_features:
    enabled: true

  # å‡ºåŠ›
  output:
    partition_by: [year, month]
    format: "parquet"
```

#### 4. models.yamlï¼ˆãƒ¢ãƒ‡ãƒ«è¨­å®šï¼‰

```yaml
models:
  # Î¼ãƒ¢ãƒ‡ãƒ«ï¼ˆLightGBM Rankerï¼‰
  lgbm_ranker:
    objective: "lambdarank"
    metric: "ndcg"
    boosting_type: "gbdt"
    n_estimators: 2000
    learning_rate: 0.01
    num_leaves: 31
    max_depth: -1
    feature_fraction: 0.8
    bagging_fraction: 0.8
    bagging_freq: 5
    lambda_l1: 0.0
    lambda_l2: 0.0
    min_data_in_leaf: 20
    verbose: -1

  # Î¼ãƒ¢ãƒ‡ãƒ«ï¼ˆLightGBM Regressorï¼‰
  lgbm_regressor:
    objective: "regression"
    metric: "rmse"
    n_estimators: 2000
    learning_rate: 0.01
    # ... åŒæ§˜ã®è¨­å®š

  # Ïƒãƒ¢ãƒ‡ãƒ«
  sigma_model:
    enabled: false  # æœªå®Ÿè£…
    # ...

  # Î½ãƒ¢ãƒ‡ãƒ«
  nu_model:
    enabled: false  # æœªå®Ÿè£…
    # ...

  # ç¢ºç‡æ ¡æ­£
  calibration:
    method: "isotonic"  # or "sigmoid"
    cv: 5
```

#### 5. optimization.yamlï¼ˆæœ€é©åŒ–è¨­å®šï¼‰

```yaml
optimization:
  # KellyåŸºæº–
  kelly_fraction: 0.25  # ä¿å®ˆçš„ï¼ˆ0.25æ¨å¥¨ï¼‰

  # æœŸå¾…å€¤ãƒ•ã‚£ãƒ«ã‚¿
  ev_threshold: 0.05  # EV > 5%ã®ã¿è³­ã‘ã‚‹

  # è³‡æœ¬åˆ¶ç´„
  max_bet_per_race: 50000  # 1ãƒ¬ãƒ¼ã‚¹ã‚ãŸã‚Šæœ€å¤§5ä¸‡å††
  max_total_exposure: 100000  # å…¨ãƒ¬ãƒ¼ã‚¹åˆè¨ˆã§æœ€å¤§10ä¸‡å††

  # ãƒªã‚¹ã‚¯ç®¡ç†
  max_odds: 50.0  # 50å€ä»¥ä¸Šã®ã‚ªãƒƒã‚ºã«ã¯è³­ã‘ãªã„
  min_win_prob: 0.05  # 5%æœªæº€ã®å‹ç‡ã«ã¯è³­ã‘ãªã„

  # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  K: 1000  # ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­å›æ•°
```

### è¨­å®šã®èª­ã¿è¾¼ã¿

```python
from pathlib import Path
import yaml

def load_config(config_name: str) -> dict:
    """
    YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿

    Args:
        config_name: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«åï¼ˆæ‹¡å¼µå­ãªã—ï¼‰

    Returns:
        dict: è¨­å®šå†…å®¹
    """
    config_path = Path(f"keibaai/configs/{config_name}.yaml")

    with open(config_path, 'r', encoding='utf-8') as f:
        config = yaml.safe_load(f)

    # å¤‰æ•°ç½®æ›
    config = substitute_variables(config)

    return config

def substitute_variables(config: dict, context: dict = None) -> dict:
    """
    ${variable} å½¢å¼ã®å¤‰æ•°ã‚’ç½®æ›

    Example:
        "${data_path}/raw" â†’ "data/raw"
    """
    if context is None:
        context = config.copy()

    import re

    def replace(match):
        var_name = match.group(1)
        return context.get(var_name, match.group(0))

    for key, value in config.items():
        if isinstance(value, str):
            config[key] = re.sub(r'\$\{(\w+)\}', replace, value)
        elif isinstance(value, dict):
            config[key] = substitute_variables(value, context)

    return config
```

---

## ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### ãƒ†ã‚¹ãƒˆæ§‹æˆ

```
tests/
â”œâ”€â”€ unit/                  # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_parsers.py
â”‚   â”œâ”€â”€ test_features.py
â”‚   â”œâ”€â”€ test_models.py
â”‚   â””â”€â”€ test_utils.py
â”œâ”€â”€ integration/           # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ test_pipeline_e2e.py
â”‚   â””â”€â”€ test_data_quality.py
â”œâ”€â”€ regression/            # å›å¸°ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ test_parser_regression.py
â””â”€â”€ fixtures/              # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
    â”œâ”€â”€ race_samples/
    â”œâ”€â”€ shutuba_samples/
    â”œâ”€â”€ horse_samples/
    â””â”€â”€ ped_samples/
```

### ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/unit/test_parsers.py`

```python
import pytest
from keibaai.src.modules.parsers.common_utils import (
    parse_time_to_seconds,
    parse_margin_to_seconds,
    parse_sex_age,
    parse_horse_weight
)

class TestCommonUtils:
    """å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒ†ã‚¹ãƒˆ"""

    def test_parse_time_to_seconds(self):
        """ã‚¿ã‚¤ãƒ æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹"""
        assert parse_time_to_seconds("1:23.4") == 83.4
        assert parse_time_to_seconds("59.8") == 59.8
        assert parse_time_to_seconds("2:00.0") == 120.0
        assert parse_time_to_seconds("") is None
        assert parse_time_to_seconds("-") is None

    def test_parse_margin_to_seconds(self):
        """ç€å·®æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹"""
        assert parse_margin_to_seconds("3") == 0.6  # 3é¦¬èº«
        assert parse_margin_to_seconds("1 1/2") == 0.3  # 1.5é¦¬èº«
        assert parse_margin_to_seconds("ã‚¯ãƒ“") == 0.02
        assert parse_margin_to_seconds("ãƒãƒŠ") == 0.01
        assert parse_margin_to_seconds("") is None

    def test_parse_sex_age(self):
        """æ€§é½¢æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹"""
        assert parse_sex_age("ç‰¡3") == ("ç‰¡", 3)
        assert parse_sex_age("ç‰4") == ("ç‰", 4)
        assert parse_sex_age("ã‚»6") == ("ã‚»", 6)

    def test_parse_horse_weight(self):
        """é¦¬ä½“é‡æ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹"""
        assert parse_horse_weight("476(+2)") == (476, 2)
        assert parse_horse_weight("480(-4)") == (480, -4)
        assert parse_horse_weight("è¨ˆä¸") == (None, None)
```

### çµ±åˆãƒ†ã‚¹ãƒˆä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/test_pipeline_e2e.py`

```python
import pytest
from pathlib import Path
import pandas as pd

class TestPipelineE2E:
    """ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ãƒ†ã‚¹ãƒˆ"""

    def test_scraping_to_parsing(self, tmp_path):
        """ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° â†’ ãƒ‘ãƒ¼ã‚¹ã®çµ±åˆãƒ†ã‚¹ãƒˆ"""
        # 1. HTMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‹ã‚‰ã‚³ãƒ”ãƒ¼
        html_file = Path("tests/fixtures/race_samples/202001010101.bin")
        output_file = tmp_path / "202001010101.bin"
        shutil.copy(html_file, output_file)

        # 2. ãƒ‘ãƒ¼ã‚¹å®Ÿè¡Œ
        from keibaai.src.modules.parsers import parse_results_html
        df = parse_results_html(str(output_file))

        # 3. æ¤œè¨¼
        assert not df.empty
        assert 'race_id' in df.columns
        assert 'finish_position' in df.columns
        assert df['finish_position'].dtype == 'Int64'  # nullable integer

    def test_parsing_to_features(self):
        """ãƒ‘ãƒ¼ã‚¹ â†’ ç‰¹å¾´é‡ç”Ÿæˆã®çµ±åˆãƒ†ã‚¹ãƒˆ"""
        # 1. ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        races_df = pd.read_parquet("tests/fixtures/races.parquet")
        horses_df = pd.read_parquet("tests/fixtures/horses.parquet")

        # 2. ç‰¹å¾´é‡ç”Ÿæˆ
        from keibaai.src.modules.features import FeatureEngine
        engine = FeatureEngine(config)
        features_df = engine.generate_features(
            shutuba_df=races_df,
            results_history_df=races_df,
            horse_profiles_df=horses_df,
            pedigree_df=pd.DataFrame()
        )

        # 3. æ¤œè¨¼
        assert not features_df.empty
        assert 'avg_finish_last3' in features_df.columns
```

### å›å¸°ãƒ†ã‚¹ãƒˆä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/regression/test_parser_regression.py`

```python
import pytest
import pandas as pd
from pathlib import Path

class TestParserRegression:
    """ãƒ‘ãƒ¼ã‚µãƒ¼ã®å›å¸°ãƒ†ã‚¹ãƒˆï¼ˆæ—¢å­˜æ©Ÿèƒ½ã®ä¿è­·ï¼‰"""

    @pytest.fixture
    def expected_output(self):
        """æœŸå¾…ã•ã‚Œã‚‹å‡ºåŠ›ï¼ˆã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼‰"""
        return pd.read_parquet("tests/fixtures/golden/races_20231009.parquet")

    def test_results_parser_regression(self, expected_output):
        """ãƒ¬ãƒ¼ã‚¹çµæœãƒ‘ãƒ¼ã‚µãƒ¼ã®å›å¸°ãƒ†ã‚¹ãƒˆ"""
        from keibaai.src.modules.parsers import parse_results_html

        # å†ãƒ‘ãƒ¼ã‚¹
        html_files = list(Path("tests/fixtures/race_samples/").glob("*.bin"))
        actual_dfs = [parse_results_html(str(f)) for f in html_files]
        actual_output = pd.concat(actual_dfs, ignore_index=True)

        # æ¯”è¼ƒ
        pd.testing.assert_frame_equal(
            actual_output.sort_values('race_id').reset_index(drop=True),
            expected_output.sort_values('race_id').reset_index(drop=True),
            check_dtype=True,
            check_exact=False,
            rtol=1e-5
        )
```

### ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
pytest

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
pytest tests/unit/test_parsers.py

# ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®š
pytest --cov=keibaai --cov-report=html

# ä¸¦åˆ—å®Ÿè¡Œï¼ˆé«˜é€ŸåŒ–ï¼‰
pytest -n 4  # 4ãƒ—ãƒ­ã‚»ã‚¹ä¸¦åˆ—
```

---

## âœ… ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯

### åŒ…æ‹¬çš„ãªå“è³ªæ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ 

**å ´æ‰€**: `keibaai/src/modules/validation/` + `keibaai/src/modules/monitoring/`

KeibaAI_v2ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿å“è³ªã‚’è‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ã—ã€ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã‚’è©³ç´°ã«åˆ†æã™ã‚‹åŒ…æ‹¬çš„ãªã‚·ã‚¹ãƒ†ãƒ ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™ã€‚

### 1. ValidationPipelineï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `keibaai/src/modules/validation/validation_pipeline.py`

**æ©Ÿèƒ½**:
- **ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å“è³ªãƒã‚§ãƒƒã‚¯**
  - ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨ã‚µã‚¤ã‚ºã®çµ±è¨ˆ
  - 404ã‚¨ãƒ©ãƒ¼ç‡ï¼ˆ1KBæœªæº€ã®ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡ºï¼‰
  - ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼æ¤œå‡º

- **ãƒ‘ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§æ¤œè¨¼**
  - ã‚¹ã‚­ãƒ¼ãƒãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆã‚«ãƒ©ãƒ ã®å­˜åœ¨ç¢ºèªï¼‰
  - å‹ãƒã‚§ãƒƒã‚¯ï¼ˆæ•°å€¤ã‚«ãƒ©ãƒ ã®å‹æ¤œè¨¼ï¼‰
  - è«–ç†æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆç€é † <= å‡ºèµ°é ­æ•°ãªã©ï¼‰
  - æ¬ æç‡ã®è¨ˆç®—

- **ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼**
  - ãƒ‡ãƒ¼ã‚¿ãƒªãƒ¼ã‚¯ãƒã‚§ãƒƒã‚¯ï¼ˆwin_odds, place_oddsç­‰ã®ç¦æ­¢ã‚«ãƒ©ãƒ æ¤œå‡ºï¼‰
  - æ¬ æç‡ãƒã‚§ãƒƒã‚¯
  - ç„¡é™å€¤ãƒ»NaNã®æ¤œå‡º

**ä½¿ç”¨ä¾‹**:
```python
from keibaai.src.modules.validation.validation_pipeline import ValidationPipeline

pipeline = ValidationPipeline(data_path, config)
summary = pipeline.validate_all(start_date='2023-10-01', end_date='2023-10-31')

# ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
pipeline.save_report(Path('validation_report.json'), format='json')
pipeline.save_report(Path('validation_report.md'), format='markdown')
```

**å‡ºåŠ›ä¾‹**:
```json
{
  "timestamp": "2023-11-18T15:30:00",
  "total_checks": 25,
  "passed": 20,
  "warnings": 4,
  "failed": 1,
  "results": [
    {
      "check_name": "scraping_race",
      "status": "pass",
      "message": "race ã®ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã¯æ­£å¸¸",
      "details": {
        "file_count": 278098,
        "error_rate": 0.005
      }
    }
  ]
}
```

### 2. MonitoringSystemï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `keibaai/src/modules/monitoring/monitoring_local.py`

**æ©Ÿèƒ½**:
- **ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†**
  - ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æˆåŠŸç‡
  - ãƒ‘ãƒ¼ã‚¹æˆåŠŸç‡
  - ç‰¹å¾´é‡æ¬ æç‡
  - ãƒ¢ãƒ‡ãƒ«ç›¸é–¢ä¿‚æ•°
  - å®Ÿè¡Œæ™‚é–“

- **ç•°å¸¸æ¤œçŸ¥**
  - é–¾å€¤ãƒ™ãƒ¼ã‚¹ã®æ¤œçŸ¥ï¼ˆè¨­å®šå¯èƒ½ï¼‰
  - çµ±è¨ˆçš„ç•°å¸¸æ¤œçŸ¥ï¼ˆ3Ïƒæ³•ï¼‰
  - ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ

- **ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½**
  - é‡è¦åº¦åˆ¥ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆinfo, warning, error, criticalï¼‰
  - ã‚¢ãƒ©ãƒ¼ãƒˆå±¥æ­´ã®ä¿å­˜

**ä½¿ç”¨ä¾‹**:
```python
from keibaai.src.modules.monitoring.monitoring_local import MonitoringSystem

monitoring = MonitoringSystem(data_path, config)

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¨˜éŒ²
monitoring.record_metric('scraping_success_rate', 0.98, metadata={'category': 'race'})

# ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¿½è·¡
monitoring.track_scraping_metrics('2023-10-01', '2023-10-31')

# ãƒ‘ãƒ¼ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®è¿½è·¡
monitoring.track_parsing_metrics()

# ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®ä¿å­˜
monitoring.save_metrics(Path('monitoring_metrics.json'))
```

### 3. ModelAnalyzerï¼ˆãƒ¢ãƒ‡ãƒ«åˆ†æãƒ»ãƒ‡ãƒãƒƒã‚°ï¼‰

**ãƒ•ã‚¡ã‚¤ãƒ«**: `keibaai/src/modules/monitoring/model_analyzer.py`

**æ©Ÿèƒ½**:
- **å…¨ä½“çš„ãªè©•ä¾¡æŒ‡æ¨™**
  - ã‚¹ãƒ”ã‚¢ãƒãƒ³é †ä½ç›¸é–¢ä¿‚æ•°
  - Brier Scoreï¼ˆç¢ºç‡ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
  - Expected Calibration Error (ECE)
  - Top-K Accuracyï¼ˆK=1,3,5ï¼‰
  - RMSEï¼ˆã‚¿ã‚¤ãƒ äºˆæ¸¬ï¼‰
  - ROIï¼ˆæ¨¡æ“¬æŠ•è³‡åç›Šç‡ï¼‰

- **ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥æ€§èƒ½åˆ†æ**
  - è·é›¢åˆ¥ï¼ˆã‚¹ãƒ—ãƒªãƒ³ãƒˆ/ãƒã‚¤ãƒ«/ä¸­è·é›¢/é•·è·é›¢/è¶…é•·è·é›¢ï¼‰
  - é¦¬å ´åˆ¥ï¼ˆèŠ/ãƒ€ãƒ¼ãƒˆï¼‰
  - ã‚¯ãƒ©ã‚¹åˆ¥
  - ç«¶é¦¬å ´åˆ¥
  - å¤©å€™åˆ¥

- **ã‚¨ãƒ©ãƒ¼åˆ†æ**
  - äºˆæ¸¬ç²¾åº¦ã®ä½ã„ãƒ¬ãƒ¼ã‚¹ã‚’ç‰¹å®š
  - ã‚¨ãƒ©ãƒ¼ã®å…±é€šãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’åˆ†æ
  - è·é›¢åˆ¥ãƒ»é¦¬å ´åˆ¥ã®ã‚¨ãƒ©ãƒ¼åˆ†å¸ƒ

- **ç‰¹å¾´é‡é‡è¦åº¦åˆ†æ**
  - ä¸Šä½10ä»¶ã®é‡è¦ç‰¹å¾´é‡ã‚’è¡¨ç¤º

- **æ”¹å–„ææ¡ˆã®è‡ªå‹•ç”Ÿæˆ**
  - æ€§èƒ½è©•ä¾¡ã«åŸºã¥ãå…·ä½“çš„ãªææ¡ˆ
  - ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥ã®æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ
  - ãƒ‡ãƒ¼ã‚¿æ‹¡å……ã®ææ¡ˆ

**ä½¿ç”¨ä¾‹**:
```python
from keibaai.src.modules.monitoring.model_analyzer import ModelAnalyzer
import pandas as pd

model_path = Path('keibaai/data/models/latest')
data_path = Path('keibaai/data')

# ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
predictions_df = pd.read_parquet('predictions.parquet')
actuals_df = pd.read_parquet('actuals.parquet')

# åˆ†æã®å®Ÿè¡Œ
analyzer = ModelAnalyzer(model_path, data_path)
report = analyzer.analyze(predictions_df, actuals_df)

# ãƒ¬ãƒãƒ¼ãƒˆä¿å­˜
analyzer.save_report(report, Path('model_analysis.json'))
```

**å‡ºåŠ›ä¾‹**:
```json
{
  "timestamp": "2023-11-18T15:30:00",
  "overall_metrics": {
    "spearman_mean": -0.52,
    "brier_score": 0.18,
    "ece": 0.08,
    "top_1_accuracy": 0.32,
    "roi": 5.2
  },
  "recommendations": [
    "âš  sprint ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã§æ€§èƒ½ãŒä½ã„ã€‚ã“ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå‘ã‘ã®ç‰¹å¾´é‡è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚",
    "âœ“ äºˆæ¸¬ç²¾åº¦ã¯è‰¯å¥½ï¼ˆç›¸é–¢=-0.52ï¼‰ã€‚"
  ]
}
```

### 4. çµ±åˆå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ

**ãƒ•ã‚¡ã‚¤ãƒ«**: `keibaai/scripts/run_quality_checks.py`

ã™ã¹ã¦ã®å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ä¸€æ‹¬å®Ÿè¡Œã§ãã‚‹çµ±åˆã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ã™ã€‚

**åŸºæœ¬çš„ãªä½¿ã„æ–¹**:
```bash
# å…¨ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
python keibaai/scripts/run_quality_checks.py --config keibaai/configs/default.yaml

# ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿
python keibaai/scripts/run_quality_checks.py --validation-only

# ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ã¿
python keibaai/scripts/run_quality_checks.py --monitoring-only

# ãƒ¢ãƒ‡ãƒ«åˆ†æã®ã¿
python keibaai/scripts/run_quality_checks.py --model-analysis-only \
  --model-dir keibaai/data/models/latest \
  --predictions keibaai/data/predictions/2023-10-01.parquet \
  --actuals keibaai/data/parsed/parquet/races/races.parquet

# æ—¥ä»˜ç¯„å›²ã‚’æŒ‡å®š
python keibaai/scripts/run_quality_checks.py \
  --start-date 2023-10-01 \
  --end-date 2023-10-31
```

**cronå¯¾å¿œ**:
```bash
# æ¯æ—¥æ·±å¤œ3æ™‚ã«è‡ªå‹•å®Ÿè¡Œ
0 3 * * * cd /path/to/KeibaAI_v2 && \
  python keibaai/scripts/run_quality_checks.py \
  --config keibaai/configs/default.yaml
```

**å‡ºåŠ›**:
- `validation_report_YYYYMMDD_HHMMSS.json` - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
- `validation_report_YYYYMMDD_HHMMSS.md` - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownï¼‰
- `monitoring_metrics_YYYYMMDD_HHMMSS.json` - ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ãƒ¡ãƒˆãƒªã‚¯ã‚¹
- `model_analysis_YYYYMMDD_HHMMSS.json` - ãƒ¢ãƒ‡ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆJSONï¼‰
- `model_analysis_YYYYMMDD_HHMMSS.md` - ãƒ¢ãƒ‡ãƒ«åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆMarkdownï¼‰
- `integrated_report_YYYYMMDD_HHMMSS.md` - çµ±åˆãƒ¬ãƒãƒ¼ãƒˆ

**ä¿å­˜å…ˆ**: `keibaai/data/quality_reports/YYYY/MM/DD/`

### 5. ãƒ†ã‚¹ãƒˆè‡ªå‹•åŒ–

å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã«çµ±åˆã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ï¼š

**ãƒ•ã‚¡ã‚¤ãƒ«**: `tests/integration/test_data_quality.py`

```python
import pytest
from keibaai.src.modules.validation.validation_pipeline import ValidationPipeline

class TestDataQuality:
    """ãƒ‡ãƒ¼ã‚¿å“è³ªã®çµ±åˆãƒ†ã‚¹ãƒˆ"""

    def test_scraping_quality(self):
        """ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã®å“è³ªãƒ†ã‚¹ãƒˆ"""
        pipeline = ValidationPipeline(data_path, config)
        summary = pipeline.validate_all()

        # å¤±æ•—ãŒãªã„ã“ã¨ã‚’ç¢ºèª
        assert summary['failed'] == 0, "Data quality checks failed"

        # è­¦å‘ŠãŒå°‘ãªã„ã“ã¨ã‚’ç¢ºèª
        assert summary['warnings'] < 5, "Too many warnings"

    def test_model_performance(self):
        """ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ã®ãƒ†ã‚¹ãƒˆ"""
        analyzer = ModelAnalyzer(model_path, data_path)
        report = analyzer.analyze(predictions_df, actuals_df)

        # ç›¸é–¢ä¿‚æ•°ãŒé–¾å€¤ã‚’è¶…ãˆã‚‹ã“ã¨ã‚’ç¢ºèª
        assert report.overall_metrics['spearman_mean'] < -0.4, \
               "Model correlation is too low"

        # ROIãŒãƒ—ãƒ©ã‚¹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        assert report.overall_metrics['roi'] > 0, \
               "Model ROI is negative"
```

**å®Ÿè¡Œ**:
```bash
# ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
pytest tests/integration/test_data_quality.py -v
```

### è©³ç´°ã‚¬ã‚¤ãƒ‰

è©³ç´°ãªä½¿ã„æ–¹ã¯ä»¥ä¸‹ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š
- **[QUALITY_CHECK_GUIDE.md](../../QUALITY_CHECK_GUIDE.md)** - è©³ç´°ãªä½¿ã„æ–¹ã€ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

---

## ğŸ› ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«

### ãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¸€è¦§

**å ´æ‰€**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ

| ã‚¹ã‚¯ãƒªãƒ—ãƒˆ | ç”¨é€” |
|----------|------|
| `debug_scraping_and_parsing.py` | ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°+ãƒ‘ãƒ¼ã‚¹ã®ãƒ‡ãƒãƒƒã‚° |
| `debug_race_results.py` | ãƒ¬ãƒ¼ã‚¹çµæœãƒ‘ãƒ¼ã‚µãƒ¼ã®å‹•ä½œç¢ºèª |
| `debug_shutuba.py` | å‡ºé¦¬è¡¨ãƒ‘ãƒ¼ã‚µãƒ¼ã®å‹•ä½œç¢ºèª |
| `debug_horse_info.py` | é¦¬æƒ…å ±ãƒ‘ãƒ¼ã‚µãƒ¼ã®å‹•ä½œç¢ºèª |
| `debug_pedigree.py` | è¡€çµ±ãƒ‘ãƒ¼ã‚µãƒ¼ã®å‹•ä½œç¢ºèª |
| `check_parsed_data.py` | ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ |
| `check_features_data.py` | ç‰¹å¾´é‡ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ |
| `validate_parquet.py` | Parquetãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼ |

### ãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `debug_race_results.py`

```python
#!/usr/bin/env python3
"""ãƒ¬ãƒ¼ã‚¹çµæœãƒ‘ãƒ¼ã‚µãƒ¼ã®ãƒ‡ãƒãƒƒã‚°"""

from pathlib import Path
import pandas as pd
from keibaai.src.modules.parsers import parse_results_html

def main():
    # ã‚µãƒ³ãƒ—ãƒ«HTMLãƒ•ã‚¡ã‚¤ãƒ«
    html_file = Path("data/raw/html/race/202310010811.bin")

    if not html_file.exists():
        print(f"File not found: {html_file}")
        return

    # ãƒ‘ãƒ¼ã‚¹å®Ÿè¡Œ
    print(f"Parsing: {html_file}")
    df = parse_results_html(str(html_file))

    # çµæœè¡¨ç¤º
    print(f"\nParsed {len(df)} rows")
    print(f"Columns: {list(df.columns)}")
    print(f"\nSample data:")
    print(df.head())

    # ãƒ‡ãƒ¼ã‚¿å“è³ªãƒã‚§ãƒƒã‚¯
    print(f"\nData Quality:")
    print(f"  Missing values:")
    missing = df.isnull().sum()
    print(missing[missing > 0])

    print(f"\n  Data types:")
    print(df.dtypes)

if __name__ == '__main__':
    main()
```

### ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹

**ãƒ•ã‚¡ã‚¤ãƒ«**: `check_parsed_data.py`

```python
#!/usr/bin/env python3
"""ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼"""

import pandas as pd
from pathlib import Path

def validate_races_parquet():
    """races.parquet ã®æ¤œè¨¼"""
    races_path = Path("data/parsed/parquet/races/races.parquet")
    df = pd.read_parquet(races_path)

    print(f"races.parquet: {len(df)} rows")

    # å¿…é ˆã‚«ãƒ©ãƒ ã®å­˜åœ¨ç¢ºèª
    required_cols = ['race_id', 'horse_number', 'finish_position']
    for col in required_cols:
        assert col in df.columns, f"Missing column: {col}"

    # ãƒ‡ãƒ¼ã‚¿å‹ãƒã‚§ãƒƒã‚¯
    assert df['finish_position'].dtype == 'Int64', "finish_position should be Int64"

    # ç¯„å›²ãƒã‚§ãƒƒã‚¯
    assert df['finish_position'].between(1, 18).all(), "Invalid finish_position"

    # é‡è¤‡ãƒã‚§ãƒƒã‚¯
    duplicates = df.duplicated(subset=['race_id', 'horse_number']).sum()
    assert duplicates == 0, f"Found {duplicates} duplicates"

    print("âœ“ All validations passed")

def main():
    validate_races_parquet()
    # validate_shutuba_parquet()
    # validate_horses_parquet()
    # validate_pedigrees_parquet()

if __name__ == '__main__':
    main()
```

---

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [10_é‹ç”¨ã‚¬ã‚¤ãƒ‰.md](./10_é‹ç”¨ã‚¬ã‚¤ãƒ‰.md)
