# 03_ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-18
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0

---

## ğŸ“‘ ç›®æ¬¡

1. [ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ¦‚è¦](#ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ¦‚è¦)
2. [Parquetã‚¹ã‚­ãƒ¼ãƒ](#parquetã‚¹ã‚­ãƒ¼ãƒ)
3. [ä¸»ã‚­ãƒ¼ã¨å¤–éƒ¨ã‚­ãƒ¼](#ä¸»ã‚­ãƒ¼ã¨å¤–éƒ¨ã‚­ãƒ¼)
4. [ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©](#ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©)
5. [ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥](#ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥)
6. [ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ«ãƒ¼ãƒ«](#ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ«ãƒ¼ãƒ«)

---

## ğŸ—‚ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«æ¦‚è¦

### ERå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   races     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (278K rows) â”‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
       â”‚                 â”‚
       â”‚ race_id         â”‚
       â”‚                 â”‚
       â†“                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   shutuba   â”‚    â”‚  features   â”‚
â”‚ (278K rows) â”‚    â”‚  (partitioned)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ horse_id
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   horses    â”‚
â”‚  (~50K rows)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ horse_id
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pedigrees   â”‚
â”‚ (1.3M rows) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

| ãƒ†ãƒ¼ãƒ–ãƒ«å | è¡Œæ•° | åˆ—æ•° | ç”¨é€” | ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ |
|----------|------|------|------|------------|
| **races** | 278,098 | 27+ | ãƒ¬ãƒ¼ã‚¹çµæœ | `data/parsed/parquet/races/races.parquet` |
| **shutuba** | 278,098 | 21 | å‡ºé¦¬è¡¨ | `data/parsed/parquet/shutuba/shutuba.parquet` |
| **horses** | ~50,000 | 15+ | é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ« | `data/parsed/parquet/horses/horses.parquet` |
| **pedigrees** | 1,377,361 | 5 | è¡€çµ±ï¼ˆ5ä¸–ä»£ï¼‰ | `data/parsed/parquet/pedigrees/pedigrees.parquet` |
| **features** | 278,098 | 200+ | ç‰¹å¾´é‡ | `data/features/parquet/year=YYYY/month=MM/` |

---

## ğŸ“‹ Parquetã‚¹ã‚­ãƒ¼ãƒ

### 1. races.parquetï¼ˆãƒ¬ãƒ¼ã‚¹çµæœï¼‰

**ä¸»ã‚­ãƒ¼**: `(race_id, horse_number)`

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | Nullable | èª¬æ˜ | ä¾‹ |
|---------|---------|----------|------|---|
| `race_id` | string | No | ãƒ¬ãƒ¼ã‚¹IDï¼ˆ12æ¡ï¼‰ | "202310010811" |
| `race_date` | date | No | ãƒ¬ãƒ¼ã‚¹é–‹å‚¬æ—¥ | "2023-10-01" |
| `race_name` | string | Yes | ãƒ¬ãƒ¼ã‚¹å | "æ±äº¬å„ªé§¿ï¼ˆæ—¥æœ¬ãƒ€ãƒ¼ãƒ“ãƒ¼ï¼‰" |
| `distance_m` | int16 | Yes | è·é›¢ï¼ˆãƒ¡ãƒ¼ãƒˆãƒ«ï¼‰ | 2400 |
| `track_surface` | string | Yes | é¦¬å ´ç¨®åˆ¥ | "èŠ" / "ãƒ€ãƒ¼ãƒˆ" / "éšœå®³" |
| `weather` | string | Yes | å¤©å€™ | "æ™´" / "æ›‡" / "é›¨" / "å°é›¨" |
| `track_condition` | string | Yes | é¦¬å ´çŠ¶æ…‹ | "è‰¯" / "ç¨é‡" / "é‡" / "ä¸è‰¯" |
| `post_time` | time | Yes | ç™ºèµ°æ™‚åˆ» | "15:40:00" |
| `venue` | string | Yes | ç«¶é¦¬å ´ | "æ±äº¬" / "ä¸­å±±" / "é˜ªç¥" |
| `day_of_meeting` | int8 | Yes | é–‹å‚¬æ—¥ç›® | 3 |
| `round_of_year` | int8 | Yes | å¹´å†…å›æ¬¡ | 4 |
| `race_class` | string | Yes | ãƒ¬ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¹ | "G1" / "G2" / "OP" / "1600" / "æœªå‹åˆ©" |
| `age_restriction` | string | Yes | å¹´é½¢åˆ¶é™ | "3æ­³" / "3æ­³ä»¥ä¸Š" |
| `head_count` | int8 | Yes | å‡ºèµ°é ­æ•° | 16 |
| `prize_1st` | int32 | Yes | 1ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 50000 |
| `prize_2nd` | int32 | Yes | 2ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 20000 |
| `prize_3rd` | int32 | Yes | 3ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 12500 |
| `prize_4th` | int32 | Yes | 4ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 7500 |
| `prize_5th` | int32 | Yes | 5ç€è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 5000 |
| **finish_position** | **int8** | Yes | **ç€é †** | 1 |
| `bracket_number` | int8 | Yes | æ ç•ª | 4 |
| `horse_number` | int8 | No | é¦¬ç•ª | 7 |
| `horse_id` | string | Yes | é¦¬IDï¼ˆ10æ¡ï¼‰ | "2020104567" |
| `horse_name` | string | Yes | é¦¬å | "ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«" |
| `sex` | string | Yes | æ€§åˆ¥ | "ç‰¡" / "ç‰" / "ã‚»" |
| `age` | int8 | Yes | å¹´é½¢ | 3 |
| `basis_weight` | float32 | Yes | æ–¤é‡ï¼ˆkgï¼‰ | 57.0 |
| `jockey_id` | string | Yes | é¨æ‰‹ID | "01234" |
| `jockey_name` | string | Yes | é¨æ‰‹å | "ç¦æ°¸ç¥ä¸€" |
| `finish_time_str` | string | Yes | ã‚¿ã‚¤ãƒ ï¼ˆæ–‡å­—åˆ—ï¼‰ | "2:23.3" |
| `finish_time_seconds` | float32 | Yes | ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰ | 143.3 |
| `margin_str` | string | Yes | ç€å·®ï¼ˆæ–‡å­—åˆ—ï¼‰ | "1 1/2" |
| `margin_seconds` | float32 | Yes | ç€å·®ï¼ˆç§’ï¼‰ | 0.3 |
| `passing_order_1` | int8 | Yes | 1ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ | 5 |
| `passing_order_2` | int8 | Yes | 2ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ | 4 |
| `passing_order_3` | int8 | Yes | 3ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ | 3 |
| `passing_order_4` | int8 | Yes | 4ã‚³ãƒ¼ãƒŠãƒ¼é€šéé †ä½ | 2 |
| `last_3f_time` | float32 | Yes | ä¸ŠãŒã‚Š3Fï¼ˆç§’ï¼‰ | 34.5 |
| `time_except_last3f` | float32 | Yes | ä¸ŠãŒã‚Šé™¤ãå‰åŠã‚¿ã‚¤ãƒ  | 108.8 |
| `pace_index` | float32 | Yes | ãƒšãƒ¼ã‚¹æŒ‡æ¨™ | 3.15 |
| `position_change_1_2` | int8 | Yes | 1â†’2ã‚³ãƒ¼ãƒŠãƒ¼é †ä½å¤‰å‹• | -1 |
| `position_change_2_3` | int8 | Yes | 2â†’3ã‚³ãƒ¼ãƒŠãƒ¼é †ä½å¤‰å‹• | -1 |
| `position_change_3_4` | int8 | Yes | 3â†’4ã‚³ãƒ¼ãƒŠãƒ¼é †ä½å¤‰å‹• | -1 |
| `final_corner_to_finish` | int8 | Yes | æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼â†’ç€é †å¤‰å‹• | -1 |
| `win_odds` | float32 | Yes | å˜å‹ã‚ªãƒƒã‚º | 3.2 |
| `popularity` | int8 | Yes | äººæ°— | 2 |
| `popularity_finish_diff` | int8 | Yes | äººæ°—ã¨ç€é †ã®å·® | -1 |
| `horse_weight` | int16 | Yes | é¦¬ä½“é‡ï¼ˆkgï¼‰ | 476 |
| `horse_weight_change` | int8 | Yes | é¦¬ä½“é‡å¢—æ¸› | +2 |
| `trainer_id` | string | Yes | èª¿æ•™å¸«ID | "05678" |
| `trainer_name` | string | Yes | èª¿æ•™å¸«å | "å €å®£è¡Œ" |
| `owner_name` | string | Yes | é¦¬ä¸»å | "ã‚µãƒ³ãƒ‡ãƒ¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°" |
| `prize_money` | int32 | Yes | ç²å¾—è³é‡‘ï¼ˆä¸‡å††ï¼‰ | 50000 |

---

### 2. shutuba.parquetï¼ˆå‡ºé¦¬è¡¨ï¼‰

**ä¸»ã‚­ãƒ¼**: `(race_id, horse_number)`

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | Nullable | èª¬æ˜ | ä¾‹ |
|---------|---------|----------|------|---|
| `race_id` | string | No | ãƒ¬ãƒ¼ã‚¹ID | "202310010811" |
| `race_date` | date | No | ãƒ¬ãƒ¼ã‚¹é–‹å‚¬æ—¥ | "2023-10-01" |
| `bracket_number` | int8 | Yes | æ ç•ª | 4 |
| `horse_number` | int8 | No | é¦¬ç•ª | 7 |
| `horse_id` | string | Yes | é¦¬ID | "2020104567" |
| `horse_name` | string | Yes | é¦¬å | "ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«" |
| `sex` | string | Yes | æ€§åˆ¥ | "ç‰¡" |
| `age` | int8 | Yes | å¹´é½¢ | 3 |
| `basis_weight` | float32 | Yes | æ–¤é‡ | 57.0 |
| `jockey_id` | string | Yes | é¨æ‰‹ID | "01234" |
| `jockey_name` | string | Yes | é¨æ‰‹å | "ç¦æ°¸ç¥ä¸€" |
| `trainer_id` | string | Yes | èª¿æ•™å¸«ID | "05678" |
| `trainer_name` | string | Yes | èª¿æ•™å¸«å | "å €å®£è¡Œ" |
| `horse_weight` | int16 | Yes | é¦¬ä½“é‡ | 476 |
| `horse_weight_change` | int8 | Yes | é¦¬ä½“é‡å¢—æ¸› | +2 |
| `morning_odds` | float32 | Yes | æœã‚ªãƒƒã‚º | 3.5 |
| `morning_popularity` | int8 | Yes | æœäººæ°— | 2 |
| `blinkers` | boolean | Yes | ãƒ–ãƒªãƒ³ã‚«ãƒ¼è£…ç€ | true |
| `prediction_mark` | string | Yes | äºˆæƒ³å° | "â—" / "â—‹" / "â–²" |
| `scratched` | boolean | Yes | å‡ºèµ°å–æ¶ˆãƒ•ãƒ©ã‚° | false |

---

### 3. horses.parquetï¼ˆé¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ï¼‰

**ä¸»ã‚­ãƒ¼**: `horse_id`

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | Nullable | èª¬æ˜ | ä¾‹ |
|---------|---------|----------|------|---|
| `horse_id` | string | No | é¦¬ID | "2020104567" |
| `horse_name` | string | Yes | é¦¬å | "ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«" |
| `birth_date` | date | Yes | ç”Ÿå¹´æœˆæ—¥ | "2017-03-15" |
| `sex` | string | Yes | æ€§åˆ¥ | "ç‰¡" / "ç‰" |
| `coat_color` | string | Yes | æ¯›è‰² | "é¹¿æ¯›" / "æ —æ¯›" / "é’é¹¿æ¯›" |
| `trainer_id` | string | Yes | ç®¡ç†èª¿æ•™å¸«ID | "05678" |
| `trainer_name` | string | Yes | ç®¡ç†èª¿æ•™å¸«å | "å €å®£è¡Œ" |
| `owner_name` | string | Yes | é¦¬ä¸»å | "ã‚µãƒ³ãƒ‡ãƒ¼ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°" |
| `breeder_name` | string | Yes | ç”Ÿç”£è€…å | "ãƒãƒ¼ã‚¶ãƒ³ãƒ•ã‚¡ãƒ¼ãƒ " |
| `producing_area` | string | Yes | ç”£åœ° | "åŒ—æµ·é“" / "æ—¥é«˜" |
| `sire_id` | string | Yes | çˆ¶ID | "2012100123" |
| `sire_name` | string | Yes | çˆ¶å | "ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ" |
| `dam_id` | string | Yes | æ¯ID | "2010105678" |
| `dam_name` | string | Yes | æ¯å | "ãƒ­ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚µãƒƒãƒˆ" |
| `damsire_id` | string | Yes | æ¯çˆ¶ID | "1997101234" |
| `damsire_name` | string | Yes | æ¯çˆ¶å | "Unbridled's Song" |
| `height_cm` | int16 | Yes | é¦¬ä½“é«˜ï¼ˆcmï¼‰ | 162 |
| `chest_girth_cm` | int16 | Yes | èƒ¸å›²ï¼ˆcmï¼‰ | 185 |
| `cannon_bone_cm` | float32 | Yes | ç®¡å›²ï¼ˆcmï¼‰ | 21.0 |
| `sale_price` | int32 | Yes | ã‚»ãƒªå–å¼•ä¾¡æ ¼ï¼ˆä¸‡å††ï¼‰ | 45000 |

---

### 4. pedigrees.parquetï¼ˆè¡€çµ±ï¼‰

**ä¸»ã‚­ãƒ¼**: `(horse_id, generation, ancestor_id)`

| ã‚«ãƒ©ãƒ å | ãƒ‡ãƒ¼ã‚¿å‹ | Nullable | èª¬æ˜ | ä¾‹ |
|---------|---------|----------|------|---|
| `horse_id` | string | No | å¯¾è±¡é¦¬ID | "2020104567" |
| `generation` | int8 | No | ä¸–ä»£ï¼ˆ1-5ï¼‰ | 1 (çˆ¶), 2 (ç¥–çˆ¶), ... |
| `ancestor_id` | string | Yes | å…ˆç¥–é¦¬ID | "2012100123" |
| `ancestor_name` | string | Yes | å…ˆç¥–é¦¬å | "ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ" |
| `ancestor_birth_year` | int16 | Yes | å…ˆç¥–é¦¬ç”Ÿå¹´ | 2002 |
| `ancestor_coat_color` | string | Yes | å…ˆç¥–é¦¬æ¯›è‰² | "é¹¿æ¯›" |

**è¡€çµ±æ§‹é€ ï¼ˆ5ä¸–ä»£ï¼‰**:
```
Generation 1: çˆ¶(sire), æ¯(dam) â†’ 2é ­
Generation 2: çˆ¶çˆ¶, çˆ¶æ¯, æ¯çˆ¶, æ¯æ¯ â†’ 4é ­
Generation 3: 8é ­
Generation 4: 16é ­
Generation 5: 32é ­
åˆè¨ˆ: 2 + 4 + 8 + 16 + 32 = 62é ­/é¦¬
```

---

### 5. features.parquetï¼ˆç‰¹å¾´é‡ï¼‰

**ä¸»ã‚­ãƒ¼**: `(race_id, horse_number)`
**ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³**: `year`, `month`

| ã‚«ãƒ†ã‚´ãƒª | ç‰¹å¾´é‡ä¾‹ | ãƒ‡ãƒ¼ã‚¿å‹ |
|---------|---------|---------|
| **ãƒ¬ãƒ¼ã‚¹ç‰¹å¾´** | distance_m, track_surface, weather, track_condition, venue, race_class | int16, string |
| **é¦¬ç‰¹å¾´** | age, sex, avg_finish_last3, avg_finish_last5, win_rate_last10, days_since_last_race | int8, float32 |
| **é¨æ‰‹ç‰¹å¾´** | jockey_win_rate, jockey_place_rate, jockey_roi, jockey_venue_win_rate, combo_overperform | float32 |
| **èª¿æ•™å¸«ç‰¹å¾´** | trainer_win_rate, trainer_place_rate, trainer_roi | float32 |
| **è¡€çµ±ç‰¹å¾´** | sire_avg_finish, dam_avg_finish, nicks_avg_finish, sire_course_avg_finish | float32 |
| **æ´¾ç”Ÿç‰¹å¾´** | pace_index, position_change_*, popularity_finish_diff, relative_odds, running_style, time_deviation | float32, string |
| **ã‚³ãƒ¼ã‚¹ç‰¹å¾´** | bracket_avg_finish, course_suitability | float32 |

**ã‚«ãƒ©ãƒ ç·æ•°**: ç´„200åˆ—

---

## ğŸ”‘ ä¸»ã‚­ãƒ¼ã¨å¤–éƒ¨ã‚­ãƒ¼

### ä¸»ã‚­ãƒ¼

| ãƒ†ãƒ¼ãƒ–ãƒ« | ä¸»ã‚­ãƒ¼ | å‚™è€ƒ |
|---------|-------|------|
| races | `(race_id, horse_number)` | è¤‡åˆã‚­ãƒ¼ |
| shutuba | `(race_id, horse_number)` | è¤‡åˆã‚­ãƒ¼ |
| horses | `horse_id` | å˜ä¸€ã‚­ãƒ¼ |
| pedigrees | `(horse_id, generation, ancestor_id)` | è¤‡åˆã‚­ãƒ¼ |
| features | `(race_id, horse_number)` | è¤‡åˆã‚­ãƒ¼ |

### å¤–éƒ¨ã‚­ãƒ¼

```
races.race_id â†’ shutuba.race_id
races.horse_id â†’ horses.horse_id
shutuba.horse_id â†’ horses.horse_id
horses.horse_id â†’ pedigrees.horse_id
features.race_id â†’ races.race_id
features.horse_id â†’ horses.horse_id
```

### IDå½¢å¼

#### race_idï¼ˆ12æ¡ï¼‰

```
YYYYPPNNDDRR
2023 10 01 08 11
â”‚    â”‚  â”‚  â”‚  â””â”€ ãƒ¬ãƒ¼ã‚¹ç•ªå·ï¼ˆ2æ¡ï¼‰
â”‚    â”‚  â”‚  â””â”€â”€â”€ é–‹å‚¬æ—¥ï¼ˆ2æ¡ï¼‰
â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€ é–‹å‚¬å›æ¬¡ï¼ˆ2æ¡ï¼‰
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰ï¼ˆ2æ¡ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¹´ï¼ˆ4æ¡ï¼‰

ä¾‹: 202310010811
â†’ 2023å¹´ã€æ±äº¬ï¼ˆ10ï¼‰ã€1å›ã€8æ—¥ç›®ã€11R
```

**ç«¶é¦¬å ´ã‚³ãƒ¼ãƒ‰**:
```
05 = æ±äº¬
06 = ä¸­å±±
08 = äº¬éƒ½
09 = é˜ªç¥
01 = æœ­å¹Œ
02 = å‡½é¤¨
03 = ç¦å³¶
04 = æ–°æ½Ÿ
07 = å°å€‰
```

#### horse_idï¼ˆ10æ¡ï¼‰

```
YYYYNNNNNN
2020 104567
â”‚    â””â”€â”€â”€â”€â”€ é€£ç•ªï¼ˆ6æ¡ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‡ºç”Ÿå¹´ï¼ˆ4æ¡ï¼‰

ä¾‹: 2020104567
â†’ 2020å¹´ç”Ÿã¾ã‚Œã€é€£ç•ª104567
```

#### jockey_id / trainer_idï¼ˆ5æ¡ï¼‰

```
01234
â””â”€ é€£ç•ªï¼ˆ5æ¡ï¼‰
```

---

## ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‹å®šç¾©

### Pandas Nullable Integer Types

**é‡è¦**: æ•´æ•°ã‚«ãƒ©ãƒ ã«ã¯å¿…ãš`Int64`, `Int32`, `Int16`, `Int8`ã‚’ä½¿ç”¨ï¼ˆæ¬ æå€¤å¯¾å¿œï¼‰

```python
# âŒ NG: float64ã§æ•´æ•°ã‚’è¡¨ç¾
df['finish_position'] = df['finish_position'].astype('float64')

# âœ… OK: nullable integer
df['finish_position'] = df['finish_position'].astype('Int64')
```

### ãƒ‡ãƒ¼ã‚¿å‹ãƒãƒƒãƒ”ãƒ³ã‚°

| ç”¨é€” | Pandaså‹ | Parquetå‹ | ä¾‹ |
|-----|---------|----------|---|
| IDï¼ˆ12æ¡ï¼‰ | string | STRING | "202310010811" |
| IDï¼ˆ10æ¡ï¼‰ | string | STRING | "2020104567" |
| ç€é † | Int8 | INT8 | 1 |
| é¦¬ç•ªãƒ»æ ç•ª | Int8 | INT8 | 7 |
| å¹´é½¢ | Int8 | INT8 | 3 |
| è·é›¢ | Int16 | INT16 | 2400 |
| é¦¬ä½“é‡ | Int16 | INT16 | 476 |
| è³é‡‘ | Int32 | INT32 | 50000 |
| ã‚¿ã‚¤ãƒ ï¼ˆç§’ï¼‰ | float32 | FLOAT | 143.3 |
| ã‚ªãƒƒã‚º | float32 | FLOAT | 3.2 |
| æ—¥ä»˜ | date | DATE32 | "2023-10-01" |
| ãƒ–ãƒ¼ãƒªã‚¢ãƒ³ | boolean | BOOL | true |
| ã‚«ãƒ†ã‚´ãƒª | string | STRING | "èŠ" |

---

## ğŸ—‚ï¸ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ‹ãƒ³ã‚°æˆ¦ç•¥

### features.parquet ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³

```
data/features/parquet/
â”œâ”€â”€ year=2020/
â”‚   â”œâ”€â”€ month=01/
â”‚   â”‚   â””â”€â”€ features.parquet
â”‚   â”œâ”€â”€ month=02/
â”‚   â”‚   â””â”€â”€ features.parquet
â”‚   â””â”€â”€ ...
â”œâ”€â”€ year=2021/
â”‚   â”œâ”€â”€ month=01/
â”‚   â””â”€â”€ ...
â””â”€â”€ year=2023/
    â”œâ”€â”€ month=01/
    â”œâ”€â”€ month=02/
    â””â”€â”€ month=10/
        â””â”€â”€ features.parquet
```

**ãƒ¡ãƒªãƒƒãƒˆ**:
1. æœŸé–“ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ãŒé«˜é€Ÿ
2. å¢—åˆ†æ›´æ–°ãŒå®¹æ˜“
3. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡å‰Šæ¸›

**èª­ã¿è¾¼ã¿ä¾‹**:
```python
import pyarrow.parquet as pq

# 2023å¹´10æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿èª­ã¿è¾¼ã¿
table = pq.read_table(
    'data/features/parquet/',
    filters=[
        ('year', '=', 2023),
        ('month', '=', 10)
    ]
)
df = table.to_pandas()
```

---

## âœ… ãƒ‡ãƒ¼ã‚¿å“è³ªãƒ«ãƒ¼ãƒ«

### 1. NOT NULLåˆ¶ç´„

| ã‚«ãƒ©ãƒ  | ç†ç”± |
|-------|------|
| race_id | ä¸»ã‚­ãƒ¼ |
| horse_number | ä¸»ã‚­ãƒ¼ |
| race_date | æ™‚ç³»åˆ—åˆ†æã«å¿…é ˆ |

### 2. ç¯„å›²åˆ¶ç´„

```python
# ç€é †: 1ã€œå‡ºèµ°é ­æ•°
assert 1 <= finish_position <= head_count

# é¦¬ç•ª: 1ã€œ18ï¼ˆé€šå¸¸ã¯1ã€œ16ï¼‰
assert 1 <= horse_number <= 18

# å¹´é½¢: 2ã€œ10ï¼ˆé€šå¸¸ã¯2ã€œ7ï¼‰
assert 2 <= age <= 10

# è·é›¢: 800ã€œ4000m
assert 800 <= distance_m <= 4000
```

### 3. å¤–ã‚Œå€¤æ¤œå‡º

```python
# ã‚¿ã‚¤ãƒ ã®3Ïƒãƒã‚§ãƒƒã‚¯
mean_time = df.groupby(['distance_m', 'track_surface'])['finish_time_seconds'].mean()
std_time = df.groupby(['distance_m', 'track_surface'])['finish_time_seconds'].std()

outlier_mask = (
    (df['finish_time_seconds'] < mean_time - 3 * std_time) |
    (df['finish_time_seconds'] > mean_time + 3 * std_time)
)

df.loc[outlier_mask, 'time_outlier_flag'] = True
```

### 4. å‚ç…§æ•´åˆæ€§

```python
# races.horse_id ã¯ horses.horse_id ã«å­˜åœ¨ã™ã‚‹ã“ã¨
assert df['horse_id'].isin(horses_df['horse_id']).all()

# races.race_id ã¯ shutuba.race_id ã«å­˜åœ¨ã™ã‚‹ã“ã¨
assert df['race_id'].isin(shutuba_df['race_id']).all()
```

### 5. è«–ç†æ•´åˆæ€§

```python
# äººæ°—ã¨ç€é †ã®å·®ãŒæ¥µç«¯ã§ãªã„ã“ã¨ï¼ˆÂ±10ä»¥å†…ï¼‰
assert abs(df['popularity_finish_diff']).max() <= 10

# é¦¬ä½“é‡ãŒå¸¸è­˜çš„ãªç¯„å›²ï¼ˆ300kgã€œ600kgï¼‰
assert 300 <= df['horse_weight'] <= 600
```

---

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [04_ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°è©³ç´°.md](./04_ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°è©³ç´°.md)
