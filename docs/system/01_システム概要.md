# 01_システム概要

**最終更新日**: 2025-11-18
**バージョン**: 2.0
**対象読者**: 開発者、データサイエンティスト、システム保守担当者

---

## 📑 目次

1. [プロジェクトの目的](#プロジェクトの目的)
2. [システムの全体像](#システムの全体像)
3. [技術スタック](#技術スタック)
4. [主要統計情報](#主要統計情報)
5. [システム特徴](#システム特徴)
6. [主要コンポーネント](#主要コンポーネント)
7. [データフロー概要](#データフロー概要)
8. [アウトプット](#アウトプット)
9. [制約事項](#制約事項)
10. [参考資料](#参考資料)

---

## 🎯 プロジェクトの目的

### ビジョン

KeibaAI_v2は、**競馬レース結果を高精度で予測し、統計的に有利な投資判断を支援する**AIシステムです。単なる予想システムではなく、以下の3つの柱で構成されています：

1. **確率的予測モデル** - 各馬の勝率を数学的に推定
2. **リスク管理機能** - ポートフォリオ理論に基づく賭け金配分
3. **パフォーマンス追跡** - Brier Score、ECE、ROIによる精度検証

### ミッション

従来の競馬予想システムとの違い：

| 従来システム | KeibaAI_v2 |
|------------|------------|
| 単純な着順予測 | **確率分布**の推定（μ, σ, ν） |
| 経験則ベースの判断 | **モンテカルロシミュレーション**（1,000回試行） |
| 固定金額の投資 | **Kelly基準**による最適化 |
| 主観的な評価 | **Brier Score**による客観評価 |
| クラウド依存 | **完全ローカル**実行（コスト0円） |

---

## 🔍 システムの全体像

### アーキテクチャ概略図

```
┌─────────────────────────────────────────────────────────────────┐
│                        KeibaAI_v2 System                         │
│                     (Keiba = 競馬 = Horse Racing)                 │
└─────────────────────────────────────────────────────────────────┘

【Phase 0】データ取得（深夜バッチ 03:00）
    ┌──────────────────────────────────────────┐
    │  netkeiba.com / JRA公式サイト            │
    │  ├─ レース結果 (race results)            │
    │  ├─ 出馬表 (entry lists)                │
    │  ├─ 馬プロフィール (horse profiles)      │
    │  └─ 血統データ (pedigrees, 5世代)        │
    └──────────┬───────────────────────────────┘
               ↓ スクレイピング（23KB scraper）
    ┌──────────────────────────────────────────┐
    │  data/raw/html/*.bin (EUC-JP)            │
    │  └─ 278,098レース分のHTML                │
    └──────────┬───────────────────────────────┘

【Phase 1】構造化（パース処理）
               ↓ 4種類のHTMLパーサー
    ┌──────────────────────────────────────────┐
    │  data/parsed/parquet/                    │
    │  ├─ races.parquet (27+列, 278K行)        │
    │  ├─ shutuba.parquet (21列)               │
    │  ├─ horses.parquet (プロフィール)        │
    │  └─ pedigrees.parquet (1.3M行, 5世代)    │
    └──────────┬───────────────────────────────┘

【Phase 2】特徴量生成（24KB engine）
               ↓ 6カテゴリの特徴量抽出
    ┌──────────────────────────────────────────┐
    │  data/features/parquet/                  │
    │  └─ year=YYYY/month=MM/ (パーティション)  │
    │      ├─ レース特徴（距離、馬場、天候）    │
    │      ├─ 馬特徴（過去成績、馬体重推移）    │
    │      ├─ 騎手特徴（勝率、連対率、ROI）     │
    │      ├─ 調教師特徴（厩舎統計）           │
    │      ├─ 血統特徴（父系/母系エンコード）   │
    │      └─ 派生特徴（ペース指標、位置取り）  │
    └──────────┬───────────────────────────────┘

【Phase 3】モデル訓練（週次/オンデマンド）
               ↓ 3パラメータモデル
    ┌──────────────────────────────────────────┐
    │  LightGBM Gradient Boosting              │
    │  ├─ μ (mu): 期待完走時間                 │
    │  ├─ σ (sigma): 馬固有の分散              │
    │  └─ ν (nu): レース全体の混沌度           │
    │      → t分布による確率推定               │
    │      → Temperature Scalingで校正         │
    └──────────┬───────────────────────────────┘

【Phase 4】予測実行（レース日朝 10:00）
               ↓ 推論パイプライン
    ┌──────────────────────────────────────────┐
    │  data/predictions/parquet/               │
    │  └─ race_id/                             │
    │      ├─ mu_predictions (各馬の期待値)     │
    │      ├─ sigma_predictions (不確実性)      │
    │      └─ nu_predictions (レース混沌度)     │
    └──────────┬───────────────────────────────┘

【Phase 5】シミュレーション（レース10-30分前）
               ↓ モンテカルロ法 (K=1,000回)
    ┌──────────────────────────────────────────┐
    │  for k in 1..K:                          │
    │    各馬iの走行時間 ~ t_ν(μ_i, σ_i²)      │
    │    着順をソート → 勝敗記録               │
    │  P(win) = count(1st) / K                 │
    └──────────┬───────────────────────────────┘
               ↓
    ┌──────────────────────────────────────────┐
    │  data/simulations/race_id.json           │
    │  └─ 各馬の勝率/連対率/複勝率             │
    └──────────┬───────────────────────────────┘

【Phase 6】ポートフォリオ最適化（締切直前）
               ↓ Kelly基準による配分計算
    ┌──────────────────────────────────────────┐
    │  JRAオッズ取得（Selenium）               │
    │  + シミュレーション確率                  │
    │  → Fractional Kelly Criterion            │
    │     Maximize: Σ f_i * log(1 + b_i*o_i)   │
    │     s.t. Σ f_i ≤ W_0, f_i ≥ 0            │
    └──────────┬───────────────────────────────┘
               ↓
    ┌──────────────────────────────────────────┐
    │  data/orders/race_id_order.json          │
    │  └─ 推奨投資額（馬番、金額、期待値）      │
    └──────────┬───────────────────────────────┘

【Phase 7】実行（手動/無効化）
               ↓ ペーパートレードのみ
    ┌──────────────────────────────────────────┐
    │  ※実際の発注は無効化                     │
    │  └─ バックテスト用ログ記録のみ           │
    └──────────────────────────────────────────┘

【Phase 8】モニタリング（レース後）
               ↓ パフォーマンス評価
    ┌──────────────────────────────────────────┐
    │  実際の結果と比較                         │
    │  ├─ Brier Score (確率精度)               │
    │  ├─ ECE (Expected Calibration Error)     │
    │  ├─ ROI (投資収益率)                     │
    │  └─ Hit Rate (的中率)                    │
    └──────────────────────────────────────────┘
```

---

## 💻 技術スタック

### プログラミング言語

| 言語 | バージョン | 用途 |
|-----|----------|------|
| **Python** | 3.10+ | メイン言語（100%） |
| YAML | 1.2 | 設定ファイル |
| Markdown | CommonMark | ドキュメント |
| SQL | SQLite 3 | メタデータ管理 |

### コアライブラリ

#### データ処理

| ライブラリ | バージョン | 用途 |
|-----------|----------|------|
| **pandas** | 2.0+ | DataFrame操作、時系列処理 |
| **NumPy** | 1.24+ | 数値計算、配列操作 |
| **pyarrow** | 12.0+ | Parquetファイル読み書き |
| **scikit-learn** | 1.3+ | 前処理、評価指標 |

#### 機械学習

| ライブラリ | バージョン | 用途 |
|-----------|----------|------|
| **LightGBM** | 4.0+ | 勾配ブースティング（Ranker/Regressor） |
| **scipy** | 1.11+ | 統計分布（t分布）、最適化 |

#### Webスクレイピング

| ライブラリ | バージョン | 用途 |
|-----------|----------|------|
| **requests** | 2.31+ | HTTP通信 |
| **BeautifulSoup4** | 4.12+ | HTML解析 |
| **Selenium** | 4.10+ | 動的コンテンツ取得（JRAオッズ） |
| **lxml** | 4.9+ | XML/HTMLパーサー |

#### その他

| ライブラリ | バージョン | 用途 |
|-----------|----------|------|
| **pytest** | 7.4+ | テストフレームワーク |
| **PyYAML** | 6.0+ | YAML設定読み込み |
| **tqdm** | 4.65+ | プログレスバー |
| **logging** | 標準ライブラリ | ログ管理 |

### ストレージフォーマット

| 形式 | 用途 | 特徴 |
|-----|------|------|
| **Parquet** | 構造化データ保存 | 列指向、圧縮効率◎、型安全 |
| **Binary (.bin)** | 生HTMLキャッシュ | EUC-JP保持、再パース可能 |
| **SQLite** | メタデータ管理 | パース状態、エラーログ |
| **JSON** | シミュレーション結果 | 可読性高、デバッグ容易 |

### 開発ツール

| ツール | 用途 |
|-------|------|
| **Git** | バージョン管理 |
| **GitHub** | リモートリポジトリ |
| **Jupyter Notebook** | データ探索、可視化 |
| **VSCode / PyCharm** | IDE（推奨） |

---

## 📊 主要統計情報

### データセット規模

| 項目 | 数値 | 備考 |
|-----|------|------|
| **総レース数** | 278,098件 | 2000年〜現在 |
| **総馬数** | ~50,000頭 | アクティブ + 引退馬 |
| **血統レコード** | 1,377,361件 | 5世代分（2^5-1 = 31先祖/頭） |
| **騎手数** | ~300名 | 現役 + 過去 |
| **調教師数** | ~250名 | 美浦 + 栗東 |

### コードベース規模

| 項目 | 行数 | ファイル数 |
|-----|------|----------|
| **プロダクションコード** | ~5,025行 | 40+ |
| **テストコード** | ~1,200行 | 25+ |
| **ドキュメント** | ~3,000行 | 15+ |
| **デバッグスクリプト** | ~800行 | 20+ |

### ストレージ使用量（概算）

| データ種別 | サイズ | 備考 |
|-----------|-------|------|
| 生HTML (.bin) | ~15 GB | 圧縮可能 |
| Parquetファイル | ~2 GB | 列指向圧縮済み |
| モデルファイル | ~500 MB | LightGBM + 校正器 |
| ログファイル | ~100 MB | ローテーション管理 |

---

## ⭐ システム特徴

### 1. 確率的アプローチ

従来の着順予測（1位、2位...）ではなく、**勝率の分布**を推定：

```python
# 従来システム
prediction = [1, 5, 3, ...]  # 各馬の着順

# KeibaAI_v2
μ = [72.3, 73.1, 71.8, ...]  # 期待完走時間（秒）
σ = [1.2, 2.5, 0.8, ...]     # 不確実性
ν = 5.0                      # レース全体の混沌度

# モンテカルロで確率化
P(win) = [0.35, 0.12, 0.42, ...]  # 各馬の勝率
```

### 2. 金融工学の応用

**Kelly基準**（1956年ノーベル賞理論）による賭け金配分：

- **目的**: 長期的な資産成長の最大化
- **制約**: 破産リスクの最小化
- **手法**: 対数効用関数の最適化

```python
# フラクショナルKelly（リスク調整版）
f* = (p * (o - 1) - (1 - p)) / (o - 1) * kelly_fraction
# p: 勝率, o: オッズ, kelly_fraction: 0.25（保守的）
```

### 3. データ品質管理

- **4段階フォールバック**: HTML解析失敗時の代替ロジック
- **型安全性**: pandas nullable integer (`Int64`) 使用
- **欠損値戦略**: 列ごとに最適な補完方法
- **外れ値検出**: 3σ法による異常値フラグ

### 4. 完全ローカル実行

- **クラウドコスト**: 0円
- **データ主権**: 全データをローカル保持
- **プライバシー**: 外部送信なし
- **オフライン動作**: インターネット不要（スクレイピング以外）

---

## 🧩 主要コンポーネント

### 1. Preparingモジュール（データ取得）

**ファイル**: `keibaai/src/modules/preparing/_scrape_html.py` (23KB)

**機能**:
- netkeiba.com からHTMLをスクレイピング
- BAN対策（ランダムUser-Agent、スリープ、リトライ）
- HTTP 400検出 → 60秒待機
- EUC-JPエンコーディング保持

**出力**: `data/raw/html/*.bin`

### 2. Parsersモジュール（構造化）

**ファイル**: `keibaai/src/modules/parsers/`

**4種類のパーサー**:
1. `results_parser.py` (14KB) - レース結果
2. `shutuba_parser.py` (14KB) - 出馬表
3. `horse_info_parser.py` (16KB) - 馬プロフィール
4. `pedigree_parser.py` (9KB) - 血統5世代

**共通ユーティリティ**: `common_utils.py`
- `parse_time_to_seconds()`: "1:23.4" → 83.4秒
- `parse_margin_to_seconds()`: "3馬身" → 0.6秒
- `parse_sex_age()`: "牡3" → sex="牡", age=3

### 3. Featuresモジュール（特徴量生成）

**ファイル**: `keibaai/src/modules/features/feature_engine.py` (25KB)

**6カテゴリの特徴量**:
- レース特徴: distance_m, track_surface, weather, track_condition
- 馬特徴: 過去3走平均着順、馬体重推移、休養期間
- 騎手特徴: win_rate, place_rate, jockey_roi
- 調教師特徴: stable_win_rate, trainer_roi
- 血統特徴: sire_id, dam_id, damsire_id（エンコード済み）
- 派生特徴: pace_index, position_change, popularity_finish_diff

### 4. Modelsモジュール（機械学習）

**ファイル**: `keibaai/src/modules/models/model_train.py`

**モデル構成**:
```python
# μモデル: LambdaRank → Regression
MuEstimator = Pipeline([
    ('ranker', LGBMRanker(objective='lambdarank')),
    ('regressor', LGBMRegressor(objective='regression'))
])

# σモデル: 分散推定
SigmaEstimator = LGBMRegressor(
    objective='regression',
    metric='rmse'
)

# νモデル: 自由度推定
NuEstimator = LGBMRegressor(
    objective='regression',
    metric='mae'
)
```

### 5. Simモジュール（シミュレーション）

**ファイル**: `keibaai/src/modules/sim/simulator.py`

**アルゴリズム**:
```python
for k in range(K=1000):
    for horse_i in horses:
        time_i_k = scipy.stats.t.rvs(
            df=nu,
            loc=mu_i,
            scale=sigma_i
        )
    finish_order = np.argsort(times)
    record_winner(finish_order)

win_prob = wins / K
```

### 6. Optimizerモジュール（ポートフォリオ最適化）

**ファイル**: `keibaai/src/modules/optimizer/optimizer.py`

**最適化問題**:
```
Maximize: Σ f_i * log(1 + (odds_i - 1) * f_i / W_0)
Subject to:
  Σ f_i ≤ W_0  # 資本制約
  f_i ≥ 0      # 非負制約
  EV_i > threshold  # 期待値フィルタ
```

---

## 🌊 データフロー概要

### 日次運用フロー

| 時刻 | フェーズ | 処理 | 所要時間 |
|-----|---------|------|---------|
| **03:00** | スクレイピング | 前日レース結果取得 | 30-60分 |
| **04:00** | パース | HTML → Parquet変換 | 10-20分 |
| **04:30** | 特徴量生成 | 新規レコード処理 | 5-10分 |
| **10:00** | 予測 | 当日レース予測 | 1-2分 |
| **レース10分前** | シミュレーション | MC 1,000回 | 30秒 |
| **レース5分前** | 最適化 | Kelly配分計算 | 10秒 |
| **レース後** | モニタリング | 精度評価 | 1分 |

### 週次運用フロー

| 曜日 | タスク | 内容 |
|-----|--------|------|
| **日曜夜** | モデル再訓練 | 1週間分のデータで更新 |
| **月曜** | バックテスト | 先週の予測精度検証 |
| **火曜** | レポート作成 | Brier Score, ECE, ROI集計 |

---

## 📤 アウトプット

### 1. 予測結果 (predictions/)

```json
{
  "race_id": "202310010811",
  "race_date": "2023-10-01",
  "predictions": [
    {
      "horse_number": 5,
      "horse_name": "サンプルホース",
      "mu": 72.3,
      "sigma": 1.2,
      "win_prob": 0.35,
      "place_prob": 0.68
    },
    ...
  ]
}
```

### 2. 推奨投資 (orders/)

```json
{
  "race_id": "202310010811",
  "total_capital": 100000,
  "recommended_bets": [
    {
      "horse_number": 5,
      "bet_type": "win",
      "amount": 8500,
      "odds": 3.2,
      "expected_value": 1.12
    }
  ]
}
```

### 3. パフォーマンスレポート (metrics/)

```json
{
  "period": "2023-W40",
  "races_predicted": 156,
  "brier_score": 0.18,
  "ece": 0.042,
  "roi": 1.08,
  "hit_rate": 0.34
}
```

---

## ⚠️ 制約事項

### 技術的制約

1. **スクレイピング速度制限**
   - 最小間隔: 2.5秒/リクエスト
   - HTTP 400検出時: 60秒停止
   - 1日あたり取得上限: 約14,000ページ

2. **メモリ使用量**
   - 特徴量生成時: 最大8GB RAM
   - モデル訓練時: 最大16GB RAM
   - 推奨環境: 32GB RAM

3. **計算時間**
   - モンテカルロ1,000回: 30秒/レース
   - モデル訓練（全データ）: 2-3時間
   - 予測実行: 1秒/レース

### 法的・倫理的制約

1. **自動発注の禁止**
   - executor モジュールはデフォルト無効
   - ペーパートレードのみ実装
   - 実行には明示的な有効化が必要

2. **データ利用規約**
   - netkeiba.com 利用規約の遵守
   - 商用利用は禁止
   - 個人研究目的のみ

3. **ギャンブル依存症対策**
   - システムは補助ツール
   - 過度な投資を推奨しない
   - Kelly fraction = 0.25（保守的設定）

---

## 📚 参考資料

### 数学的背景

1. **Kelly Criterion**
   - Kelly, J. L. (1956). "A New Interpretation of Information Rate"
   - Thorp, E. O. (2008). "The Kelly Capital Growth Investment Criterion"

2. **Probability Calibration**
   - Platt, J. (1999). "Probabilistic Outputs for SVMs"
   - Guo, C. et al. (2017). "On Calibration of Modern Neural Networks"

3. **Monte Carlo Methods**
   - Metropolis, N. (1987). "The Beginning of the Monte Carlo Method"

### 競馬データ分析

1. **netkeiba.com** - データソース
2. **JRA公式サイト** - オッズ情報
3. **競馬ブック** - レース分析（参考）

### 関連プロジェクト

1. **betfair** - 賭博取引所API
2. **pymc** - ベイズ統計モデリング
3. **mlflow** - ML実験管理

---

## 📞 次のステップ

このドキュメントで全体像を理解したら、以下の順序で詳細ドキュメントを読んでください：

1. [02_アーキテクチャ.md](./02_アーキテクチャ.md) - システム設計の詳細
2. [03_データモデル.md](./03_データモデル.md) - データスキーマ
3. [04_スクレイピング詳細.md](./04_スクレイピング詳細.md) - データ取得
4. [05_パース処理詳細.md](./05_パース処理詳細.md) - HTML解析
5. [06_特徴量エンジニアリング.md](./06_特徴量エンジニアリング.md) - 特徴量設計
6. [07_機械学習モデル.md](./07_機械学習モデル.md) - モデル詳細
7. [08_シミュレーションと最適化.md](./08_シミュレーションと最適化.md) - 予測と投資戦略
8. [09_設定とテスト.md](./09_設定とテスト.md) - 設定管理
9. [10_運用ガイド.md](./10_運用ガイド.md) - 実運用手順

---

**最終更新**: 2025-11-18
**作成者**: KeibaAI_v2 Development Team
**ライセンス**: MIT License (個人利用のみ)
