# 02_ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**æœ€çµ‚æ›´æ–°æ—¥**: 2025-11-18
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 2.0

---

## ğŸ“‘ ç›®æ¬¡

1. [ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦](#ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦)
2. [ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ](#ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ )
3. [ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ](#ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ)
4. [ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°](#ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°)
5. [ä¾å­˜é–¢ä¿‚](#ä¾å­˜é–¢ä¿‚)
6. [è¨­è¨ˆåŸå‰‡](#è¨­è¨ˆåŸå‰‡)
7. [æ‹¡å¼µæ€§](#æ‹¡å¼µæ€§)

---

## ğŸ—ï¸ ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                Application Layer (CLI Scripts)          â”‚
â”‚  run_scraping.py, run_parsing.py, generate_features.py â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Business Logic Layer (Modules)             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚Preparing â”‚ Parsers â”‚ Features â”‚  Models  â”‚  Sim   â”‚ â”‚
â”‚  â”‚(Scraping)â”‚  (HTML) â”‚ (Engine) â”‚(LightGBM)â”‚ (Monte â”‚ â”‚
â”‚  â”‚          â”‚         â”‚          â”‚          â”‚ Carlo) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚Optimizer â”‚Executor â”‚Monitoringâ”‚Constants â”‚          â”‚
â”‚  â”‚ (Kelly)  â”‚(Disabled)â”‚  (KPI)   â”‚  (URLs)  â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Data Access Layer                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Parquet   â”‚   SQLite    â”‚      File System     â”‚   â”‚
â”‚  â”‚  (pyarrow) â”‚ (metadata)  â”‚  (.bin, .json, logs) â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆç›¸é–¢å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ netkeiba   â”‚
â”‚   .com     â”‚â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                 â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Preparing   â”‚
         â”‚  (Scraper)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ .bin (EUC-JP)
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Parsers    â”‚
         â”‚  (4 types)   â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ .parquet
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Features   â”‚
         â”‚   Engine     â”‚
         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                â†“ features.parquet
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â†“                       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Models  â”‚          â”‚   Sim    â”‚
â”‚(LightGBM)â”‚â†â”€â”€â”€â”€â”€â”€â”€â”€â”‚ (MonteCarlo)
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                     â”‚
     â†“ Î¼,Ïƒ,Î½               â†“ P(win)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”
â”‚        Optimizer             â”‚
â”‚    (Kelly Criterion)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“ bet_amounts
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Executor      â”‚
â”‚   (DISABLED)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆ

```
KeibaAI_v2/
â”œâ”€â”€ keibaai/                    # ãƒ¡ã‚¤ãƒ³ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
â”‚   â”œâ”€â”€ src/                    # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ modules/            # ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”‚   â”‚   â”œâ”€â”€ preparing/      # ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°
â”‚   â”‚   â”‚   â”œâ”€â”€ parsers/        # HTMLãƒ‘ãƒ¼ã‚¹
â”‚   â”‚   â”‚   â”œâ”€â”€ features/       # ç‰¹å¾´é‡ã‚¨ãƒ³ã‚¸ãƒ³
â”‚   â”‚   â”‚   â”œâ”€â”€ models/         # æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”‚   â”œâ”€â”€ sim/            # ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”‚   â”œâ”€â”€ optimizer/      # ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ executor/       # æ³¨æ–‡å®Ÿè¡Œï¼ˆç„¡åŠ¹åŒ–ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ monitoring/     # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¿½è·¡
â”‚   â”‚   â”‚   â””â”€â”€ constants/      # å®šæ•°å®šç¾©
â”‚   â”‚   â”œâ”€â”€ features/           # ç‰¹å¾´é‡ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ models/             # ãƒ¢ãƒ‡ãƒ«è¨“ç·´ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ optimizer/          # æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â”œâ”€â”€ sim/                # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â”‚   â””â”€â”€ utils/              # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
â”‚   â”œâ”€â”€ configs/                # YAMLè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ5å€‹ï¼‰
â”‚   â”œâ”€â”€ data/                   # ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆ.gitignoreï¼‰
â”‚   â”‚   â”œâ”€â”€ raw/html/           # ç”ŸHTML (.bin)
â”‚   â”‚   â”‚   â”œâ”€â”€ race/           # ãƒ¬ãƒ¼ã‚¹çµæœ
â”‚   â”‚   â”‚   â”œâ”€â”€ shutuba/        # å‡ºé¦¬è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ horse/          # é¦¬ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â”‚   â””â”€â”€ ped/            # è¡€çµ±ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚   â”œâ”€â”€ parsed/parquet/     # ãƒ‘ãƒ¼ã‚¹æ¸ˆã¿Parquet
â”‚   â”‚   â”‚   â”œâ”€â”€ races/          # ãƒ¬ãƒ¼ã‚¹çµæœ
â”‚   â”‚   â”‚   â”œâ”€â”€ shutuba/        # å‡ºé¦¬è¡¨
â”‚   â”‚   â”‚   â”œâ”€â”€ horses/         # é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
â”‚   â”‚   â”‚   â””â”€â”€ pedigrees/      # è¡€çµ±
â”‚   â”‚   â”œâ”€â”€ features/parquet/   # ç‰¹å¾´é‡ï¼ˆå¹´æœˆã§ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³ï¼‰
â”‚   â”‚   â”‚   â”œâ”€â”€ year=2023/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ month=01/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ month=02/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ...
â”‚   â”‚   â”‚   â””â”€â”€ year=2024/
â”‚   â”‚   â”œâ”€â”€ models/             # è¨“ç·´æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«
â”‚   â”‚   â”‚   â””â”€â”€ {model_id}/
â”‚   â”‚   â”‚       â”œâ”€â”€ mu_model.txt
â”‚   â”‚   â”‚       â”œâ”€â”€ sigma_model.txt
â”‚   â”‚   â”‚       â”œâ”€â”€ nu_model.txt
â”‚   â”‚   â”‚       â””â”€â”€ calibrator.pkl
â”‚   â”‚   â”œâ”€â”€ simulations/        # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ
â”‚   â”‚   â”‚   â””â”€â”€ {race_id}.json
â”‚   â”‚   â”œâ”€â”€ orders/             # æ³¨æ–‡ãƒ­ã‚°
â”‚   â”‚   â”œâ”€â”€ logs/               # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ­ã‚°
â”‚   â”‚   â””â”€â”€ metadata/           # SQLiteãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
â”‚   â”‚       â””â”€â”€ db.sqlite3
â”‚   â”œâ”€â”€ tests/                  # ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
â”‚   â”‚   â”œâ”€â”€ unit/               # å˜ä½“ãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â”œâ”€â”€ integration/        # çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”‚   â””â”€â”€ regression/         # å›å¸°ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ infra/                  # ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ãƒ¼ãƒ‰
â”‚   â”‚   â”œâ”€â”€ docker/             # Dockerè¨­å®š
â”‚   â”‚   â””â”€â”€ sched/              # Cronè¨­å®šä¾‹
â”‚   â”œâ”€â”€ scripts/                # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”‚   â””â”€â”€ notebooks/              # Jupyter Notebook
â”œâ”€â”€ docs/                       # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
â”‚   â””â”€â”€ system/                 # ã‚·ã‚¹ãƒ†ãƒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæœ¬ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
â”œâ”€â”€ debug_*.py                  # ãƒ‡ãƒãƒƒã‚°ã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆ20+å€‹ï¼‰
â”œâ”€â”€ check_*.py                  # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ validate_*.py               # æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
â”œâ”€â”€ schema.md                   # ãƒ‡ãƒ¼ã‚¿ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”œâ”€â”€ PROGRESS.md                 # ãƒ‡ãƒ¼ã‚¿å“è³ªé€²æ—
â”œâ”€â”€ DEBUG_REPORT.md             # ãƒ‘ãƒ¼ã‚µãƒ¼æ”¹å–„ãƒ¬ãƒãƒ¼ãƒˆ
â”œâ”€â”€ CLAUDE.md                   # AIé–‹ç™ºè€…å‘ã‘ã‚¬ã‚¤ãƒ‰
â”œâ”€â”€ æŒ‡ç¤º.md                     # æ—¥æœ¬èªè¦ä»¶å®šç¾©
â””â”€â”€ README.md                   # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘README
```

---

## ğŸ§© ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è¨­è¨ˆ

### 1. Preparingï¼ˆã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°ï¼‰

**å ´æ‰€**: `keibaai/src/modules/preparing/`

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
preparing/
â”œâ”€â”€ _scrape_html.py          # ãƒ¡ã‚¤ãƒ³ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ‘ãƒ¼ï¼ˆ23KBï¼‰
â”œâ”€â”€ _scrape_jra_odds.py      # JRAã‚ªãƒƒã‚ºå–å¾—ï¼ˆSeleniumï¼‰
â”œâ”€â”€ _requests_utils.py       # HTTPé€šä¿¡ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”œâ”€â”€ _prepare_chrome_driver.py  # Seleniumãƒ‰ãƒ©ã‚¤ãƒãƒ¼è¨­å®š
â””â”€â”€ __init__.py
```

**ä¸»è¦é–¢æ•°**:
```python
# _scrape_html.py
def fetch_html_robust_get(url, session=None) -> bytes:
    """å …ç‰¢ãªHTMLå–å¾—ï¼ˆãƒªãƒˆãƒ©ã‚¤ã€BANå¯¾ç­–ï¼‰"""

def scrape_race_results(race_id_list, output_dir):
    """ãƒ¬ãƒ¼ã‚¹çµæœã®ãƒãƒƒãƒã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°"""

def scrape_horse_data(horse_id_list, output_dir):
    """é¦¬ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°"""
```

**BANå¯¾ç­–æ©Ÿæ§‹**:
- ãƒ©ãƒ³ãƒ€ãƒ User-Agentï¼ˆ3ç¨®é¡ã‚’ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
- 2.5ã€œ5ç§’ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚¹ãƒªãƒ¼ãƒ—
- HTTP 400æ¤œå‡º â†’ 60ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
- æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ãƒªãƒˆãƒ©ã‚¤ï¼ˆæœ€å¤§5å›ï¼‰

---

### 2. Parsersï¼ˆHTMLè§£æï¼‰

**å ´æ‰€**: `keibaai/src/modules/parsers/`

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
parsers/
â”œâ”€â”€ results_parser.py        # ãƒ¬ãƒ¼ã‚¹çµæœãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆ14KBï¼‰
â”œâ”€â”€ shutuba_parser.py        # å‡ºé¦¬è¡¨ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆ14KBï¼‰
â”œâ”€â”€ horse_info_parser.py     # é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«/éå»æˆç¸¾ï¼ˆ16KBï¼‰
â”œâ”€â”€ pedigree_parser.py       # è¡€çµ±ãƒ‘ãƒ¼ã‚µãƒ¼ï¼ˆ9KBï¼‰
â”œâ”€â”€ common_utils.py          # å…±é€šãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â””â”€â”€ __init__.py
```

**results_parser.py ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```python
def parse_results_html(file_path, race_id=None) -> pd.DataFrame:
    # 1. ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼ˆEUC-JP ãƒ‡ã‚³ãƒ¼ãƒ‰ï¼‰
    html_bytes = read_binary_file(file_path)
    html_text = html_bytes.decode('euc_jp', errors='replace')

    # 2. BeautifulSoupã§ãƒ‘ãƒ¼ã‚¹
    soup = BeautifulSoup(html_text, 'html.parser')

    # 3. ãƒ¬ãƒ¼ã‚¹ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºï¼ˆ4æ®µéšãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    race_metadata = extract_race_metadata_enhanced(soup)
    # - distance_m, track_surface, weather, track_condition
    # - venue, day_of_meeting, round_of_year
    # - race_class, age_restriction

    # 4. çµæœãƒ†ãƒ¼ãƒ–ãƒ«æŠ½å‡º
    result_table = soup.find('table', class_='race_table_01')

    # 5. å„è¡Œã‚’ãƒ‘ãƒ¼ã‚¹
    for tr in result_table.find_all('tr'):
        row_data = parse_result_row_enhanced(tr, race_id, ...)
        # - finish_position, bracket_number, horse_number
        # - horse_id, horse_name, sex, age
        # - jockey_id, jockey_name
        # - trainer_id, trainer_name, owner_name
        # - finish_time_seconds, margin_seconds
        # - passing_order_{1,2,3,4}
        # - last_3f_time, win_odds, popularity
        # - horse_weight, horse_weight_change

    # 6. DataFrameåŒ– + æ´¾ç”Ÿç‰¹å¾´é‡
    df = pd.DataFrame(rows)
    df = add_derived_features(df)
    # - pace_index, position_change_*
    # - popularity_finish_diff, relative_odds

    return df
```

**å…±é€šãƒ‘ãƒ¼ã‚¹é–¢æ•°ï¼ˆcommon_utils.pyï¼‰**:
```python
def parse_time_to_seconds(time_str: str) -> float:
    """
    "1:23.4" â†’ 83.4ç§’
    "59.8" â†’ 59.8ç§’
    """

def parse_margin_to_seconds(margin_str: str) -> float:
    """
    "3é¦¬èº«" â†’ 0.6ç§’ï¼ˆ1é¦¬èº« = 0.2ç§’ï¼‰
    "ã‚¯ãƒ“" â†’ 0.02ç§’
    "ãƒãƒŠ" â†’ 0.01ç§’
    """

def parse_sex_age(sex_age_str: str) -> Tuple[str, int]:
    """
    "ç‰¡3" â†’ ("ç‰¡", 3)
    "ç‰4" â†’ ("ç‰", 4)
    """

def parse_horse_weight(weight_str: str) -> Tuple[int, int]:
    """
    "476(+2)" â†’ (476, +2)
    "è¨ˆä¸" â†’ (None, None)
    """
```

---

### 3. Featuresï¼ˆç‰¹å¾´é‡ç”Ÿæˆï¼‰

**å ´æ‰€**: `keibaai/src/modules/features/`

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
features/
â”œâ”€â”€ feature_engine.py        # ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ25KBï¼‰
â””â”€â”€ __init__.py
```

**FeatureEngineã‚¯ãƒ©ã‚¹**:
```python
class FeatureEngine:
    def __init__(self, config: Dict):
        self.config = config
        self.feature_names_ = []

    def generate_features(
        self,
        shutuba_df: pd.DataFrame,
        results_history_df: pd.DataFrame,
        horse_profiles_df: pd.DataFrame,
        pedigree_df: pd.DataFrame
    ) -> pd.DataFrame:
        """
        ç‰¹å¾´é‡ç”Ÿæˆãƒ¡ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼:
        1. ãƒ™ãƒ¼ã‚¹: å‡ºé¦¬è¡¨ãƒ‡ãƒ¼ã‚¿
        2. ãƒãƒ¼ã‚¸: é¦¬ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«
        3. ç”Ÿæˆ: åŸºæœ¬ç‰¹å¾´é‡
        4. é›†ç´„: éå»èµ°æˆç¸¾ï¼ˆç›´è¿‘3/5/10èµ°ï¼‰
        5. è¿½åŠ : è¡€çµ±ç‰¹å¾´é‡
        6. è¿½åŠ : é¨æ‰‹/èª¿æ•™å¸«ç‰¹å¾´é‡
        7. æ­£è¦åŒ–: ãƒ¬ãƒ¼ã‚¹å†…ç›¸å¯¾å€¤
        8. è£œå®Œ: æ¬ æå€¤å‡¦ç†
        """
```

**ç‰¹å¾´é‡ã‚«ãƒ†ã‚´ãƒª**:
```
[1] ãƒ¬ãƒ¼ã‚¹ç‰¹å¾´ï¼ˆRace Featuresï¼‰
    - distance_m, track_surface, weather, track_condition
    - venue, race_class, age_restriction
    - head_count, prize_1st

[2] é¦¬ç‰¹å¾´ï¼ˆHorse Featuresï¼‰
    - age, sex, horse_weight, horse_weight_change
    - avg_finish_last3, avg_finish_last5, avg_finish_last10
    - win_rate_last10, place_rate_last10
    - days_since_last_raceï¼ˆä¼‘é¤ŠæœŸé–“ï¼‰
    - weight_trendï¼ˆä½“é‡æ¨ç§»ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰

[3] é¨æ‰‹ç‰¹å¾´ï¼ˆJockey Featuresï¼‰
    - jockey_win_rate, jockey_place_rate
    - jockey_roiï¼ˆæŠ•è³‡å›åç‡ï¼‰
    - jockey_avg_odds
    - jockey_venue_win_rateï¼ˆç«¶é¦¬å ´åˆ¥æˆç¸¾ï¼‰

[4] èª¿æ•™å¸«ç‰¹å¾´ï¼ˆTrainer Featuresï¼‰
    - trainer_win_rate, trainer_place_rate
    - trainer_roi
    - stable_sizeï¼ˆå©èˆè¦æ¨¡ï¼‰

[5] è¡€çµ±ç‰¹å¾´ï¼ˆPedigree Featuresï¼‰
    - sire_id, dam_id, damsire_idï¼ˆã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰æ¸ˆã¿ï¼‰
    - sire_avg_finishï¼ˆçˆ¶ç³»å¹³å‡ç€é †ï¼‰
    - dam_avg_finishï¼ˆæ¯ç³»å¹³å‡ç€é †ï¼‰

[6] æ´¾ç”Ÿç‰¹å¾´ï¼ˆDerived Featuresï¼‰
    - pace_index = time_except_last3f / last_3f_time
    - position_change_* = passing_order_{i+1} - passing_order_{i}
    - popularity_finish_diff = finish_position - popularity
    - relative_odds = win_odds / ãƒ¬ãƒ¼ã‚¹å¹³å‡ã‚ªãƒƒã‚º
```

---

### 4. Modelsï¼ˆæ©Ÿæ¢°å­¦ç¿’ï¼‰

**å ´æ‰€**: `keibaai/src/modules/models/`

**ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ**:
```
models/
â”œâ”€â”€ model_train.py           # MuEstimatorã‚¯ãƒ©ã‚¹
â”œâ”€â”€ calibration.py           # ç¢ºç‡æ ¡æ­£
â”œâ”€â”€ sigma_estimator.py       # Ïƒãƒ¢ãƒ‡ãƒ«ï¼ˆæœªå®Ÿè£…ï¼‰
â”œâ”€â”€ nu_estimator.py          # Î½ãƒ¢ãƒ‡ãƒ«ï¼ˆæœªå®Ÿè£…ï¼‰
â””â”€â”€ __init__.py
```

**3ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«**:
```python
# Î¼ (mu) - æœŸå¾…å®Œèµ°æ™‚é–“
MuEstimator = LGBMRegressor(
    objective='regression',
    metric='rmse',
    n_estimators=2000,
    learning_rate=0.01,
    num_leaves=31,
    max_depth=-1,
    feature_fraction=0.8,
    bagging_fraction=0.8
)

# Ïƒ (sigma) - é¦¬å›ºæœ‰ã®åˆ†æ•£
SigmaEstimator = LGBMRegressor(
    objective='regression',
    metric='rmse'
)

# Î½ (nu) - ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®è‡ªç”±åº¦
NuEstimator = LGBMRegressor(
    objective='regression',
    metric='mae'
)
```

**ç¢ºç‡æ ¡æ­£**:
```python
from sklearn.calibration import CalibratedClassifierCV

# Temperature Scaling
calibrator = CalibratedClassifierCV(
    base_estimator=model,
    method='isotonic',  # or 'sigmoid'
    cv=5
)
```

---

### 5. Simï¼ˆã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

**å ´æ‰€**: `keibaai/src/modules/sim/`

**ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ **:
```python
import scipy.stats as stats

class RaceSimulator:
    def simulate(self, mu_array, sigma_array, nu, K=1000):
        """
        ãƒ¢ãƒ³ãƒ†ã‚«ãƒ«ãƒ­ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

        Args:
            mu_array: å„é¦¬ã®æœŸå¾…å®Œèµ°æ™‚é–“ [N]
            sigma_array: å„é¦¬ã®æ¨™æº–åå·® [N]
            nu: ãƒ¬ãƒ¼ã‚¹å…¨ä½“ã®è‡ªç”±åº¦
            K: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å›æ•°

        Returns:
            win_probs: å„é¦¬ã®å‹ç‡ [N]
        """
        N = len(mu_array)
        win_counts = np.zeros(N)

        for k in range(K):
            # å„é¦¬ã®å®Œèµ°æ™‚é–“ã‚’tåˆ†å¸ƒã‹ã‚‰ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
            finish_times = np.array([
                stats.t.rvs(df=nu, loc=mu_i, scale=sigma_i)
                for mu_i, sigma_i in zip(mu_array, sigma_array)
            ])

            # ç€é †ã‚’æ±ºå®š
            finish_order = np.argsort(finish_times)
            winner_idx = finish_order[0]
            win_counts[winner_idx] += 1

        win_probs = win_counts / K
        return win_probs
```

---

### 6. Optimizerï¼ˆãƒãƒ¼ãƒˆãƒ•ã‚©ãƒªã‚ªæœ€é©åŒ–ï¼‰

**å ´æ‰€**: `keibaai/src/modules/optimizer/`

**KellyåŸºæº–å®Ÿè£…**:
```python
from scipy.optimize import minimize

class PortfolioOptimizer:
    def optimize_kelly(
        self,
        win_probs: np.ndarray,
        odds: np.ndarray,
        capital: float,
        kelly_fraction: float = 0.25
    ) -> np.ndarray:
        """
        Fractional Kelly Criterion

        ç›®çš„é–¢æ•°:
            maximize Î£ f_i * log(1 + (o_i - 1) * f_i / W_0)

        åˆ¶ç´„:
            Î£ f_i â‰¤ W_0
            f_i â‰¥ 0
            EV_i = p_i * o_i - 1 > threshold
        """
        N = len(win_probs)

        # ç›®çš„é–¢æ•°ï¼ˆè² ã«ã—ã¦æœ€å°åŒ–å•é¡Œã«å¤‰æ›ï¼‰
        def objective(f):
            return -np.sum(
                f * np.log(1 + (odds - 1) * f / capital)
            )

        # åˆ¶ç´„æ¡ä»¶
        constraints = [
            {'type': 'ineq', 'fun': lambda f: capital - np.sum(f)},  # è³‡æœ¬åˆ¶ç´„
            *[{'type': 'ineq', 'fun': lambda f, i=i: f[i]}  # éè² åˆ¶ç´„
              for i in range(N)]
        ]

        # æœŸå¾…å€¤ãƒ•ã‚£ãƒ«ã‚¿
        ev = win_probs * odds - 1
        initial_guess = np.where(ev > 0.05, capital * 0.05, 0)

        # æœ€é©åŒ–å®Ÿè¡Œ
        result = minimize(
            objective,
            initial_guess,
            constraints=constraints,
            method='SLSQP'
        )

        # Kelly fractionã§ãƒªã‚¹ã‚¯èª¿æ•´
        optimal_bets = result.x * kelly_fraction

        return optimal_bets
```

---

## ğŸŒŠ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è©³ç´°

### Phase 0 â†’ 1: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚° â†’ ãƒ‘ãƒ¼ã‚¹

```
netkeiba.com
    â†“ requests.get()
[HTML bytes (EUC-JP)]
    â†“ save as .bin
data/raw/html/race/202310010811.bin
    â†“ decode('euc_jp')
[HTML text]
    â†“ BeautifulSoup('html.parser')
[DOM tree]
    â†“ find('table', class_='race_table_01')
[DataFrameã®è¡Œãƒªã‚¹ãƒˆ]
    â†“ pd.DataFrame()
[races.parquet]
    â†“ to_parquet(engine='pyarrow')
data/parsed/parquet/races/races.parquet
```

### Phase 1 â†’ 2: ãƒ‘ãƒ¼ã‚¹ â†’ ç‰¹å¾´é‡

```
[races.parquet, shutuba.parquet, horses.parquet, pedigrees.parquet]
    â†“ pd.read_parquet()
[4ã¤ã®DataFrame]
    â†“ FeatureEngine.generate_features()
[ç‰¹å¾´é‡DataFrameï¼ˆ200+åˆ—ï¼‰]
    â†“ ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ§ãƒ³æ›¸ãè¾¼ã¿
data/features/parquet/year=2023/month=10/features.parquet
```

### Phase 2 â†’ 3: ç‰¹å¾´é‡ â†’ ãƒ¢ãƒ‡ãƒ«

```
[features.parquet (å…¨æœŸé–“)]
    â†“ TimeSeriesSplit (5-fold)
[train_df, valid_df, test_df]
    â†“ LightGBM.train()
[mu_model.txt, sigma_model.txt, nu_model.txt]
    â†“ CalibratedClassifierCV.fit()
[calibrator.pkl]
    â†“ save to disk
data/models/20231015_lgbm/
```

### Phase 3 â†’ 4: ãƒ¢ãƒ‡ãƒ« â†’ äºˆæ¸¬

```
[ä»Šæ—¥ã®å‡ºé¦¬è¡¨ï¼ˆç‰¹å¾´é‡ä»˜ãï¼‰]
    â†“ model.predict()
[Î¼, Ïƒ, Î½ predictions]
    â†“ save as parquet
data/predictions/parquet/20231015_predictions.parquet
```

### Phase 4 â†’ 5: äºˆæ¸¬ â†’ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

```
[Î¼, Ïƒ, Î½ arrays]
    â†“ RaceSimulator.simulate(K=1000)
[win_probs, place_probs, show_probs]
    â†“ save as JSON
data/simulations/202310010811.json
```

### Phase 5 â†’ 6: ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ â†’ æœ€é©åŒ–

```
[win_probs] + [JRA odds (Selenium)]
    â†“ PortfolioOptimizer.optimize_kelly()
[optimal_bet_amounts]
    â†“ filter by EV > threshold
[recommended_bets]
    â†“ save as JSON
data/orders/202310010811_order.json
```

---

## ğŸ”— ä¾å­˜é–¢ä¿‚

### ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«é–“ä¾å­˜

```
Preparing
    â†’ Parsers

Parsers
    â†’ Features

Features
    â†’ Models
    â†’ Sim

Models
    â†’ Sim

Sim
    â†’ Optimizer

Optimizer
    â†’ Executor (DISABLED)

Monitoring
    â† Models, Sim, Optimizer
```

### å¤–éƒ¨ä¾å­˜

- **netkeiba.com**: ãƒ¬ãƒ¼ã‚¹çµæœãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- **JRAå…¬å¼ã‚µã‚¤ãƒˆ**: ã‚ªãƒƒã‚ºãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹
- **ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶š**: ã‚¹ã‚¯ãƒ¬ã‚¤ãƒ”ãƒ³ã‚°æ™‚ã®ã¿å¿…è¦
- **ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: æœ€ä½20GBæ¨å¥¨

---

## ğŸ¨ è¨­è¨ˆåŸå‰‡

### 1. ç–çµåˆï¼ˆLoose Couplingï¼‰

å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯Parquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä»‹ã—ã¦é€šä¿¡ï¼š
```python
# âŒ å¯†çµåˆ
parser_result = parse_html(html)
features = generate_features(parser_result)

# âœ… ç–çµåˆ
parse_html(html, output_path='races.parquet')
features = generate_features(input_path='races.parquet')
```

### 2. å˜ä¸€è²¬ä»»åŸå‰‡ï¼ˆSRPï¼‰

å„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯1ã¤ã®è²¬å‹™ã®ã¿ï¼š
- Preparing = ãƒ‡ãƒ¼ã‚¿å–å¾—
- Parsers = ãƒ‡ãƒ¼ã‚¿æ§‹é€ åŒ–
- Features = ç‰¹å¾´é‡ç”Ÿæˆ
- Models = ãƒ¢ãƒ‡ãƒ«è¨“ç·´

### 3. å‹å®‰å…¨æ€§

Pandas nullable integersã®ä½¿ç”¨ï¼š
```python
# âŒ float64ã§æ•´æ•°è¡¨ç¾ï¼ˆæ¬ æå€¤å¯¾å¿œã ãŒãƒ¡ãƒ¢ãƒªç„¡é§„ï¼‰
df['finish_position'] = df['finish_position'].astype('float64')

# âœ… nullable integer
df['finish_position'] = df['finish_position'].astype('Int64')
```

### 4. å†ªç­‰æ€§ï¼ˆIdempotenceï¼‰

åŒã˜å…¥åŠ›ã«å¯¾ã—ã¦ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚åŒã˜çµæœï¼š
```python
# ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã¯ä½•åº¦å®Ÿè¡Œã—ã¦ã‚‚åŒã˜Parquetãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
parse_results_html('202310010811.bin')  # â†’ races.parquet
```

### 5. ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£

å…¨ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒunit testå¯èƒ½ï¼š
```python
# tests/unit/test_parsers.py
def test_parse_time_to_seconds():
    assert parse_time_to_seconds("1:23.4") == 83.4
    assert parse_time_to_seconds("59.8") == 59.8
```

---

## ğŸš€ æ‹¡å¼µæ€§

### æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã®è¿½åŠ 

```python
# keibaai/src/modules/preparing/scrape_jbis.py (ä¾‹)
def scrape_jbis_pedigree(horse_id):
    """JBIS (Japan Bloodstock Information System) ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—"""
    pass
```

### æ–°ã—ã„ç‰¹å¾´é‡ã®è¿½åŠ 

```python
# keibaai/src/modules/features/advanced_features.py
class AdvancedFeatureEngine:
    def generate_pace_features(self, df):
        """ãƒšãƒ¼ã‚¹ç‰¹å¾´é‡ã®ç”Ÿæˆ"""
        pass

    def generate_jockey_trainer_synergy(self, df):
        """é¨æ‰‹Ã—èª¿æ•™å¸«ã®ç›¸æ€§ç‰¹å¾´é‡"""
        pass
```

### æ–°ã—ã„ãƒ¢ãƒ‡ãƒ«ã®è¿½åŠ 

```python
# keibaai/src/modules/models/ensemble_model.py
class EnsembleModel:
    def __init__(self):
        self.models = [
            LGBMRanker(),
            XGBRanker(),
            CatBoostRanker()
        ]
```

---

**æ¬¡ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: [03_ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«.md](./03_ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«.md)
