# シミュレーション問題の根本原因と解決策

**調査日時**: 2025-11-22  
**問題**: シミュレーション結果でhorse_numberが全て'0'

---

## 🔍 根本原因の特定

### 調査の流れ

1. **シミュレーション結果**: 全72レースでhorse_numberが'0'、win_probsが1.0
2. **シミュレータコード**: 正常（`simulator.py`は正しく実装されている）
3. **入力データ**: `predictions_2024_full.parquet`のhorse_numberが**全て0**

### 確認された事実

```python
# predictions_2024_full.parquet
Unique horse_numbers in dataset: [0]  # ← 問題！
```

**結論**: シミュレータは正常に動作しているが、入力データ自体が不正。

---

## 💡 解決策の選択肢

### Option A: mu_predictions.parquetを使用（推奨しない）

`mu_predictions.parquet`は:
- ✅ horse_numberが正常（1-18の範囲）
- ❌ sigma, nuカラムがない → シミュレーション不可

### Option B: 2024年データで予測を再生成（推奨しない）

- sigma, nuモデルの学習が必要
- 時間がかかる

### Option C: Claudeレポートの確認（現状把握）

Claudeのレポートでは:
- μ予測: 185,251行（2020-2023年の訓練データ）
- σ/νモデル: 訓練済み
- **2024年データへの適用**: レポートに明示的な記載なし

### Option D: 正しい方法でテストデータを準備（推奨）

1. 2020-2023年の特徴量データから1日分を選ぶ
2. そのデータに対してμ, σ, νの予測を実行
3. シミュレーション実行

---

## 🎯 推奨アクション

**短期**: 2020-2023年の既存予測データを使用
- `mu_predictions.parquet`にはsigma/nuがないが、訓練データの一部には存在する可能性
- または、訓練期間の最後の日(2023-12-31)でテスト

**中期**: 2024年データで完全なパイプラインを実行
1. 2024年の特徴量生成（既存か確認）
2. μ, σ, νの予測実行
3. シミュレーション
4. ポートフォリオ最適化
5. バックテスト

---

## 📋 次のステップ

### ユーザーへの質問

以下のどちらを希望されますか？

**1. 簡易テスト（推奨）**
   - 2020-2023年のデータの一部でシミュレーションをテスト
   - horse_numberが正常なデータを使用
   - シミュレータの動作確認が目的

**2. 完全なバックテスト**
   - 2024年データで予測から実行
   - 時間はかかるが、本番に近い環境でテスト
   - 完全なパフォーマンス評価が可能

**3. 問題調査を継続**
   - predictions_2024_full.parquetがどのように作成されたかを調査
   - Claudeの作業履歴を確認

---

**推奨**: オプション1（簡易テスト）でシミュレータの動作確認後、オプション2（完全バックテスト）に進む
