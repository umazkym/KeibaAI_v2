# KeibaAI 戦略ガイドライン & 運用マニュアル

## 1. 基本哲学：回収率至上主義

本プロジェクトの究極の目標は「的中率（Accuracy）」ではなく「回収率（ROI）」の最大化です。
特に単勝回収率において、控除率（約20%）の壁を超え、安定的かつ高いリターンを目指します。

### 1.1. 「当てる」から「儲ける」へ
多くの競馬ファンや一般的なAIは「どの馬が勝つか（的中率）」を追求します。しかし、全員が勝つと思う馬（1番人気）はオッズが低くなり、長期的には控除率分だけ負けることになります（回収率約80%への収束）。

**我々の戦略**:
- **大衆のバイアスを利用する**: 人間は「人気馬を過大評価」し、「不人気馬を過小評価」する傾向があります。この「歪み」をAIで見つけ出します。
- **的中率を犠牲にする勇気**: 高回収率の戦略は、必然的に的中率が下がります（穴馬を狙うため）。「外れること」を許容し、トータルの期待値で勝利を目指します。
- **試行回数の確保**: 確率的優位性（エッジ）があっても、試行回数が少ないと運の要素に左右されます。年間を通じて数千レース単位で投資し、大数の法則を味方につけます。

### 1.2. 狙うべき「歪み」
1.  **過小評価された実力馬**: 近走の着順が悪いが、不利（出遅れ、壁、トラックバイアス）があった馬。
2.  **過剰人気馬の消し**: 新聞の印や騎手人気で実力以上に買われている馬を回避する。
3.  **条件替わり**: 芝→ダート、距離短縮、休み明けなど、人間が評価しづらい変数をAIで定量化する。

---

## 2. AI × LLM 協調開発プロセス

LLM（AIアシスタント）は、運用時の買い目決定者ではなく、**モデル開発・改善における「壁打ち相手」兼「分析パートナー」**として位置づけます。

### 2.1. LLMの役割：開発サイクルの中核
| フェーズ | LLMの具体的な活用方法 |
| :--- | :--- |
| **仮説生成** | 「なぜ夏競馬で回収率が下がるのか？」「ダート短距離で荒れる要因は？」といった問いに対し、競馬のドメイン知識とデータ分析の視点から仮説を提案させる。 |
| **特徴量設計** | 仮説に基づき、「前走の上がり3ハロンと今回の距離短縮幅の組み合わせ」など、具体的な特徴量エンジニアリングのアイデアを出させる。 |
| **結果解釈** | モデルが外したレースや、逆に大穴を当てたレースのデータをLLMに渡し、「モデルが何を見て判断したか」を解釈させる。これにより、モデルのバイアスや欠点を発見する。 |
| **コード実装** | 提案された特徴量や分析コードを即座に実装し、検証サイクルを高速化する。 |

### 2.2. 人間とLLMの対話ループ
1.  **Human**: 「回収率は上がったが、的中率が低すぎて精神的にきつい。バランスを取るには？」
2.  **LLM**: 「的中率重視のモデル（μモデル単体）と、回収率重視のモデル（統合モデル）をアンサンブルする案があります。または、オッズの閾値を調整して...」
3.  **Human**: 「アンサンブルを試したい。実装案を出して。」
4.  **LLM**: (実装コードを提示) -> **検証実行**

---

## 3. 具体的な戦略（単勝ベース）

まずはシンプルかつ強力な単勝戦略で基盤を作ります。

### 3.1. 期待値フィルタリング
$$ \text{期待値 (EV)} = \text{AI予測勝率} \times \text{単勝オッズ} $$

- **基本ルール**: EV > 1.0（損益分岐点）の馬のみを検討対象とする。
- **推奨ルール**: EV > 1.2 〜 1.5 の馬を「推奨馬」とする。

### 3.2. 不確実性（σ/ν）の活用
- **σ（モデルの迷い）**: σが大きい場合、AIも自信がない（データ不足、初出走など）。→ **見送り**推奨。
- **ν（レースの荒れ度）**: νが大きいレースは波乱含み。→ **穴狙い**のチャンス。

---

## 4. UI/UX 要件（モデル検証・理解のために）

UI（Streamlitダッシュボード）は、運用ツールではなく、**「人間がモデルの挙動を深く理解し、改善点を見つけるための検証ツール」**として設計します。

### 4.1. 目的：ブラックボックスの透明化
AIモデルが出した「数値」だけを見ても、人間は納得できませんし、改善のアイデアも浮かびません。
UIを通じて「なぜその予測になったのか」を可視化し、次の改善につなげます。

### 4.2. 必須機能
1.  **予測根拠の可視化 (Feature Importance)**
    - その馬の予測スコアに寄与したトップ5の特徴量を表示（例：「前走着順: 2位 (+0.15)」「騎手: ルメール (+0.08)」）。
    - SHAP値などを用いて、プラス要因とマイナス要因を色分け表示。

2.  **成功/失敗パターンの分析**
    - 「高期待値だったのに負けた馬」と「低評価だったのに勝った馬」をリストアップ。
    - 共通する特徴（例：「雨の日のダートで負けやすい」）をフィルタリングして発見できる機能。

3.  **シミュレーション結果の詳細表示**
    - 単なる勝率だけでなく、勝率分布（ヒストグラム）や、荒れ度（ν）のヒートマップを表示。
    - 「もしオッズがこう変動したらEVはどう変わるか」の感度分析。

### 4.3. LLMとの連携インターフェース
- ダッシュボード上に分析結果のテキストエリアを設け、LLMが生成した「レース回顧レポート」や「モデル改善提案」を表示できるようにする（※運用時のリアルタイム生成ではなく、検証バッチ処理の結果として表示）。

---

## 5. 今後のロードマップ

1.  **UI実装**: 上記要件を満たすダッシュボードの構築。
2.  **LLM統合**: 特徴量重要度（SHAP値など）をLLMに渡し、解説文を生成させるパイプラインの構築。
3.  **実弾運用テスト**: 少額での運用を開始し、心理的な負荷と実際の回収率を確認。
